<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة المخزون والفواتير</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Print Invoice Modal Styles */
        #print-invoice-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
            z-index: 1100;
            overflow-y: auto;
        }
        
        #print-invoice-modal.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }
        
        #print-invoice-modal .modal {
            background: white;
            border-radius: 8px;
            box-shadow: 0 5px 30px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        #print-invoice-modal .modal-header {
            padding: 15px 20px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        #print-invoice-modal .modal-header h3 {
            margin: 0;
            font-size: 1.3rem;
        }
        
        #print-invoice-modal .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }
        
        #print-invoice-modal .modal-footer {
            padding: 15px 20px;
            background: #f8f9fa;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-start;
            gap: 10px;
        }
        
        #print-invoice-modal .close-btn {
            background: none;
            border: none;
            color: var(--primary);
            font-size: 1.2rem;
            cursor: pointer;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }
        
        #print-invoice-modal .close-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        /* Print-specific styles */
        @media print {
            #print-invoice-modal .modal {
                box-shadow: none;
                max-width: 100%;
                max-height: none;
            }
            
            .no-print {
                display: none !important;
            }
        }
        
        :root {
            --primary: #2c3e50;
            --primary-dark: #1a252f;
            --secondary: #3498db;
            --secondary-light: #5dade2;
            --success: #27ae60;
            --success-light: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --gray: #95a5a6;
            --light-gray: #bdc3c7;
            --border: #dfe6e9;
            --card-bg: #ffffff;
            --body-bg: #f8f9fa;
            --sidebar-bg: #2c3e50;
            --sidebar-hover: #34495e;
            --text-dark: #2d3436;
            --text-light: #636e72;
            --transition: all 0.3s ease;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Tajawal', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--body-bg);
            color: var(--text-dark);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .app-container {
            display: flex;
            min-height: 100vh;
        }
        
        /* Sidebar Styles */
        .sidebar {
            width: 260px;
            background: linear-gradient(180deg, var(--primary), var(--primary-dark));
            color: white;
            transition: var(--transition);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }
        
        .sidebar-menu {
            padding: 20px 0;
        }
        
        .menu-item {
            display: flex;
            align-items: center;
            padding: 15px 25px;
            cursor: pointer;
            transition: var(--transition);
            border-left: 4px solid transparent;
        }
        
        .menu-item:hover, .menu-item.active {
            background: var(--sidebar-hover);
            border-left: 4px solid var(--secondary-light);
        }
        
        .menu-item i {
            width: 30px;
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.8);
        }
        
        .menu-item span {
            font-size: 1rem;
            font-weight: 500;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            width: 100%;
            max-width: 100%;
            overflow: hidden;
        }
        
        .topbar {
            background: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            z-index: 100;
        }
        
        .search-container {
            position: relative;
            width: 350px;
        }
        
        .search-container input {
            width: 100%;
            padding: 10px 15px 10px 40px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--body-bg);
            transition: var(--transition);
        }
        
        .search-container input:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        .search-container i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--secondary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .notification-icon {
            position: relative;
            font-size: 1.2rem;
            color: var(--text-light);
        }
        
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger);
            color: white;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Content Area */
        .content-area {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            max-width: 100%;
            width: 100%;
            box-sizing: border-box;
            margin: 0;
            min-width: 0;
        }
        
        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .content-header h2 {
            font-size: 1.8rem;
            color: var(--primary);
            font-weight: 700;
        }
        
        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
            overflow: hidden;
        }
        
        .card-header {
            padding: 20px 25px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-header h3 {
            font-size: 1.4rem;
            color: var(--primary);
            font-weight: 600;
        }
        
        .card-body {
            padding: 0;
            overflow-x: auto;
        }
        
        /* Tables */
        .table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        
        .table th {
            background: var(--light);
            color: var(--primary);
            font-weight: 600;
            text-align: right;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
        }
        
        .table td {
            padding: 36px 20px;
            border-bottom: 1px solid var(--border);
            color: var(--text-dark);
        }
        
        .table tr:last-child td {
            border-bottom: none;
        }
        
        .table tr:hover {
            background: rgba(52, 152, 219, 0.03);
        }
        
        /* Buttons */
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-size: 1rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--secondary), var(--secondary-light));
            color: white;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(52, 152, 219, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success), var(--success-light));
            color: white;
            box-shadow: 0 4px 12px rgba(46, 204, 113, 0.3);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #fc5c65);
            color: white;
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--warning), #fed330);
            color: white;
            box-shadow: 0 4px 12px rgba(243, 156, 18, 0.3);
        }
        
        .btn-outline {
            background: transparent;
            border: 2px solid var(--secondary);
            color: var(--secondary);
        }
        
        .btn-sm {
            padding: 8px 15px;
            font-size: 0.9rem;
        }
        
        .btn-icon {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            transition: var(--transition);
            margin: 0 2px;
        }
        
        .btn-edit {
            background-color: #e3f2fd;
            color: #1976d2;
        }
        
        .btn-edit:hover {
            background-color: #bbdefb;
        }
        
        .btn-delete {
            background-color: #ffebee;
            color: #d32f2f;
        }
        
        .btn-delete:hover {
            background-color: #ffcdd2;
        }
        
        .action-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 35px;
            height: 35px;
            border-radius: 8px;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-light);
            cursor: pointer;
            transition: var(--transition);
            margin: 0 2px;
            font-size: 14px;
        }
        
        .action-btn:hover {
            background: rgba(52, 152, 219, 0.1);
            color: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .action-btn.edit {
            color: var(--success);
            border-color: rgba(46, 204, 113, 0.3);
        }
        
        .action-btn.edit:hover {
            background: rgba(46, 204, 113, 0.1);
            color: var(--success);
            border-color: var(--success);
        }
        
        .action-btn.delete {
            color: var(--danger);
            border-color: rgba(231, 76, 60, 0.3);
        }
        
        /* Customer History Modal Styles */
        .invoices-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .invoice-card {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            overflow: visible; /* Changed from hidden to prevent cutting off content */
            border: 1px solid #e0e0e0;
        }
        
        .invoice-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .invoice-date {
            display: flex;
            align-items: center;
            gap: 6px;
            color: #555;
            font-weight: 500;
        }
        
        .invoice-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .invoice-items {
            padding: 12px 16px;
        }
        
        .invoice-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
        }
        
        .invoice-item:last-child {
            border-bottom: none;
        }
        
        .invoice-footer {
            padding: 12px 16px;
            background-color: #f8f9fa;
            border-top: 1px solid #e0e0e0;
            text-align: left;
            font-weight: 600;
        }
        
        .invoice-total {
            color: var(--primary);
        }
        
        .action-btn.delete:hover {
            background: rgba(231, 76, 60, 0.1);
            color: var(--danger);
            border-color: var(--danger);
        }
        
        /* Icons */
        /* Base icon styles */
        i.fas, i.far, i.fab, i.fa {
            font-size: 1em;
            line-height: 1;
            vertical-align: middle;
            transition: var(--transition);
        }
        
        /* Icons in buttons */
        .btn i {
            margin-left: 6px;
            font-size: 0.95em;
        }
        
        /* Icons in action buttons */
        .action-btn i {
            font-size: 1.1em;
            transition: inherit;
        }
        
        /* Icons in sidebar menu */
        .menu-item i {
            width: 24px;
            text-align: center;
            margin-left: 8px;
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .menu-item:hover i, 
        .menu-item.active i {
            opacity: 1;
            color: var(--secondary-light);
        }
        
        /* Icons in cards and summaries */
        .summary-icon i {
            font-size: 1.8em;
            opacity: 0.9;
        }
        
        /* Modal close icons */
        .close-btn i {
            font-size: 1.2rem;
            transition: var(--transition);
        }
        
        .close-btn:hover i {
            transform: rotate(90deg);
        }
        
        /* Status Badges */
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            display: inline-block;
        }
        
        .status-success { background: #eafaf1; color: var(--success); }
        .status-warning { background: #fef9e7; color: var(--warning); }
        .status-danger { background: #fceae8; color: var(--danger); }
        .status-available { background-color: #d4edda; color: #155724; }
        .status-unavailable { background-color: #f8d7da; color: #721c24; }
        
        /* Dashboard Summary */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        
        .summary-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            gap: 20px;
            transition: transform 0.3s ease;
        }
        
        .summary-card:hover {
            transform: translateY(-5px);
        }
        
        .summary-icon {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
        }
        
        .card-1 .summary-icon { background: rgba(52, 152, 219, 0.1); color: var(--secondary); }
        .card-2 .summary-icon { background: rgba(46, 204, 113, 0.1); color: var(--success); }
        .card-3 .summary-icon { background: rgba(231, 76, 60, 0.1); color: var(--danger); }
        .card-4 .summary-icon { background: rgba(243, 156, 18, 0.1); color: var(--warning); }
        
        .summary-info h3 {
            font-size: 1.1rem;
            color: var(--text-light);
            margin-bottom: 5px;
        }
        
        .summary-info .value {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .summary-info .sub-value {
            font-size: 1rem;
            color: var(--success);
            margin-top: 5px;
        }
        
        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 25px 0;
            gap: 8px;
            flex-wrap: wrap;
            padding: 15px 0;
            direction: rtl;
            width: 100%;
        }
        
        .pagination button, .pagination .pagination-btn {
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            background: #fff;
            color: #333;
            border-radius: 6px;
            cursor: pointer;
            transition: var(--transition);
            font-size: 14px;
            min-width: 36px;
            height: 36px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-family: inherit;
            line-height: 1;
            margin: 2px;
        }
        
        .pagination .pagination-ellipsis {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 24px;
            height: 36px;
            color: #666;
            user-select: none;
            padding: 0 8px;
        }
        
        .pagination button:hover:not(.active):not(:disabled),
        .pagination .pagination-btn:hover:not(.active):not(:disabled) {
            background-color: #f5f5f5;
            border-color: #d0d0d0;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .pagination button.active, .pagination .pagination-btn.active {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
            font-weight: 600;
        }
        
        .pagination button:disabled,
        .pagination .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* Filter Section */
        .filter-section {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
        }
        
        .filter-group label {
            font-weight: 500;
            color: var(--text-dark);
            white-space: nowrap;
        }
        
        .filter-select {
            padding: 8px 32px 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background-color: white;
            font-size: 0.9rem;
            color: var(--text-dark);
            cursor: pointer;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%232c3e50' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 16px;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            min-width: 150px;
        }
        
        .filter-select:focus {
            border-color: var(--secondary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .filter-select:hover {
            border-color: var(--secondary-light);
        }
        
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--danger);
        }
        
        .close-alert {
            background: none;
            border: none;
            font-size: 1.2rem;
            color: inherit;
            cursor: pointer;
        }
        
        /* Invoice Items */
        .invoice-item {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: flex-end;
        }
        
        .invoice-item > div {
            flex: 1;
        }
        
        .invoice-items-container {
            margin: 20px 0;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
        }
        
        .invoice-summary {
            background: var(--light);
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
        }
        
        .summary-total {
            font-weight: bold;
            font-size: 1.2rem;
            border-top: 2px solid var(--border);
            margin-top: 10px;
            padding-top: 10px;
        }
        
        /* Stock Indicators */
        .low-stock { color: var(--danger); font-weight: bold; }
        .no-stock { color: var(--gray); text-decoration: line-through; }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
        }
        
        .empty-state i {
            font-size: 48px;
            color: #e0e0e0;
            margin-bottom: 15px;
        }
        
        .empty-state h3 {
            color: #6c757d;
            margin-bottom: 10px;
        }
        
        .empty-state p {
            color: #adb5bd;
            margin: 0;
        }
        
        /* Form Controls */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-dark);
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            transition: var(--transition);
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }
        
        /* Print Invoice Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow-y: auto;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        /* Print button styles */
        .print-invoice-btn, .btn-print {
            color: #2c3e50;
            padding: 5px 12px;
            border-radius: 4px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            line-height: 1.5;
            text-decoration: none;
        }
        
        .print-invoice-btn:hover, .btn-print:hover {
            background: #e9ecef;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-decoration: none;
        }
        
        .print-invoice-btn i, .btn-print i {
            margin-left: 6px;
        }
        
        .btn-print {
            margin: 5px;
        }
        
        .modal {
            background: white;
            border-radius: 8px;
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            transform: translateY(-20px);
            transition: transform 0.3s ease, opacity 0.3s ease;
            opacity: 0;
        }
        
        .modal-overlay.active .modal {
            transform: translateY(0);
            opacity: 1;
        }
        
        .modal-body {
            padding: 25px;
            overflow-y: auto;
            flex: 1;
            -webkit-overflow-scrolling: touch;
            max-height: calc(90vh - 170px); /* Adjust based on header/footer height */
            position: relative;
            z-index: 1;
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            font-size: 1.5rem;
            color: var(--primary);
        }
        
        .modal-header .close-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: var(--text-light);
        }
        
        .modal-header .close-btn:hover {
            background: var(--light);
        }
        
        .modal-body {
            padding: 25px;
        }
        
        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }
        
        /* Confirmation Dialog */
        .confirmation-dialog {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            text-align: center;
        }
        
        .confirmation-dialog h3 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: var(--primary);
        }
        
        .confirmation-dialog p {
            margin-bottom: 25px;
            color: var(--text-light);
            line-height: 1.6;
        }
        
        .confirmation-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        
        /* Responsive Design */
        @media (max-width: 1200px) {
            .sidebar {
                width: 80px;
                overflow: visible;
            }
            
            .menu-item {
                justify-content: center;
                padding: 15px;
                position: relative;
            }
            
            .menu-item i {
                width: auto;
                font-size: 1.3rem;
            }
        }
        
        @media (max-width: 992px) {
            .content-area {
                padding: 20px;
            }
            
            .summary-cards {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .search-container {
                width: 250px;
            }
            
            .content-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .form-row {
                flex-direction: column;
                gap: 15px;
            }
            
            .invoice-item {
                flex-direction: column;
                align-items: stretch;
            }
        }
        
        /* Search Box Hover & Focus Styles */
        .search-input:focus {
            border-color: #3b82f6 !important;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2) !important;
            background-color: #fff !important;
        }
        
        .search-input:hover {
            border-color: #9ca3af;
            background-color: #fff !important;
        }
        
        @media (max-width: 768px) {
            .content-area {
                padding: 15px;
            }
            
            .summary-cards {
                grid-template-columns: 1fr;
            }
            
            .search-container {
                width: 200px;
            }
            
            .topbar {
                padding: 10px 15px;
            }
            
            .app-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                overflow-x: auto;
                scrollbar-width: none;
            }
            
            .sidebar::-webkit-scrollbar {
                display: none;
            }
            
            .sidebar-menu {
                display: flex;
                width: max-content;
                min-width: 100%;
                padding: 0;
                margin: 0;
            }
            
            .menu-item {
                padding: 15px 20px;
                white-space: nowrap;
                border: none;
                border-bottom: 3px solid transparent;
                flex-shrink: 0;
                display: flex !important;
                align-items: center;
                justify-content: center;
            }
            
            .menu-item:hover, .menu-item.active {
                background: var(--sidebar-hover);
                border-bottom-color: var(--secondary-light);
            }
            
            .menu-item i {
                margin: 0 5px;
                font-size: 1.4rem;
                min-width: 24px;
                text-align: center;
            }
            
            .table th, .table td {
                padding: 8px 5px;
                font-size: 0.9rem;
                min-width: 100px;
            }
            
            .table td:first-child,
            .table th:first-child {
                padding-right: 15px;
            }
            
            .table td:last-child,
            .table th:last-child {
                padding-left: 15px;
            }
        }
        
        /* Animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease forwards;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-menu">
                <div class="menu-item active" data-page="dashboard-page">
                    <i class="fas fa-home"></i>
                    <span>الرئيسية</span>
                </div>
                <div class="menu-item" data-page="products-page">
                    <i class="fas fa-box-open"></i>
                    <span>إدارة المنتجات</span>
                </div>
                <div class="menu-item" data-page="invoices-page">
                    <i class="fas fa-file-invoice-dollar"></i>
                    <span>الفواتير</span>
                </div>
                <div class="menu-item" data-page="customers-page">
                    <i class="fas fa-users"></i>
                    <span>العملاء</span>
                </div>
                <div class="menu-item" data-page="suppliers-page">
                    <i class="fas fa-truck"></i>
                    <span>الموردين</span>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <div class="content-area">
                <!-- Dashboard Page -->
                <div id="dashboard-page">
                    <div class="content-header">
                        <h2>لوحة التحكم</h2>
                        <div>
                            <button class="btn btn-primary" id="add-invoice-btn">
                                <i class="fas fa-plus"></i> إضافة فاتورة جديدة
                            </button>
                        </div>
                    </div>
                    
                    <!-- Summary Cards -->
                    <div class="summary-cards">
                        <div class="summary-card card-1 fade-in">
                            <div class="summary-icon">
                                <i class="fas fa-boxes"></i>
                            </div>
                            <div class="summary-info">
                                <h3>إجمالي المنتجات</h3>
                                <div class="value" id="total-products">0</div>
                                <div class="sub-value" id="products-change">+0 هذا الشهر</div>
                            </div>
                        </div>
                        
                        <div class="summary-card card-2 fade-in">
                            <div class="summary-icon">
                                <i class="fas fa-file-invoice-dollar"></i>
                            </div>
                            <div class="summary-info">
                                <h3>الفواتير هذا الشهر</h3>
                                <div class="value" id="monthly-invoices">0</div>
                                <div class="sub-value" id="invoices-change">+0 عن الشهر الماضي</div>
                            </div>
                        </div>
                        
                        <div class="summary-card card-3 fade-in">
                            <div class="summary-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="summary-info">
                                <h3>منتجات منخفضة</h3>
                                <div class="value" id="low-stock-count">0</div>
                                <div class="sub-value">تحتاج للتزويد</div>
                            </div>
                        </div>
                        
                        <div class="summary-card card-4 fade-in">
                            <div class="summary-icon">
                                <i class="fas fa-money-bill-wave"></i>
                            </div>
                            <div class="summary-info">
                                <h3>قيمة المخزون</h3>
                                <div class="value" id="inventory-value">0 ج.م</div>
                                <div class="sub-value" id="inventory-change">+0% عن الشهر الماضي</div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Invoices -->
                    <div class="card fade-in">
                        <div class="card-header">
                            <h3>آخر الفواتير</h3>
                        </div>
                        <div class="card-body">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>العميل</th>
                                        <th>التاريخ</th>
                                        <th>المبلغ</th>
                                        <th>الحالة</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="recent-invoices-table-body">
                                    <!-- Will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                          
                    <!-- Latest Products -->
                    <div class="card fade-in">
                        <div class="card-header">
                            <h3>أحدث المنتجات</h3>
                        </div>
                        <div class="card-body">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>اسم المنتج</th>
                                        <th>السعر (ج.م)</th>
                                        <th>الكمية</th>
                                        <th>الحالة</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="latest-products-table-body">
                                    <!-- Will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                </div>
                
                <!-- Products Management Page -->
                <div id="products-page" style="display: none;">
                    <div class="content-header">
                        <h2>إدارة المنتجات</h2>
                        <div>
                            <button class="btn btn-primary" id="add-product-btn" style="margin-left: 10px;">
                                <i class="fas fa-plus"></i> إضافة كمية
                            </button>
                            <button class="btn btn-outline" id="add-product-name-btn">
                                <i class="fas fa-plus"></i> إضافة اسم منتج فقط
                            </button>
                        </div>
                    </div>
                    
                    <div class="filter-section">
                        <div class="search-container" style="width: 300px;">
                            <i class="fas fa-search"></i>
                            <input type="text" id="product-search" placeholder="ابحث عن منتج...">
                        </div>
                        
                        <div class="filter-group">
                            <label for="status-filter">حالة المخزون:</label>
                            <select id="status-filter" class="filter-select">
                                <option value="all">جميع الحالات</option>
                                <option value="available">متوفر</option>
                                <option value="low">كمية منخفضة</option>
                                <option value="out">منتهي</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table" id="products-table">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>اسم المنتج</th>
                                            <th>السعر</th>
                                            <th>الكمية</th>
                                            <th>الحالة</th>
                                            <th>الإجراءات</th>
                                        </tr>
                                    </thead>
                                    <tbody id="products-table-body">
                                        <!-- Will be populated by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="pagination" id="products-pagination">
                                <!-- Pagination will be added here by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Invoices Management Page -->
                <div id="invoices-page" style="display: none;">
                    <div class="content-header">
                        <h2>إدارة الفواتير</h2>
                        <div>
                            <button class="btn btn-primary" id="add-invoice-btn">
                                <i class="fas fa-plus"></i> إضافة فاتورة جديدة
                            </button>
                        </div>
                    </div>
                    
                    <div class="filter-section">
                        <div class="search-container" style="width: 300px;">
                            <i class="fas fa-search"></i>
                            <input type="text" id="invoice-search" placeholder="ابحث عن فاتورة...">
                        </div>
                        
                        <div class="filter-group">
                            <label for="status-invoice-filter">حالة الفاتورة:</label>
                            <select id="status-invoice-filter" class="filter-select">
                                <option value="all">جميع الحالات</option>
                                <option value="paid">مدفوعة</option>
                                <option value="unpaid">غير مدفوعة</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table" id="invoices-table">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>العميل</th>
                                            <th>التاريخ</th>
                                            <th>المبلغ</th>
                                            <th>الحالة</th>
                                            <th>الإجراءات</th>
                                        </tr>
                                    </thead>
                                    <tbody id="invoices-table-body">
                                        <!-- Will be populated by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="pagination" id="invoices-pagination">
                                <!-- Pagination will be added here by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Reports Page -->
                <div id="reports-page" style="display: none;">
                    <div class="content-header">
                        <h2>التقارير</h2>
                        <div>
                            <button class="btn btn-outline">
                                <i class="fas fa-file-export"></i> تصدير
                            </button>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <div class="empty-state">
                                <i class="fas fa-chart-bar"></i>
                                <h3>لوحة التقارير</h3>
                                <p>سيتم إضافة التقارير والتحليلات هنا قريباً</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Customers Page -->
                <div id="customers-page" style="display: none;">
                    <div class="content-header" style="align-items: center;">
                        <h2 style="margin: 0;">إدارة العملاء</h2>
                        <div style="display: flex; gap: 15px; align-items: center;">
                            <div class="search-box" style="position: relative; margin: 0;">
                                <i class="fas fa-search" style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #6c757d;"></i>
                                <input type="text" id="customer-search" class="search-input" placeholder="ابحث عن عميل..." 
                                    style="padding: 10px 40px 10px 15px; border: 1px solid #e0e0e0; border-radius: 8px; 
                                    width: 300px; font-size: 14px; transition: all 0.3s ease;
                                    background-color: #f8f9fa; outline: none;
                                    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
                                    height: 42px;
                                    border-color: #d1d5db;">
                            </div>
                            <button class="btn btn-primary" id="add-customer-btn" 
                                style="white-space: nowrap; padding: 10px 20px; font-weight: 500;">
                                <i class="fas fa-plus"></i> إضافة عميل جديد
                            </button>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>الاسم</th>
                                            <th>رقم الهاتف</th>
                                            <th>المديونية</th>
                                            <th>الإجراءات</th>
                                        </tr>
                                    </thead>
                                    <tbody id="customers-table-body">
                                        <!-- Customers will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="pagination" id="customers-pagination">
                                <!-- Pagination will be added here by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Suppliers Page -->
                <div id="suppliers-page" style="display: none;">
                    <div class="content-header" style="align-items: center;">
                        <h2 style="margin: 0;">إدارة الموردين</h2>
                        <div style="display: flex; gap: 15px; align-items: center;">
                            <div class="search-box" style="position: relative; margin: 0;">
                                <i class="fas fa-search" style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #6c757d;"></i>
                                <input type="text" id="supplier-search" class="search-input" placeholder="ابحث عن مورد..." 
                                    style="padding: 10px 40px 10px 15px; border: 1px solid #e0e0e0; border-radius: 8px; 
                                    width: 300px; font-size: 14px; transition: all 0.3s ease;
                                    background-color: #f8f9fa; outline: none;
                                    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
                                    height: 42px;
                                    border-color: #d1d5db;">
                            </div>
                            <button class="btn btn-primary" id="add-supplier-btn" 
                                style="white-space: nowrap; padding: 10px 20px; font-weight: 500;">
                                <i class="fas fa-plus"></i> إضافة مورد جديد
                            </button>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>اسم المورد</th>
                                            <th>رقم الهاتف</th>
                                            <th>الإجراءات</th>
                                        </tr>
                                    </thead>
                                    <tbody id="suppliers-table-body">
                                        <!-- Suppliers will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="pagination" id="suppliers-pagination">
                                <!-- Pagination will be added here by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Reports Page Removed -->
            </div>
        </div>
    </div>

    <!-- Product Modal -->
    <div class="modal-overlay" id="product-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="product-modal-title">إضافة كمية</h3>
                <button class="close-btn" id="close-product-modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="product-form">
                    <input type="hidden" id="product-id">
                    
                    <!-- Product Name Section -->
                    <div class="form-group">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <label for="product-name">اسم المنتج *</label>
                            <button type="button" id="toggle-product-input" class="btn btn-sm btn-link" style="padding: 0;">
                                <i class="fas fa-exchange-alt"></i> <span id="toggle-text">إضافة منتج جديد</span>
                            </button>
                        </div>
                        
                        <!-- Product Select (initially hidden) -->
                        <div id="product-select-container" style="display: none;">
                            <select id="product-name" class="form-control">
                                <option value="">-- اختر المنتج --</option>
                                <!-- Products will be populated by JavaScript -->
                            </select>
                        </div>
                        
                        <!-- Product Name Input (initially shown) -->
                        <div id="product-name-input-container" style="margin-top: 10px;">
                            <input type="text" id="product-name-input" class="form-control" placeholder="اكتب اسم المنتج الجديد هنا" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="product-balance">السعر (ج.م) *</label>
                            <input type="number" id="product-balance" class="form-control" min="0" step="0.01" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="product-quantity">الكمية *</label>
                            <input type="number" id="product-quantity" class="form-control" min="1" value="1" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="product-supplier">المورد</label>
                        <select id="product-supplier" class="form-control">
                            <option value="">-- اختر المورد --</option>
                            <!-- Suppliers will be populated by JavaScript -->
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" id="cancel-product-modal">إلغاء</button>
                  <button type="button" class="btn btn-success" id="save-product">
                    <i class="fas fa-save"></i> حفظ المنتج
                </button>
            </div>
        </div>
    </div>
    
    <!-- Customer Modal -->
    <div class="modal-overlay" id="customer-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="customer-modal-title">إضافة عميل جديد</h3>
                <button class="close-btn" id="close-customer-modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="customer-form">
                    <input type="hidden" id="customer-id">
                    <div class="form-group">
                        <label for="customer-name">اسم العميل *</label>
                        <input type="text" id="customer-name" name="name" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="customer-phone">رقم الهاتف *</label>
                        <input type="tel" id="customer-phone" name="phone" class="form-control" dir="ltr" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancel-customer-modal">إلغاء</button>
                <button type="button" class="btn btn-success" id="save-customer">حفظ العميل</button>
            </div>
        </div>
    </div>
    
    <!-- Supplier Modal -->
    <div class="modal-overlay" id="supplier-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="supplier-modal-title">إضافة مورد جديد</h3>
                <button class="close-btn" id="close-supplier-modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="supplier-form">
                    <input type="hidden" id="supplier-id">
                    <div class="form-group">
                        <label for="supplier-name">اسم المورد *</label>
                        <input type="text" id="supplier-name" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="supplier-phone">رقم الهاتف *</label>
                        <input type="tel" id="supplier-phone" class="form-control" required>
                    </div>
                    
                    <!-- Supplier Items History -->
                    <div class="form-group" id="supplier-items-container" style="display: none; margin-top: 20px;">
                        <label>سجل المشتريات من المورد</label>
                        <div class="table-responsive">
                            <table class="data-table" style="width: 100%;">
                                <thead>
                                    <tr>
                                        <th>اسم المنتج</th>
                                        <th>التاريخ</th>
                                        <th>الكمية</th>
                                        <th>السعر</th>
                                        <th>الإجمالي</th>
                                    </tr>
                                </thead>
                                <tbody id="supplier-items-body">
                                    <!-- Items will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancel-supplier-modal">إلغاء</button>
                <button type="button" class="btn btn-success" id="save-supplier">حفظ المورد</button>
            </div>
        </div>
    </div>

    <!-- Invoice Modal -->
    <div class="modal-overlay" id="invoice-modal">
        <div class="modal" style="max-width: 800px;">
            <div class="modal-header">
                <h3 id="invoice-modal-title">فاتورة جديدة</h3>
                <button class="close-btn" id="close-invoice-modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="invoice-form">
                    <input type="hidden" id="invoice-id">
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="invoice-customer">العميل *</label>
                            <select id="invoice-customer" class="form-control" required>
                                <option value="">اختر عميلاً</option>
                                <!-- Clients will be populated by JavaScript -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="invoice-status">حالة الدفع</label>
                            <select id="invoice-status" class="form-control" required>
                                <option value="paid">مدفوعة</option>
                                <option value="unpaid" selected>غير مدفوعة</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="invoice-date">تاريخ الفاتورة *</label>
                            <input type="date" id="invoice-date" class="form-control" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h4 class="m-0">بنود الفاتورة</h4>
                            <button type="button" class="btn btn-outline-primary btn-sm" id="add-invoice-item">
                                <i class="fas fa-plus ml-1"></i>
                                <span>إضافة بند</span>
                            </button>
                        </div>
                        <style>
                            .invoice-items-container {
                                width: 100%;
                                overflow: hidden;
                                border: 1px solid #dee2e6;
                                border-radius: 8px;
                            }
                            .invoice-items-header {
                                width: 100%;
                                table-layout: fixed;
                                border-collapse: collapse;
                                background-color: #f8f9fa;
                            }
                            .invoice-items-header th {
                                padding: 12px 15px;
                                font-weight: 600;
                                color: #2c3e50;
                                border-bottom: 2px solid #dee2e6;
                                white-space: nowrap;
                                overflow: hidden;
                                text-overflow: ellipsis;
                            }
                            .invoice-table-wrapper {
                                max-height: 300px;
                                overflow-y: auto;
                                width: 100%;
                            }
                            .invoice-items-table {
                                width: 100%;
                                table-layout: fixed;
                                border-collapse: collapse;
                            }
                            .col-product { width: calc(100% - 300px); }
                            .col-quantity { width: 100px; }
                            .col-total { width: 100px; }
                            .col-delete { width: 100px; }
                        </style>
                        <div class="invoice-items-container">
                            <table class="invoice-items-header">
                                <colgroup>
                                    <col class="col-product">
                                    <col class="col-quantity">
                                    <col class="col-total">
                                    <col class="col-delete">
                                </colgroup>
                                <thead>
                                    <tr>
                                        <th style="text-align: right;">المنتج</th>
                                        <th style="text-align: center;">الكمية</th>
                                        <th style="text-align: left;">الإجمالي</th>
                                        <th style="text-align: center;">حذف</th>
                                    </tr>
                                </thead>
                            </table>
                            <div class="invoice-table-wrapper">
                                <table class="invoice-items-table" id="invoice-items-table">
                                    <colgroup>
                                        <col class="col-product">
                                        <col class="col-quantity">
                                        <col class="col-total">
                                        <col class="col-delete">
                                    </colgroup>
                                    <tbody id="invoice-items-body">
                                        <!-- Invoice items will be added here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Invoice Summary -->
                    <div class="invoice-summary mt-3">
                        <div class="summary-row summary-total">
                            <span>الإجمالي:</span>
                            <span id="invoice-total">0.00 ج.م</span>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer d-flex justify-content-between align-items-center">
                <button type="button" class="btn btn-outline-secondary" id="cancel-invoice-modal">
                    <i class="fas fa-times ml-1"></i> إلغاء
                </button>
                <div class="d-flex">
                    <button type="button" class="btn btn-success" id="save-invoice">
                        <i class="fas fa-save ml-1"></i> حفظ الفاتورة
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="delete-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>تأكيد الحذف</h3>
                <button class="close-btn" id="close-delete-modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <p id="delete-message">هل أنت متأكد أنك تريد حذف هذا العنصر؟ لا يمكن التراجع عن هذا الإجراء.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancel-delete-modal">إلغاء</button>
                <button class="btn btn-danger" id="confirm-delete">حذف</button>
            </div>
        </div>
    </div>

    </style>
    
    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="delete-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>تأكيد الحذف</h3>
                <button class="close-btn" id="close-delete-modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <p id="delete-message">هل أنت متأكد أنك تريد حذف هذا العنصر؟ لا يمكن التراجع عن هذا الإجراء.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancel-delete-modal">إلغاء</button>
                <button class="btn btn-danger" id="confirm-delete">حذف</button>
            </div>
        </div>
    </div>

    <!-- Add Chart.js library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Main Application Class
        class InventorySystem {
            constructor() {
                // Initialize properties
                this.products = [];
                this.invoices = [];
                this.customers = [];
                this.suppliers = [];
                this.currentPage = {
                    products: 1,
                    invoices: 1,
                    customers: 1,
                    suppliers: 1
                };
                this.itemsPerPage = 10;
                
                // Store filter states
                this.filterStates = {
                    products: {
                        searchTerm: '',
                        statusFilter: 'all'
                    },
                    invoices: {
                        searchTerm: '',
                        statusFilter: 'all'
                    },
                    suppliers: {
                        searchTerm: ''
                    }
                };
                this.currentDeleteId = null;
                this.currentDeleteType = null;
                this.filteredProducts = []; // Store filtered products for pagination
                
                // Initialize search inputs and filter selects
                this.searchInputs = {
                    products: null,
                    invoices: null,
                    customers: null,
                    suppliers: null
                };
                
                this.filterSelects = {
                    products: null,
                    invoices: null,
                    status: null
                };
                
                this.initElements();
                this.loadData();
                this.setupEventListeners();
                this.showPage('dashboard-page');
                this.updateDashboard();
            }
            
            initElements() {
                // Pages
                this.pages = {
                    dashboard: document.getElementById('dashboard-page'),
                    products: document.getElementById('products-page'),
                    invoices: document.getElementById('invoices-page'),
                    reports: document.getElementById('reports-page'),
                    customers: document.getElementById('customers-page'),
                    suppliers: document.getElementById('suppliers-page')
                };
                
                // Menu items
                this.menuItems = document.querySelectorAll('.menu-item');
                
                // Tables
                this.tables = {
                    latestProducts: document.getElementById('latest-products-table-body'),
                    recentInvoices: document.getElementById('recent-invoices-table-body'),
                    products: document.getElementById('products-table-body'),
                    invoices: document.getElementById('invoices-table-body'),
                    customers: document.getElementById('customers-table-body'),
                    suppliers: document.getElementById('suppliers-table-body'),
                    invoiceItems: document.getElementById('invoice-items-body')
                };
                
                // Pagination
                this.pagination = {
                    products: document.getElementById('products-pagination'),
                    invoices: document.getElementById('invoices-pagination'),
                    customers: document.getElementById('customers-pagination'),
                    suppliers: document.getElementById('suppliers-pagination')
                };
                
                // Search and filter inputs
                this.searchInputs.products = document.getElementById('product-search');
                this.searchInputs.invoices = document.getElementById('invoice-search');
                this.searchInputs.suppliers = document.getElementById('supplier-search');
                
                this.filterSelects.products = document.getElementById('status-filter');
                this.filterSelects.invoices = document.getElementById('status-invoice-filter');
                
                // Buttons
                this.buttons = {
                    addProduct: document.getElementById('add-product-btn'),
                    // We'll handle the addInvoice buttons separately in the event listeners
                    addCustomer: document.getElementById('add-customer-btn'),
                    addSupplier: document.getElementById('add-supplier-btn'),
                    addInvoiceItem: document.getElementById('add-invoice-item'),
                    saveProduct: document.getElementById('save-product'),
                    saveInvoice: document.getElementById('save-invoice'),
                    printInvoice: document.getElementById('print-invoice'),
                    saveCustomer: document.getElementById('save-customer'),
                    saveSupplier: document.getElementById('save-supplier'),
                    cancelDelete: document.getElementById('cancel-delete-modal'),
                    confirmDelete: document.getElementById('confirm-delete'),
                    cancelCustomer: document.getElementById('cancel-customer-modal'),
                    cancelSupplier: document.getElementById('cancel-supplier-modal')
                };
                
                // Modals
                this.modals = {
                    product: document.getElementById('product-modal'),
                    customer: document.getElementById('customer-modal'),
                    supplier: document.getElementById('supplier-modal'),
                    invoice: document.getElementById('invoice-modal'),
                    delete: document.getElementById('delete-modal')
                };
                
                // Modal close buttons
                this.modalCloseButtons = {
                    product: document.getElementById('close-product-modal'),
                    customer: document.getElementById('close-customer-modal'),
                    delete: document.getElementById('close-delete-modal'),
                    invoice: document.getElementById('close-invoice-modal'),
                    delete: document.getElementById('close-delete-modal'),
                    cancelProduct: document.getElementById('cancel-product-modal'),
                    cancelCustomer: document.getElementById('cancel-customer-modal'),
                    cancelInvoice: document.getElementById('cancel-invoice-modal')
                };
                
                // Forms
                this.forms = {
                    product: document.getElementById('product-form'),
                    customer: document.getElementById('customer-form'),
                    invoice: document.getElementById('invoice-form')
                };
                
                // Form fields
                this.formFields = {
                    product: {
                        id: document.getElementById('product-id'),
                        name: document.getElementById('product-name'),
                        balance: document.getElementById('product-balance'),
                        quantity: document.getElementById('product-quantity'),
                        description: document.getElementById('product-description')
                    },
                    customer: {
                        id: document.getElementById('customer-id'),
                        name: document.getElementById('customer-name'),
                        phone: document.getElementById('customer-phone'),
                        balance: document.getElementById('customer-balance'),
                        date: document.getElementById('customer-date')
                    },
                    supplier: {
                        id: document.getElementById('supplier-id'),
                        name: document.getElementById('supplier-name'),
                        phone: document.getElementById('supplier-phone')
                    },
                    invoice: {
                        id: document.getElementById('invoice-id'),
                        customer: document.getElementById('invoice-customer'),
                        date: document.getElementById('invoice-date')
                    }
                };
                
                // Dashboard elements
                this.dashboardElements = {
                    totalProducts: document.getElementById('total-products'),
                    productsChange: document.getElementById('products-change'),
                    monthlyInvoices: document.getElementById('monthly-invoices'),
                    invoicesChange: document.getElementById('invoices-change'),
                    lowStockCount: document.getElementById('low-stock-count'),
                    inventoryValue: document.getElementById('inventory-value'),
                    inventoryChange: document.getElementById('inventory-change'),
                    invoiceSubtotal: document.getElementById('invoice-subtotal'),
                    invoiceTax: document.getElementById('invoice-tax'),
                    invoiceTotal: document.getElementById('invoice-total')
                };
            }
            
            loadData() {
                // Data schema version for future migrations
                const SCHEMA_VERSION = '1.1';
                
                // Default data structures with sample data
                const defaultData = {
                    products: window.allProducts || [],
                    invoices: window.sampleInvoices || [],
                    customers: window.sampleCustomers || [],
                    suppliers: window.sampleSuppliers || [],
                    _meta: { 
                        version: SCHEMA_VERSION, 
                        lastUpdated: new Date().toISOString(),
                        app: 'Bill-System'
                    }
                };
                
                try {
                    // Try to load data from localStorage with better error handling
                    const loadFromStorage = (key, fallback = []) => {
                        try {
                            const item = localStorage.getItem(key);
                            if (!item) return Array.isArray(fallback) ? [...fallback] : { ...fallback };
                            
                            const parsed = JSON.parse(item);
                            
                            // If we have an array but it's empty, return the fallback
                            if (Array.isArray(parsed) && parsed.length === 0) {
                                return Array.isArray(fallback) ? [...fallback] : { ...fallback };
                            }
                            
                            return parsed || (Array.isArray(fallback) ? [...fallback] : { ...fallback });
                        } catch (error) {
                            console.error(`Error parsing ${key}:`, error);
                            return Array.isArray(fallback) ? [...fallback] : { ...fallback };
                        }
                    };
                    
                    // Check for existing data version for migration
                    const meta = JSON.parse(localStorage.getItem('_meta') || '{}');
                    
                    // Load each data type with validation
                    this.products = this.validateProducts(loadFromStorage('products', defaultData.products));
                    this.invoices = this.validateInvoices(loadFromStorage('invoices', defaultData.invoices));
                    this.customers = this.validateCustomers(loadFromStorage('customers', defaultData.customers));
                    this.suppliers = this.validateSuppliers(loadFromStorage('suppliers', defaultData.suppliers));
                    
                    // Ensure we have at least the default data
                    if (this.products.length === 0 && defaultData.products.length > 0) {
                        this.products = [...defaultData.products];
                    }
                    if (this.invoices.length === 0 && defaultData.invoices.length > 0) {
                        this.invoices = [...defaultData.invoices];
                    }
                    if (this.customers.length === 0 && defaultData.customers.length > 0) {
                        this.customers = [...defaultData.customers];
                    }
                    if (this.suppliers.length === 0 && defaultData.suppliers.length > 0) {
                        this.suppliers = [...defaultData.suppliers];
                    }
                    
                    // Save the validated data back to ensure consistency
                    this.saveData();
                    
                } catch (error) {
                    console.error('Critical error loading data:', error);
                    // Fall back to default data structures
                    this.products = [...defaultData.products];
                    this.invoices = [...defaultData.invoices];
                    this.customers = [...defaultData.customers];
                    this.suppliers = [...defaultData.suppliers];
                    this.saveData();
                }
                
                console.log('Data loaded:', {
                    products: this.products.length,
                    invoices: this.invoices.length,
                    customers: this.customers.length,
                    suppliers: this.suppliers.length
                });
                
                // Initialize any missing data structures
                if (!this.products) this.products = [];
                if (!this.invoices) this.invoices = [];
                if (!this.customers) this.customers = [];
                if (!this.suppliers) this.suppliers = [];
            }
            
            // Data validation helpers with better default values and error handling
            validateProducts(products) {
                if (!Array.isArray(products)) return [];
                
                return products.map(p => ({
                    id: p.id || `prod_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    name: p.name || 'منتج غير معروف',
                    balance: !isNaN(parseFloat(p.balance)) ? parseFloat(p.balance) : 0,
                    quantity: !isNaN(parseInt(p.quantity)) ? parseInt(p.quantity) : 0,
                    description: p.description || '',
                    price: !isNaN(parseFloat(p.price)) ? parseFloat(p.price) : 0,
                    category: p.category || 'عام',
                    createdAt: p.createdAt || new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    ...p // Keep any additional properties
                })).filter(p => p && p.name); // Only filter out completely invalid entries
            }
            
            validateInvoices(invoices) {
                if (!Array.isArray(invoices)) return [];
                
                return invoices.map(i => ({
                    id: i.id || `inv_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    date: i.date || new Date().toISOString(),
                    customerId: i.customerId || null,
                    customerName: i.customer,
                    items: Array.isArray(i.items) ? i.items.map(item => ({
                        productId: item.productId || '',
                        name: item.name || 'منتج غير معروف',
                        quantity: Math.max(1, parseInt(item.quantity) || 1),
                        price: Math.max(0, parseFloat(item.price) || 0),
                        total: Math.max(0, parseFloat(item.total) || 0)
                    })) : [],
                    subtotal: Math.max(0, parseFloat(i.subtotal) || 0),
                    total: Math.max(0, parseFloat(i.total) || 0),
                    status: ['pending', 'paid', 'cancelled'].includes(i.status) ? i.status : 'pending',
                    createdAt: i.createdAt || new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    ...i // Keep any additional properties
                }));
            }
            
            validateCustomers(customers) {
                if (!Array.isArray(customers)) return [];
                
                return customers.map(c => ({
                    id: c.id || `cust_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    name: c.name || 'عميل',
                    phone: c.phone || '',
                    balance: !isNaN(parseFloat(c.balance)) ? parseFloat(c.balance) : 0,
                    createdAt: c.createdAt || new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    ...c // Keep any additional properties
                }));
            }
            
            validateSuppliers(suppliers) {
                if (!Array.isArray(suppliers)) return [];
                
                return suppliers.map(s => ({
                    id: s.id || `supp_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    name: s.name || 'مورد بدون اسم',
                    phone: s.phone || '',
                    balance: !isNaN(parseFloat(s.balance)) ? parseFloat(s.balance) : 0,
                    createdAt: s.createdAt || new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    ...s // Keep any additional properties
                }));
            }
            
            saveData() {
                try {
                    // Only save if data has changed (simple optimization)
                    const saveIfChanged = (key, data) => {
                        try {
                            const current = localStorage.getItem(key);
                            const serialized = JSON.stringify(data);
                            
                            // Always save if no current data or if data has changed
                            if (!current || current !== serialized) {
                                localStorage.setItem(key, serialized);
                                console.log(`Saved ${key} (${serialized.length} bytes)`);
                            }
                        } catch (error) {
                            console.error(`Error saving ${key}:`, error);
                            // Try to save with a different key to prevent data loss
                            try {
                                const backupKey = `backup_${Date.now()}_${key}`;
                                localStorage.setItem(backupKey, JSON.stringify(data));
                                console.warn(`Saved backup data to ${backupKey}`);
                            } catch (e) {
                                console.error('Backup save also failed:', e);
                            }
                        }
                    };
                    
                    // Save each data type with error handling
                    saveIfChanged('products', this.products);
                    saveIfChanged('invoices', this.invoices);
                    saveIfChanged('customers', this.customers);
                    saveIfChanged('suppliers', this.suppliers);
                    
                    // Save metadata with version info
                    const meta = {
                        version: '1.1',
                        lastSaved: new Date().toISOString(),
                        app: 'Bill-System',
                        dataStats: {
                            products: this.products.length,
                            invoices: this.invoices.length,
                            customers: this.customers.length,
                            suppliers: this.suppliers.length
                        }
                    };
                    
                    try {
                        localStorage.setItem('_meta', JSON.stringify(meta));
                    } catch (e) {
                        console.error('Error saving metadata:', e);
                    }
                    
                    return true;
                } catch (error) {
                    console.error('Error in saveData:', error);
                    this.showAlert('حدث خطأ أثناء حفظ البيانات', 'error');
                    return false;
                }
            }
            
            setupEventListeners() {
                // Menu navigation
                this.menuItems.forEach(item => {
                    item.addEventListener('click', () => {
                        const page = item.dataset.page;
                        if (page) {
                            this.showPage(page);
                            window.location.hash = page;
                        }
                    });
                });
                
                // Handle hash changes
                window.addEventListener('hashchange', () => {
                    const page = window.location.hash.substring(1) || 'dashboard-page';
                    this.showPage(page);
                });
                
                // Add buttons
                this.buttons.addProduct.addEventListener('click', () => this.openProductModal());
                
                // Add product name only button
                const addProductNameBtn = document.getElementById('add-product-name-btn');
                if (addProductNameBtn) {
                    addProductNameBtn.addEventListener('click', () => {
                        // Reset the form and open in add mode
                        this.resetForm('product');
                        this.openModal('product');
                        
                        // Get form elements
                        const productSelect = document.getElementById('product-name');
                        const productInput = document.getElementById('product-name-input');
                        const productInputContainer = document.getElementById('product-name-input-container');
                        const productSelectContainer = document.getElementById('product-select-container');
                        
                        if (productInput && productInputContainer && productSelect && productSelectContainer) {
                            // Show input, hide select
                            productSelectContainer.style.display = 'none';
                            productInputContainer.style.display = 'block';
                            
                            // Update toggle button text
                            const toggleText = document.getElementById('toggle-text');
                            if (toggleText) {
                                toggleText.textContent = 'اختيار من القائمة';
                            }
                            
                            // Update required attributes
                            productSelect.required = false;
                            productInput.required = true;
                            
                            // Hide quantity and supplier fields, but show price
                            const quantityField = document.getElementById('product-quantity')?.closest('.form-group');
                            const supplierField = document.getElementById('product-supplier')?.closest('.form-group');
                            const priceField = document.getElementById('product-balance')?.closest('.form-group');
                            
                            if (quantityField) quantityField.style.display = 'none';
                            if (supplierField) supplierField.style.display = 'none';
                            if (priceField) priceField.style.display = 'block';
                            
                            // Focus the input field
                            productInput.focus();
                        }
                        
                        // Set the modal title
                        const titleElement = document.getElementById('product-modal-title');
                        if (titleElement) {
                            titleElement.textContent = 'إضافة اسم منتج جديد';
                        }
                        
                        // Focus on the product name field
                        if (productInput) {
                            productInput.focus();
                        }
                    });
                }
                
                this.buttons.addCustomer.addEventListener('click', () => this.openCustomerModal());
                this.buttons.addSupplier.addEventListener('click', () => this.openSupplierModal());
                this.buttons.addInvoiceItem.addEventListener('click', () => this.addInvoiceItem());
                
                // Function to handle invoice button click
                function handleInvoiceButtonClick(e) {
                    e.preventDefault();
                    console.log('Add invoice button clicked');
                    this.openModal('invoice');
                }
                
                // Add click event to all buttons that contain "إضافة فاتورة" text
                const allButtons = document.getElementsByTagName('button');
                Array.from(allButtons).forEach(button => {
                    if (button.textContent.includes('إضافة فاتورة')) {
                        console.log('Found invoice button:', button);
                        button.addEventListener('click', handleInvoiceButtonClick.bind(this));
                    }
                });
                
                // Save buttons
                if (this.buttons.saveProduct) this.buttons.saveProduct.addEventListener('click', () => this.saveProduct());
                if (this.buttons.saveInvoice) this.buttons.saveInvoice.addEventListener('click', () => this.saveInvoice());
                if (this.buttons.saveCustomer) this.buttons.saveCustomer.addEventListener('click', () => this.saveCustomer());
                if (this.buttons.saveSupplier) this.buttons.saveSupplier.addEventListener('click', () => this.saveSupplier());
                
                // Cancel buttons
                if (this.buttons.cancelCustomer) this.buttons.cancelCustomer.addEventListener('click', () => this.closeModal('customer'));
                if (this.buttons.cancelSupplier) this.buttons.cancelSupplier.addEventListener('click', () => this.closeModal('supplier'));
                
                // Delete confirmation
                if (this.buttons.cancelDelete) this.buttons.cancelDelete.addEventListener('click', () => this.closeModal('delete'));
                if (this.buttons.confirmDelete) this.buttons.confirmDelete.addEventListener('click', () => this.confirmDelete());
                
                // Modal close buttons
                if (this.modalCloseButtons.product) this.modalCloseButtons.product.addEventListener('click', () => this.closeModal('product'));
                if (this.modalCloseButtons.customer) this.modalCloseButtons.customer.addEventListener('click', () => this.closeModal('customer'));
                if (this.modalCloseButtons.supplier) this.modalCloseButtons.supplier.addEventListener('click', () => this.closeModal('supplier'));
                if (this.modalCloseButtons.invoice) this.modalCloseButtons.invoice.addEventListener('click', () => this.closeModal('invoice'));
                if (this.modalCloseButtons.delete) this.modalCloseButtons.delete.addEventListener('click', () => this.closeModal('delete'));
                if (this.modalCloseButtons.cancelProduct) this.modalCloseButtons.cancelProduct.addEventListener('click', () => this.closeModal('product'));
                if (this.modalCloseButtons.cancelCustomer) this.modalCloseButtons.cancelCustomer.addEventListener('click', () => this.closeModal('customer'));
                if (this.modalCloseButtons.cancelSupplier) this.modalCloseButtons.cancelSupplier.addEventListener('click', () => this.closeModal('supplier'));
                if (this.modalCloseButtons.cancelInvoice) this.modalCloseButtons.cancelInvoice.addEventListener('click', () => this.closeModal('invoice'));
                
                // Close modals when clicking outside
                Object.values(this.modals).forEach(modal => {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            this.closeModal(modal.id.replace('-modal', ''));
                        }
                    });
                });
                
                // Search and filter events
                if (this.searchInputs.products) {
                    this.searchInputs.products.addEventListener('input', () => this.filterProducts());
                }
                if (this.searchInputs.invoices) {
                    this.searchInputs.invoices.addEventListener('input', () => this.filterInvoices());
                }
                if (this.searchInputs.suppliers) {
                    this.searchInputs.suppliers.addEventListener('input', () => this.filterSuppliers());
                }
                if (this.filterSelects.products) {
                    this.filterSelects.products.addEventListener('change', () => this.filterProducts());
                }
                if (this.filterSelects.invoices) {
                    this.filterSelects.invoices.addEventListener('change', () => this.filterInvoices());
                }
                
                // Initialize print buttons
                if (this.buttons.printInvoice) {
                    this.buttons.printInvoice.addEventListener('click', () => this.printInvoice());
                }
                
                // Add event delegation for dynamically added print buttons
                document.addEventListener('click', (e) => {
                    // Handle print buttons in invoices table
                    if (e.target.closest('.print-invoice-btn')) {
                        e.preventDefault();
                        const invoiceId = e.target.closest('.print-invoice-btn').dataset.invoiceId;
                        if (invoiceId) {
                            this.printInvoice(invoiceId);
                        }
                    }
                    
                    // Handle print buttons in customer history modal
                    if (e.target.closest('.print-invoice-history-btn')) {
                        e.preventDefault();
                        const invoiceData = JSON.parse(e.target.closest('.print-invoice-history-btn').dataset.invoice);
                        if (invoiceData) {
                            this.printInvoice(invoiceData);
                        }
                    }
                });
            }
            
            showPage(pageId) {
                console.log('Showing page:', pageId);
                // Hide all pages
                Object.values(this.pages).forEach(page => {
                    if (page) page.style.display = 'none';
                });
                
                // Show the requested page
                const pageKey = pageId.replace('-page', '');
                if (this.pages[pageKey]) {
                    this.pages[pageKey].style.display = 'block';
                }
                
                // Update active menu item
                this.menuItems.forEach(item => {
                    item.classList.remove('active');
                    if (item.dataset.page === pageId) {
                        item.classList.add('active');
                    }
                });
                
                // Update content based on the page
                switch(pageId) {
                    case 'products-page':
                        // Reset to first page when navigating to products page
                        this.currentPage.products = 1;
                        this.filterProducts(); // This will render the table with current filters
                        break;
                    case 'invoices-page':
                        this.renderInvoicesTable();
                        // Set up search and filter events
                        const invoiceSearch = document.getElementById('invoice-search');
                        const statusFilter = document.getElementById('status-invoice-filter');
                        
                        if (invoiceSearch) {
                            invoiceSearch.addEventListener('input', () => this.filterInvoices());
                        }
                        if (statusFilter) {
                            statusFilter.addEventListener('change', () => this.filterInvoices());
                        }
                        break;
                    case 'customers-page':
                        this.renderCustomersTable();
                        break;
                    case 'suppliers-page':
                        console.log('Rendering suppliers table...');
                        this.renderSuppliersTable();
                        break;
                    case 'reports-page':
                        console.log('Initializing reports page...');
                        // Make sure the reports page is visible
                        const reportsPage = document.getElementById('reports-page');
                        if (reportsPage) {
                            reportsPage.style.display = 'block';
                            // Call the updateReportsPage function if it exists
                            if (typeof window.updateReportsPage === 'function') {
                                window.updateReportsPage();
                            } else {
                                console.error('updateReportsPage function not found');
                            }
                        }
                        break;
                    case 'dashboard-page':
                        this.updateDashboard();
                        break;
                }
            }
            
            openModal(modalType, id = null) {
                this.resetForm(modalType);
                
                // Don't try to set title for delete modal as it's handled differently
                if (modalType !== 'delete') {
                    if (id) {
                        // Editing existing item
                        const item = this[`get${modalType.charAt(0).toUpperCase() + modalType.slice(1)}`](id);
                        if (item) {
                            this.fillForm(modalType, item);
                            const titleElement = document.getElementById(`${modalType}-modal-title`);
                            if (titleElement) {
                                titleElement.textContent = `تعديل ${modalType === 'product' ? 'منتج' : modalType === 'customer' ? 'عميل' : modalType === 'supplier' ? 'مورد' : 'فاتورة'}`;
                            }
                        }
                    } else {
                        // Adding new item
                        const titleElement = document.getElementById(`${modalType}-modal-title`);
                        if (titleElement) {
                            titleElement.textContent = `إضافة ${modalType === 'product' ? 'كمية' : modalType === 'customer' ? 'عميل جديد' : modalType === 'supplier' ? 'مورد جديد' : 'فاتورة جديدة'}`;
                        }
                        
                        // Set default values for new items
                        if (modalType === 'invoice') {
                            this.formFields.invoice.date.value = new Date().toISOString().split('T')[0];
                            this.addInvoiceItem();
                        }
                    }
                }
                
                if (this.modals[modalType]) {
                    this.modals[modalType].classList.add('active');
                } else {
                    console.error(`Modal with type '${modalType}' not found`);
                }
            }
            
            closeModal(modalType) {
                this.modals[modalType].classList.remove('active');
                this.resetForm(modalType);
            }
            
            resetForm(modalType) {
                if (this.forms[modalType]) {
                    this.forms[modalType].reset();
                }
                
                if (modalType === 'invoice') {
                    this.tables.invoiceItems.innerHTML = '';
                }
                
                // Clear hidden ID fields
                if (this.formFields[modalType]?.id) {
                    this.formFields[modalType].id.value = '';
                }
            }
            
            fillForm(modalType, data) {
                const formFields = this.formFields[modalType];
                if (!formFields) return;
                
                formFields.id.value = data.id || '';
                
                Object.keys(data).forEach(key => {
                    if (formFields[key]) {
                        formFields[key].value = data[key] || '';
                    }
                });
            }
            
            openProductModal(id = null) {
                // Open the modal first
                this.openModal('product', id);
                
                // Get references to form elements
                const productSelect = document.getElementById('product-name');
                const productInput = document.getElementById('product-name-input');
                const productInputContainer = document.getElementById('product-name-input-container');
                const productSelectContainer = document.getElementById('product-select-container');
                const toggleButton = document.getElementById('toggle-product-input');
                const toggleText = document.getElementById('toggle-text');
                const priceInput = document.getElementById('product-balance');
                const supplierSelect = document.getElementById('product-supplier');
                
                // Ensure we have all required elements
                if (!productSelect || !productInput || !productInputContainer || !productSelectContainer || !toggleButton || !toggleText) {
                    console.error('Required form elements not found');
                    return;
                }
                
                // Initialize form state
                const initForm = () => {
                    // Reset form state
                    productInputContainer.style.display = 'none';
                    productSelectContainer.style.display = 'block';
                    toggleText.textContent = 'إضافة منتج جديد';
                    productSelect.required = true;
                    productInput.required = false;
                    
                    // Reset form values
                    productSelect.selectedIndex = 0;
                    productInput.value = '';
                    if (priceInput) priceInput.value = '';
                    
                    const quantityInput = document.getElementById('product-quantity');
                    if (quantityInput) quantityInput.value = '1';
                    
                    if (supplierSelect) supplierSelect.selectedIndex = 0;
                    
                    // Show/hide fields based on mode
                    const quantityField = document.getElementById('product-quantity')?.closest('.form-group');
                    const supplierField = document.getElementById('product-supplier')?.closest('.form-group');
                    const priceField = document.getElementById('product-balance')?.closest('.form-group');
                    
                    if (quantityField) quantityField.style.display = 'block';
                    if (supplierField) supplierField.style.display = 'block';
                    if (priceField) priceField.style.display = 'block';
                };
                
                // Initialize the form
                initForm();
                
                // Toggle function
                const toggleInputMode = (e) => {
                    if (e) e.preventDefault();
                    
                    const isInputVisible = productInputContainer.style.display !== 'none';
                    
                    if (isInputVisible) {
                        // Switch to select mode
                        productInputContainer.style.display = 'none';
                        productSelectContainer.style.display = 'block';
                        productSelect.required = true;
                        productInput.required = false;
                        toggleText.textContent = 'إضافة كمية';
                        productSelect.focus();
                        
                        // Show quantity and supplier fields in select mode
                        const quantityField = document.getElementById('product-quantity')?.closest('.form-group');
                        const supplierField = document.getElementById('product-supplier')?.closest('.form-group');
                        if (quantityField) quantityField.style.display = 'block';
                        if (supplierField) supplierField.style.display = 'block';
                    } else {
                        // Switch to input mode
                        productInputContainer.style.display = 'block';
                        productSelectContainer.style.display = 'none';
                        productSelect.required = false;
                        productInput.required = true;
                        toggleText.textContent = 'اختيار من القائمة';
                        productInput.focus();
                        
                        // Hide quantity and supplier fields in input mode
                        const quantityField = document.getElementById('product-quantity')?.closest('.form-group');
                        const supplierField = document.getElementById('product-supplier')?.closest('.form-group');
                        if (quantityField) quantityField.style.display = 'none';
                        if (supplierField) supplierField.style.display = 'none';
                    }
                };
                
                // Set up toggle button
                toggleButton.onclick = toggleInputMode;
                
                // Handle edit mode
                if (id) {
                    const product = this.getProduct(id);
                    if (product) {
                        document.getElementById('product-modal-title').textContent = 'تعديل المنتج';
                        
                        // Switch to input mode for editing
                        productInputContainer.style.display = 'block';
                        productSelectContainer.style.display = 'none';
                        productInput.value = product.name || '';
                        if (priceInput) priceInput.value = product.balance || '';
                        
                        const quantityInput = document.getElementById('product-quantity');
                        if (quantityInput) quantityInput.value = product.quantity || 1;
                        
                        if (product.supplierId && supplierSelect) {
                            supplierSelect.value = product.supplierId;
                        }
                        
                        // Hide quantity and supplier fields in edit mode
                        const quantityField = document.getElementById('product-quantity')?.closest('.form-group');
                        const supplierField = document.getElementById('product-supplier')?.closest('.form-group');
                        if (quantityField) quantityField.style.display = 'none';
                        if (supplierField) supplierField.style.display = 'none';
                        
                        // Update toggle button state
                        toggleText.textContent = 'اختيار من القائمة';
                    }
                } else {
                    // Add mode - populate product dropdown
                    // Clear existing options except the first one
                    while (productSelect.options.length > 1) {
                        productSelect.remove(1);
                    }
                    
                    // Add products to the dropdown, sorted by name
                    const sortedProducts = [...this.products].sort((a, b) => a.name.localeCompare(b.name));
                    sortedProducts.forEach(product => {
                        const option = document.createElement('option');
                        option.value = product.id;
                        option.textContent = `${product.name} (${product.balance} ج.م)`;
                        option.setAttribute('data-price', product.balance);
                        productSelect.appendChild(option);
                    });
                    
                    // Set up price update when product is selected
                    productSelect.addEventListener('change', (e) => {
                        const selectedOption = e.target.options[e.target.selectedIndex];
                        if (selectedOption && selectedOption.value && priceInput) {
                            priceInput.value = selectedOption.getAttribute('data-price') || '';
                        }
                    });
                    
                    // Focus on the select element
                    productSelect.focus();
                }
                
                // Populate supplier dropdown
                if (supplierSelect) {
                    // Clear existing options except the first one
                    while (supplierSelect.options.length > 1) {
                        supplierSelect.remove(1);
                    }
                    
                    // Add suppliers to the dropdown, sorted by name
                    const sortedSuppliers = [...this.suppliers].sort((a, b) => a.name.localeCompare(b.name));
                    sortedSuppliers.forEach(supplier => {
                        const option = document.createElement('option');
                        option.value = supplier.id;
                        option.textContent = `${supplier.name} (${supplier.phone})`;
                        supplierSelect.appendChild(option);
                    });
                }
            }
            
            openCustomerModal(id = null) {
                this.openModal('customer', id);
                
                if (id) {
                    const customer = this.getCustomer(id);
                    if (customer) {
                        const nameField = document.getElementById('customer-name');
                        const phoneField = document.getElementById('customer-phone');
                        const idField = document.getElementById('customer-id');
                        const titleElement = document.getElementById('customer-modal-title');
                        
                        if (nameField) nameField.value = customer.name || '';
                        if (phoneField) phoneField.value = customer.phone || '';
                        if (idField) idField.value = customer.id || '';
                        if (titleElement) titleElement.textContent = 'تعديل بيانات العميل';
                    }
                } else {
                    this.resetForm('customer');
                    const titleElement = document.getElementById('customer-modal-title');
                    if (titleElement) titleElement.textContent = 'إضافة عميل جديد';
                }
            }
            
            openSupplierModal(id = null) {
                this.openModal('supplier', id);
                
                if (id) {
                    const supplier = this.getSupplier(id);
                    if (supplier) {
                        document.getElementById('supplier-name').value = supplier.name;
                        document.getElementById('supplier-phone').value = supplier.phone;
                        document.getElementById('supplier-id').value = supplier.id;
                        document.getElementById('supplier-modal-title').textContent = 'تعديل بيانات المورد';
                    }
                } else {
                    this.resetForm('supplier');
                    document.getElementById('supplier-modal-title').textContent = 'إضافة مورد جديد';
                }
            }
            
            /**
             * Calculates the total for the invoice and updates the UI
             * Handles quantity validation and shows appropriate alerts
             */
            calculateInvoiceTotal() {
                let subtotal = 0;
                const rows = document.querySelectorAll('.invoice-item-row');
                
                rows.forEach(row => {
                    const productSelect = row.querySelector('.invoice-product');
                    const quantityInput = row.querySelector('.invoice-quantity');
                    const totalCell = row.querySelector('.item-total');
                    const alertDiv = row.querySelector('.quantity-alert');
                    const alertText = alertDiv ? alertDiv.querySelector('.alert-text') : null;
                    
                    if (productSelect && quantityInput && totalCell) {
                        const selectedOption = productSelect.options[productSelect.selectedIndex];
                        
                        if (selectedOption && selectedOption.value) {
                            const price = parseFloat(selectedOption.dataset.balance) || 0;
                            const availableQuantity = parseInt(selectedOption.dataset.quantity) || 0;
                            let quantity = parseInt(quantityInput.value) || 0;
                            
                            // Validate quantity
                            if (quantity < 1) {
                                quantity = 1;
                                quantityInput.value = '1';
                            }
                            
                            // Check if quantity exceeds available stock
                            if (quantity > availableQuantity) {
                                if (alertDiv && alertText) {
                                    alertDiv.style.display = 'flex';
                                    alertDiv.style.background = '#ffebee';
                                    alertDiv.style.color = '#c62828';
                                    alertDiv.style.borderColor = '#ffcdd2';
                                    alertText.textContent = `الكمية المطلوبة (${quantity}) تتجاوز الكمية المتاحة (${availableQuantity})`;
                                }
                                quantityInput.style.borderColor = '#f44336';
                            } 
                            // Check for low stock
                            else if (availableQuantity <= 10) {
                                if (alertDiv && alertText) {
                                    alertDiv.style.display = 'flex';
                                    alertDiv.style.background = availableQuantity <= 5 ? '#fff3e0' : '#fff8e1';
                                    alertDiv.style.color = availableQuantity <= 5 ? '#e65100' : '#ff8f00';
                                    alertDiv.style.borderColor = availableQuantity <= 5 ? '#ffe0b2' : '#ffe082';
                                    alertText.textContent = `تنبيه: الكمية المتبقية ${availableQuantity} فقط`;
                                }
                                quantityInput.style.borderColor = availableQuantity <= 5 ? '#ff9800' : '#ffc107';
                            } 
                            // No issues
                            else {
                                if (alertDiv) alertDiv.style.display = 'none';
                                quantityInput.style.borderColor = '#e0e0e0';
                            }
                            
                            // Calculate row total and update UI
                            const rowTotal = price * quantity;
                            subtotal += rowTotal;
                            totalCell.textContent = `${rowTotal.toFixed(2)} ج.م`;
                            
                            // Update max quantity based on available stock
                            quantityInput.max = availableQuantity;
                            
                            // Ensure quantity doesn't exceed available stock when changed
                            if (quantity > availableQuantity) {
                                quantityInput.value = availableQuantity;
                                quantity = availableQuantity;
                                if (alertDiv && alertText) {
                                    alertText.textContent = `تم تعديل الكمية إلى الحد الأقصى المتاح (${availableQuantity})`;
                                }
                            }
                        } else {
                            // No product selected
                            totalCell.textContent = '0.00 ج.م';
                            if (alertDiv) alertDiv.style.display = 'none';
                            quantityInput.style.borderColor = '#e0e0e0';
                        }
                    }
                });
                
                // Update subtotal, tax, and total
                const subtotalElement = document.getElementById('invoice-subtotal');
                const taxElement = document.getElementById('invoice-tax');
                const totalElement = document.getElementById('invoice-total');
                
                if (subtotalElement) subtotalElement.textContent = `${subtotal.toFixed(2)} ج.م`;
                    
                // Calculate tax (assuming 15% tax rate)
                const taxRate = 0.15;
                const tax = subtotal * taxRate;
                const total = subtotal + tax;
                
                if (taxElement) taxElement.textContent = `${tax.toFixed(2)} ج.م`;
                if (totalElement) totalElement.textContent = `${total.toFixed(2)} ج.م`;
                
                return total;
            }
            
            /**
             * Adds a new invoice item row to the invoice
             * @returns {HTMLElement} The created row element
             */
            addInvoiceItem() {
                const row = document.createElement('tr');
                row.className = 'invoice-item-row';
                row.style.backgroundColor = '#fff';
                row.style.borderBottom = '1px solid #f0f0f0';
                row.style.position = 'relative';
                row.innerHTML = `
                    <td style="padding: 12px 15px; text-align: right; vertical-align: middle; position: relative;">
                        <select class="form-control invoice-product" required 
                                style="border: 1px solid #e0e0e0; border-radius: 4px; padding: 8px 12px; width: 100%;">
                            <option value="">اختر منتج</option>
                            ${[...this.products]
                                .sort((a, b) => (a.name || '').localeCompare(b.name || '', 'ar', {sensitivity: 'base'}))
                                .map(p => 
                                    `<option value="${p.id}" data-balance="${p.balance}" data-quantity="${p.quantity || 0}">
                                        ${p.name} (${p.balance.toFixed(2)} ج.م)
                                    </option>`
                                ).join('')}
                        </select>
                        <div class="quantity-alert" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: #fff8e1; color: #ff8f00; padding: 4px 8px; font-size: 12px; border-radius: 0 0 4px 4px; border: 1px solid #ffe0b2; border-top: none; z-index: 10;">
                            <i class="fas fa-exclamation-triangle"></i> <span class="alert-text"></span>
                        </div>
                    </td>
                    <td style="padding: 12px 15px; text-align: center; vertical-align: middle; width: 200px;">
                        <input type="number" class="form-control invoice-quantity" min="1" value="1" required 
                               style="width: 100px; margin: 0 auto; text-align: center; border: 1px solid #e0e0e0; border-radius: 4px; padding: 8px;">
                    </td>
                    <td class="item-total" style="padding: 12px 15px; text-align: left; vertical-align: middle; width: 150px; font-weight: 600; color: #2c3e50;">
                        0.00 ج.م
                    </td>
                    <td style="padding: 12px 15px; text-align: center; vertical-align: middle; width: 70px;">
                        <button type="button" class="btn btn-sm remove-item" 
                                style="background: #fff; border: 1px solid #ff6b6b; color: #ff6b6b; border-radius: 4px; padding: 5px 10px; font-size: 12px; transition: all 0.2s ease;">
                            <i class="fas fa-trash"></i> حذف
                        </button>
                    </td>
                `;
                
                this.tables.invoiceItems.appendChild(row);
                
                // Add event for product selection
                const productSelect = row.querySelector('.invoice-product');
                if (productSelect) {
                    productSelect.addEventListener('change', () => {
                        this.calculateInvoiceTotal();
                    });
                }
                
                // Add quantity change event
                const quantityInput = row.querySelector('.invoice-quantity');
                if (quantityInput) {
                    quantityInput.addEventListener('input', () => this.calculateInvoiceTotal());
                }
                
                // Add remove item event
                const removeBtn = row.querySelector('.remove-item');
                if (removeBtn) {
                    removeBtn.addEventListener('click', () => {
                        if (this.tables.invoiceItems.children.length > 1) {
                            row.remove();
                            this.calculateInvoiceTotal();
                        } else {
                            // Reset the single remaining row instead of removing it
                            const productSelect = row.querySelector('.invoice-product');
                            const quantityInput = row.querySelector('.invoice-quantity');
                            const alertDiv = row.querySelector('.quantity-alert');
                            
                            if (productSelect) productSelect.selectedIndex = 0;
                            if (quantityInput) quantityInput.value = '1';
                            if (alertDiv) alertDiv.style.display = 'none';
                            
                            this.calculateInvoiceTotal();
                        }
                    });
                }
                
                this.calculateInvoiceTotal();
                return row;
            }
            /**
             * Validates the product form data
             * @returns {Object} Object containing validation status, form data, and errors
             */
            validateProductForm() {
                const form = this.formFields.product;
                const productSelect = document.getElementById('product-name');
                const productInput = document.getElementById('product-name-input');
                const priceInput = document.getElementById('product-balance');
                const quantityInput = document.getElementById('product-quantity');
                const supplierSelect = document.getElementById('product-supplier');
                const errors = [];
                const formData = {
                    id: form.id?.value || `prod-${Date.now()}`,
                    name: '',
                    balance: 0,
                    quantity: 0,
                    supplierId: null
                };

                // Check which input method is being used
                const isNewProduct = productInput && productInput.value.trim() !== '';
                const isUsingInput = isNewProduct; // This indicates we're using the text input method

                // Validate product name
                if (isNewProduct) {
                    formData.name = productInput.value.trim();
                    if (!formData.name) {
                        errors.push('اسم المنتج مطلوب');
                    }
                    
                    // Get and validate price
                    formData.balance = parseFloat(priceInput.value) || 0;
                    if (isNaN(formData.balance) || formData.balance <= 0) {
                        errors.push('الرجاء إدخال سعر صحيح');
                    }
                    
                    // Set default quantity for new products
                    formData.quantity = 0;
                    
                    // Get supplier (optional for new products)
                    formData.supplierId = supplierSelect?.value || null;
                } else if (productSelect && productSelect.selectedIndex > 0) {
                    // Using the select dropdown (existing product)
                    const selectedOption = productSelect.options[productSelect.selectedIndex];
                    formData.id = productSelect.value;
                    formData.name = selectedOption.text.split(' (')[0];
                    formData.balance = parseFloat(priceInput?.value) || 0;
                    formData.quantity = parseInt(quantityInput?.value, 10) || 0;
                    formData.supplierId = supplierSelect?.value || null;
                    
                    // Validate quantity for existing products
                    if (isNaN(formData.quantity) || formData.quantity <= 0) {
                        errors.push('الرجاء إدخال كمية صحيحة');
                    }
                } else {
                    // No valid input method found
                    errors.push('الرجاء إدخال بيانات المنتج بشكل صحيح');
                }
                
                return {
                    isValid: errors.length === 0,
                    data: {
                        id: formData.id,
                        name: formData.name,
                        balance: formData.balance,
                        quantity: formData.quantity,
                        supplierId: formData.supplierId,
                        isNewProduct: isNewProduct,
                        isUsingInput: isUsingInput
                    },
                    errors: errors
                };
            }
            
            /**
             * Saves a product to the system
             * @returns {Promise<void>}
             */
            async saveProduct() {
                try {
                    // Get form elements
                    const productSelect = document.getElementById('product-name');
                    const productInput = document.getElementById('product-name-input');
                    const priceInput = document.getElementById('product-balance');
                    const quantityInput = document.getElementById('product-quantity');
                    const supplierSelect = document.getElementById('product-supplier');
                    const modalTitle = document.getElementById('product-modal-title').textContent;
                    
                    // Check if we're in 'Add Quantity' mode
                    const isAddQuantityMode = modalTitle === 'إضافة كمية';
                    
                    // Get product data based on input mode
                    let productId, productName, price, quantity, supplierId;
                    
                    if (isAddQuantityMode) {
                        // In add quantity mode, we should have a selected product
                        if (productSelect.selectedIndex <= 0) {
                            this.showAlert('الرجاء اختيار منتج', 'danger');
                            return;
                        }
                        
                        productId = productSelect.value;
                        productName = productSelect.options[productSelect.selectedIndex].text.split(' (')[0];
                        price = parseFloat(priceInput.value) || 0;
                        quantity = parseFloat(quantityInput.value) || 0;
                        supplierId = supplierSelect?.value || null;
                        
                        if (isNaN(quantity) || quantity <= 0) {
                            this.showAlert('الرجاء إدخال كمية صحيحة', 'danger');
                            return;
                        }
                        
                        // Find existing product
                        const index = this.products.findIndex(p => p.id === productId);
                        if (index === -1) {
                            this.showAlert('المنتج غير موجود', 'danger');
                            return;
                        }
                        
                        const existingProduct = this.products[index];
                        const newQuantity = (parseFloat(existingProduct.quantity) + quantity).toFixed(2);
                        
                        // Format date as YYYY-MM-DD
                        const transactionDate = new Date().toISOString().split('T')[0];
                        
                        // Get supplier info if available
                        let supplierInfo = {};
                        if (supplierId) {
                            const supplier = this.suppliers.find(s => s.id === supplierId);
                            if (supplier) {
                                supplierInfo = {
                                    supplierId: supplier.id,
                                    supplierName: supplier.name
                                };
                            }
                        }
                        
                        // Create transaction object with supplier info
                        const transaction = {
                            ...supplierInfo,
                            date: transactionDate,
                            quantity: quantity,
                            price: price,
                            total: (quantity * price).toFixed(2)
                        };
                        
                        // Initialize productHistory if it doesn't exist
                        if (!existingProduct.productHistory) {
                            existingProduct.productHistory = [];
                        }
                        
                        // Add transaction to product history
                        existingProduct.productHistory.unshift(transaction);
                        
                        // Update product
                        this.products[index] = {
                            ...existingProduct,
                            quantity: parseFloat(newQuantity),
                            balance: price, // Update price to the new value
                            updatedAt: new Date().toISOString()
                        };
                        
                        // Add transaction to supplier if supplier is selected
                        if (supplierId) {
                            const supplierIndex = this.suppliers.findIndex(s => s.id === supplierId);
                            if (supplierIndex !== -1) {
                                const supplier = this.suppliers[supplierIndex];
                                
                                // Initialize transactions array if it doesn't exist
                                if (!supplier.transactions) {
                                    supplier.transactions = [];
                                }
                                
                                // Format date as YYYY-MM-DD
                                const transactionDate = new Date().toISOString().split('T')[0];
                                
                                // Add transaction to supplier in the desired format
                                supplier.transactions.unshift({
                                    id: `trans-${Date.now()}`,
                                    date: transactionDate,
                                    name: productName,
                                    price: price,
                                    quantity: quantity,
                                    total: (quantity * price).toFixed(2)
                                });
                                
                                // Update supplier's balance
                                supplier.balance = (parseFloat(supplier.balance || 0) + (quantity * price)).toFixed(2);
                                
                                // Save the updated supplier
                                this.suppliers[supplierIndex] = supplier;
                            }
                        }
                        
                        // Save changes and update UI
                        await this.saveData();
                        this.closeModal('product');
                        this.renderProductsTable();
                        this.updateDashboard();
                        this.showAlert(`تم إضافة ${quantity} إلى الكمية الحالية`, 'success');
                        return;
                        
                    } else {
                        // Regular product save (new or edit)
                        const { isValid, data: formData, errors } = this.validateProductForm();
                        
                        if (!isValid) {
                            this.showAlert(errors.join('<br>'), 'danger');
                            return;
                        }
                        
                        const isEditMode = !!this.formFields.product.id?.value;
                        
                        // Prepare product data
                        const productData = {
                            ...formData,
                            updatedAt: new Date().toISOString(),
                            createdAt: isEditMode 
                                ? (this.getProduct(formData.id)?.createdAt || new Date().toISOString())
                                : new Date().toISOString()
                        };
                        
                        // Update or add product
                        if (isEditMode) {
                            const index = this.products.findIndex(p => p.id === formData.id);
                            if (index !== -1) {
                                const existingProduct = this.products[index];
                                const priceChanged = existingProduct.balance !== parseFloat(formData.balance);
                                
                                // Initialize balanceEditHistory if it doesn't exist
                                if (!existingProduct.balanceEditHistory) {
                                    existingProduct.balanceEditHistory = [];
                                }
                                
                                // Add current price to history if it has changed
                                if (priceChanged) {
                                    existingProduct.balanceEditHistory.unshift({
                                        date: new Date().toISOString().split('T')[0],
                                        balance: parseFloat(formData.balance)
                                    });
                                }
                                
                                // Update product
                                this.products[index] = {
                                    ...existingProduct,
                                    name: formData.name,
                                    balance: parseFloat(formData.balance),
                                    supplierId: formData.supplierId,
                                    updatedAt: productData.updatedAt
                                };
                                
                                this.showAlert('تم تحديث المنتج بنجاح', 'success');
                            }
                        } else {
                            // Add new product
                            this.products.push({
                                ...productData,
                                quantity: 0, // New products start with 0 quantity
                                createdAt: new Date().toISOString(),
                                productHistory: []
                            });
                            this.showAlert('تمت إضافة المنتج بنجاح', 'success');
                        }
                    }

                    // Save to storage and update UI
                    await this.saveData();
                    this.closeModal('product');
                    this.renderProductsTable();
                    this.updateDashboard();
                    
                } catch (error) {
                    console.error('Error saving product:', error);
                    this.showAlert('حدث خطأ أثناء حفظ المنتج. يرجى المحاولة مرة أخرى.', 'danger');
                }
            }
            
            saveCustomer() {
                try {
                    // Get form elements
                    const id = document.getElementById('customer-id').value || `cust-${Date.now()}`;
                    const name = document.getElementById('customer-name').value.trim();
                    const phone = document.getElementById('customer-phone').value.trim();
                    
                    // Validate required fields
                    if (!name || !phone) {
                        this.showAlert('الرجاء ملء جميع الحقول المطلوبة', 'danger');
                        return;
                    }
                    
                    // Check if this is an update or new customer
                    const existingIndex = this.customers.findIndex(c => c.id === id);
                    const now = new Date().toISOString();
                    
                    // Create customer data object with all required fields
                    const customerData = { 
                        id, 
                        name, 
                        phone,
                        balance: 0,
                        purchases: [],
                        updatedAt: now,
                        ...(existingIndex === -1 ? { createdAt: now } : {})
                    };
                    
                    if (existingIndex !== -1) {
                        // Update existing customer - preserve creation date, balance, and purchases
                        const existingCustomer = this.customers[existingIndex];
                        customerData.createdAt = existingCustomer.createdAt || now;
                        customerData.balance = typeof existingCustomer.balance === 'number' ? existingCustomer.balance : 0;
                        customerData.purchases = Array.isArray(existingCustomer.purchases) ? existingCustomer.purchases : [];
                        
                        this.customers[existingIndex] = customerData;
                        this.showAlert('تم تحديث بيانات العميل بنجاح', 'success');
                    } else {
                        // Add new customer with all required fields
                        this.customers.push({
                            ...customerData,
                            balance: 0,
                            purchases: [],
                            createdAt: now
                        });
                        this.showAlert('تم إضافة العميل بنجاح', 'success');
                    }
                    
                    // Save changes and update UI
                    this.saveData();
                    this.closeModal('customer');
                    this.renderCustomersTable();
                    this.updateDashboard();
                    
                } catch (error) {
                    console.error('Error saving customer:', error);
                    this.showAlert('حدث خطأ أثناء حفظ بيانات العميل', 'danger');
                }
            }
            
            saveSupplier() {
                const form = this.formFields.supplier;
                const id = form.id.value || `sup-${Date.now()}`;
                const name = form.name.value.trim();
                const phone = form.phone.value.trim();
                
                if (!name || !phone) {
                    this.showAlert('الرجاء ملء جميع الحقول المطلوبة', 'danger');
                    return;
                }
                
                const supplierData = {
                    id,
                    name,
                    phone,
                    balance: 0,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    transactions: []
                };
                
                if (form.id.value) {
                    // Update existing supplier - preserve creation date and balance
                    const index = this.suppliers.findIndex(s => s.id === id);
                    if (index !== -1) {
                        const existingSupplier = this.suppliers[index];
                        supplierData.balance = existingSupplier.balance || 0;
                        supplierData.createdAt = existingSupplier.createdAt || new Date().toISOString();
                        supplierData.transactions = Array.isArray(existingSupplier.transactions) ? existingSupplier.transactions : [];
                        this.suppliers[index] = supplierData;
                        this.showAlert('تم تحديث المورد بنجاح', 'success');
                    }
                } else {
                    // Add new supplier with all required fields
                    this.suppliers.push(supplierData);
                    this.showAlert('تم إضافة المورد بنجاح', 'success');
                }
                
                this.saveData();
                this.closeModal('supplier');
                this.renderSuppliersTable();
            }
            
            /**
             * Handles printing an invoice
             * @param {string|object} invoiceIdOrData - Either the invoice ID or the invoice data object
             */
            printInvoice(invoiceIdOrData = null) {
                try {
                    console.log('printInvoice called with:', invoiceIdOrData);
                    
                    if (!invoiceIdOrData) {
                        throw new Error('No invoice ID or data provided');
                    }
                    
                    // If we have invoice data directly, use it
                    if (typeof invoiceIdOrData === 'object' && invoiceIdOrData !== null) {
                        this._openPrintModal(invoiceIdOrData);
                        return;
                    }
                    
                    // Otherwise, try to find the invoice by ID
                    const invoice = this.getInvoice(invoiceIdOrData);
                    if (!invoice) {
                        throw new Error(`Invoice not found: ${invoiceIdOrData}`);
                    }
                    
                    this._openPrintModal(invoice);
                } catch (error) {
                    console.error('Error in printInvoice:', error);
                    this.showAlert('حدث خطأ أثناء محاولة طباعة الفاتورة', 'error');
                }
            }
            
            /**
             * Internal method to open the print modal with invoice data
             * @private
             * @param {object} invoice - The invoice data to print
             */
            _openPrintModal(invoice) {
                if (!invoice) {
                    console.error('No invoice data provided to _openPrintModal');
                    this.showAlert('بيانات الفاتورة غير صالحة', 'error');
                    return;
                }
                
                // Ensure we have items in the invoice
                if (!invoice.items && invoice.products) {
                    invoice.items = invoice.products; // Handle case where items are stored in 'products' property
                }
                    
                // Get customer information
                let customerName = 'عميل';
                let customerPhone = '';
                
                if (invoice.customer) {
                    // If customer object is directly included in the invoice
                    customerName = invoice.customer.name || customerName;
                    customerPhone = invoice.customer.phone || customerPhone;
                } else if (invoice.customerId) {
                    // If only customer ID is available, try to look it up
                    const customer = this.getCustomer(invoice.customerId);
                    if (customer) {
                        customerName = customer.name || customerName;
                        customerPhone = customer.phone || customerPhone;
                    }
                } else if (invoice.customerName) {
                    // If customer name is directly in the invoice
                    customerName = invoice.customerName;
                }
                    
                // Prepare items data
                const items = [];
                console.log('Original invoice items:', JSON.stringify(invoice.items, null, 2));
                
                // First, try to get items from the invoice
                const invoiceItems = Array.isArray(invoice.items) ? invoice.items : [];
                
                // If no items found, try to find items in other possible properties
                const possibleItemArrays = [];
                if (invoiceItems.length === 0) {
                    // Look for arrays that might contain items
                    Object.keys(invoice).forEach(key => {
                        if (Array.isArray(invoice[key]) && key.toLowerCase() !== 'items') {
                            console.log(`Found potential items array in property '${key}':`, invoice[key]);
                            possibleItemArrays.push(...invoice[key]);
                        }
                    });
                }
                    
                // Combine all possible items
                const allPossibleItems = [...invoiceItems, ...possibleItemArrays];
                
                console.log('Processing all possible items:', allPossibleItems);
                
                // Process all items
                allPossibleItems.forEach(item => {
                    if (!item) return;
                    
                    console.log('Processing item:', item);
                    
                    // Try to find the product in the allProducts array first
                    let productName = 'منتج غير معروف';
                    let productPrice = 0;
                    
                    // First try to find by ID in allProducts
                    const productId = item.id || item.productId;
                    if (productId) {
                        const product = window.allProducts?.find(p => p.id === productId);
                        if (product) {
                            productName = product.name;
                            productPrice = parseFloat(product.balance) || 0;
                        }
                    }
                    
                    // If still not found, try to find by name in allProducts
                    if (productName === 'منتج غير معروف' && item.productName) {
                        const product = window.allProducts?.find(p => p.name === item.productName);
                        if (product) {
                            productName = product.name;
                            productPrice = parseFloat(product.balance) || 0;
                        }
                    }
                    
                    // Fall back to item properties if product not found in allProducts
                    if (productName === 'منتج غير معروف') {
                        productName = item.productName || item.name || item.product?.name || 'منتج غير معروف';
                        productPrice = parseFloat(item.balance || item.price || item.product?.price || 0);
                    }
                    
                    const quantity = parseFloat(item.quantity) || 0;
                    const balance = parseFloat(item.balance || item.price || productPrice || 0);
                    
                    console.log(`Item details - ID: ${item.id || 'N/A'}, Name: ${productName}, Qty: ${quantity}, Price: ${balance}`);
                    
                    if (productName || balance > 0) {
                        items.push({
                            id: item.id,
                            productId: item.productId,
                            productName: productName,
                            quantity: quantity,
                            balance: balance,
                            total: quantity * balance
                        });
                    }
                });
                
                console.log('Processed items for printing:', items);
                
                // If still no items, try to extract from the invoice data directly
                if (items.length === 0) {
                    console.log('No items found in standard locations, trying direct extraction');
                    
                    // Look for any array in the invoice that might contain items
                    Object.keys(invoice).forEach(key => {
                        if (Array.isArray(invoice[key])) {
                            console.log(`Checking array in '${key}':`, invoice[key]);
                            invoice[key].forEach((potentialItem, index) => {
                                if (potentialItem && (potentialItem.quantity || potentialItem.balance || potentialItem.price)) {
                                    const productName = potentialItem.productName || 
                                                     potentialItem.name || 
                                                     potentialItem.product?.name || 
                                                     `منتج ${index + 1}`;
                                    const quantity = parseFloat(potentialItem.quantity) || 0;
                                    const balance = parseFloat(potentialItem.balance || potentialItem.price || 0);
                                    
                                    items.push({
                                        productName: productName,
                                        quantity: quantity,
                                        balance: balance,
                                        total: quantity * balance
                                    });
                                }
                            });
                        }
                    });
                    
                    console.log('Items after direct extraction:', items);
                }
                    
                // Calculate subtotal from items
                const subtotal = items.reduce((sum, item) => {
                    return sum + (parseFloat(item.balance) * parseFloat(item.quantity) || 0);
                }, 0);
                
                // Ensure all items have the correct structure
                const formattedItems = items.map(item => ({
                    productName: item.productName || item.name || 'منتج غير معروف',
                    quantity: parseFloat(item.quantity) || 0,
                    balance: parseFloat(item.balance || item.price || 0),
                    total: (parseFloat(item.quantity) * parseFloat(item.balance || item.price || 0)) || 0
                }));
                
                // Prepare the invoice data for printing
                const invoiceData = {
                    id: invoice.id || `INV-${Date.now()}`,
                    invoiceNumber: invoice.invoiceNumber || invoice.id || `INV-${Date.now()}`,
                    customerName: customerName,
                    customerPhone: customerPhone,
                    date: invoice.date || invoice.createdAt || new Date().toISOString(),
                    items: formattedItems,
                    subtotal: parseFloat(invoice.subtotal) || subtotal,
                    tax: parseFloat(invoice.tax) || 0,
                    total: parseFloat(invoice.total) || (subtotal + (parseFloat(invoice.tax) || 0)),
                    status: invoice.status || 'unpaid',
                    notes: invoice.notes || ''
                };
                
                // If we have a customer object, include it
                if (invoice.customer) {
                    invoiceData.customer = invoice.customer;
                } else if (invoice.customerId) {
                    const customer = this.getCustomer(invoice.customerId);
                    if (customer) {
                        invoiceData.customer = customer;
                    }
                }
                    
                console.log('Prepared invoice data for printing:', JSON.stringify(invoiceData, null, 2));
                
                // Open the print modal with the prepared data
                if (window.printInvoice) {
                    window.printInvoice.openModal(invoiceData);
                } else {
                    console.error('PrintInvoice is not available');
                    this.showAlert('خطأ في تهيئة نظام الطباعة', 'error');
                }
                
                if (!invoiceData || !Array.isArray(invoiceData.items) || invoiceData.items.length === 0) {
                    this.showAlert('لا توجد عناصر في الفاتورة للطباعة', 'warning');
                    return;
                }
            }
            
            /**
             * Handles printing an invoice
             * @param {string|object} invoiceIdOrData - Either the invoice ID or the invoice data object
             * @returns {Promise<void>}
             * @private
             * @param {object} invoice - The invoice data to process
             * @returns {object} Processed invoice data
             */
            _processInvoiceData(invoice) {
                if (!invoice) {
                    throw new Error('No invoice data provided');
                }
                
                // Create a copy to avoid modifying the original
                const processed = { ...invoice };
                
                // Ensure we have items in the invoice
                if (!processed.items && processed.products) {
                    processed.items = Array.isArray(processed.products) ? [...processed.products] : [];
                } else if (!processed.items) {
                    processed.items = [];
                }
                
                // Ensure items is an array
                if (!Array.isArray(processed.items)) {
                    console.warn('Invoice items is not an array, converting...');
                    processed.items = [];
                }
                
                // Process each item to ensure it has required fields
                processed.items = processed.items.map(item => ({
                    id: item.id || `item-${Math.random().toString(36).substr(2, 9)}`,
                    name: item.name || item.productName || 'منتج غير معروف',
                    quantity: parseFloat(item.quantity) || 0,
                    price: parseFloat(item.price) || parseFloat(item.balance) || 0,
                    total: (parseFloat(item.quantity) || 0) * (parseFloat(item.price) || parseFloat(item.balance) || 0),
                    ...item // Spread any additional properties
                }));
                
                // Calculate totals if not provided
                if (processed.total === undefined) {
                    processed.total = processed.items.reduce((sum, item) => sum + (parseFloat(item.total) || 0), 0);
                }
                
                // Ensure we have a valid ID for the invoice
                if (!processed.id) {
                    processed.id = processed.invoiceNumber || `temp-${Date.now()}`;
                    console.warn('Generated temporary invoice ID:', processed.id);
                }
                
                // Format dates if needed
                if (processed.date && !(processed.date instanceof Date)) {
                    try {
                        processed.date = new Date(processed.date);
                    } catch (e) {
                        console.warn('Invalid date format in invoice:', processed.date);
                        processed.date = new Date();
                    }
                } else if (!processed.date) {
                    processed.date = new Date();
                }
                
                return processed;
            }
            
            /**
             * Internal method to open the print modal with invoice data
             * @private
             * @param {object} invoice - The processed invoice data to print
             * @returns {Promise<void>}
             */
            async _openPrintModal(invoice) {
                try {
                    if (!invoice) {
                        throw new Error('No invoice data provided to _openPrintModal');
                    }
                    
                    if (!window.printInvoice || typeof window.printInvoice.openModal !== 'function') {
                        throw new Error('Print functionality is not properly initialized');
                    }
                    
                    console.log('Opening print modal with invoice:', invoice);
                    
                    // Ensure we have customer data in the invoice object
                    let customerData = { ...invoice };
                    
                    // If we have a customer ID but no customer object, try to look it up
                    if (invoice.customerId) {
                        const customer = this.getCustomer(invoice.customerId);
                        if (customer) {
                            customerData.customer = customer;
                            customerData.customerName = customer.name || customerData.customerName || 'عميل';
                            customerData.customerPhone = customer.phone || customerData.customerPhone || 'N/A';
                        }
                    }
                    // If we have a customer object, ensure the direct properties are set
                    else if (invoice.customer) {
                        customerData.customerName = invoice.customer.name || invoice.customerName || 'عميل';
                        customerData.customerPhone = invoice.customer.phone || invoice.customerPhone || 'N/A';
                    }
                    // Default for cash customers
                    else {
                        customerData.customerName = invoice.customerName || 'عميل';
                        customerData.customerPhone = invoice.customerPhone || 'N/A';
                    }
                    
                    console.log('Invoice data with customer info:', customerData);
                    
                    // Open the print modal with the complete invoice data
                    await window.printInvoice.openModal(customerData);
                    
                } catch (error) {
                    console.error('Error in _openPrintModal:', error);
                    this.showAlert('حدث خطأ أثناء فتح نافذة الطباعة', 'error');
                    throw error; // Re-throw to allow caller to handle if needed
                }
            }
            
            saveInvoice() {
                try {
                    const form = this.formFields.invoice;
                    const id = form.id.value || `INV-${Date.now().toString().substr(-6)}`;
                    const customerId = form.customer.value;
                    const date = form.date.value || new Date().toISOString().split('T')[0];
                    
                    // Validate inputs
                    if (!customerId || !date) {
                        this.showAlert('الرجاء ملء جميع الحقول المطلوبة', 'danger');
                        return;
                    }
                    
                    // Get customer and ensure purchases array exists
                    const customer = this.getCustomer(customerId);
                    const customerName = customer ? customer.name : 'عميل';
                    
                    // Ensure customer has a purchases array
                    if (customer && !Array.isArray(customer.purchases)) {
                        customer.purchases = [];
                    }
                    
                    // Collect invoice items
                    const items = [];
                    const invalidFields = [];
                    let hasValidItems = false;
                    
                    document.querySelectorAll('.invoice-item-row').forEach((row, index) => {
                        const productSelect = row.querySelector('.invoice-product');
                        const productId = productSelect?.value;
                        const quantityInput = row.querySelector('.invoice-quantity');
                        const quantity = quantityInput ? parseFloat(quantityInput.value) : NaN;
                        
                        // Skip empty rows (all fields empty)
                        if (!productId && (isNaN(quantity) || quantity === 0)) {
                            return;
                        }
                        
                        // Get balance from the selected product option's data attribute
                        let balance = 0;
                        if (productSelect && productSelect.selectedIndex > 0) {
                            const selectedOption = productSelect.options[productSelect.selectedIndex];
                            balance = parseFloat(selectedOption?.dataset.balance) || 0;
                        }
                        
                        // Validate the row
                        if (!productId) {
                            invalidFields.push(`- الرجاء اختيار منتج في البند ${index + 1}`);
                        } else if (isNaN(quantity) || quantity <= 0) {
                            const productName = productSelect.options[productSelect.selectedIndex]?.text || 'المنتج';
                            invalidFields.push(`- الكمية غير صالحة لـ ${productName}`);
                        } else if (isNaN(balance) || balance < 0) {
                            invalidFields.push(`- سعر المنتج غير صالح في البند ${index + 1}`);
                        } else {
                            // Check product availability
                            const product = this.getProduct(productId);
                            if (product) {
                                if (product.quantity < quantity) {
                                    invalidFields.push(`- الكمية المتوفرة غير كافية لـ ${product.name} (المتاح: ${product.quantity})`);
                                } else {
                                    items.push({ productId, quantity, balance });
                                    hasValidItems = true;
                                }
                            } else {
                                invalidFields.push(`- المنتج المحدد غير موجود`);
                            }
                        }
                    });
                    
                    // Show all validation errors at once
                    if (invalidFields.length > 0) {
                        this.showAlert(`الرجاء تصحيح الأخطاء التالية:<br>${invalidFields.join('<br>')}`, 'danger');
                        return;
                    }
                    
                    if (!hasValidItems) {
                        this.showAlert('الرجاء إضافة منتج واحد على الأقل للفاتورة', 'danger');
                        return;
                    }
                    
                    // Get status from the form
                    const status = document.getElementById('invoice-status')?.value || 'unpaid';
                    
                    // Calculate totals and prepare items with full product details
                    let subtotal = 0;
                    const processedItems = [];
                    
                    // Process each item in the invoice
                    items.forEach(item => {
                        const product = this.getProduct(item.productId);
                        if (!product) return;
                        
                        const itemTotal = item.quantity * item.balance;
                        subtotal += itemTotal;
                        
                        // Add to processed items for the invoice
                        processedItems.push({
                            productId: item.productId,
                            name: product.name || 'منتج غير معروف',
                            quantity: item.quantity,
                            price: item.balance,
                            total: itemTotal
                        });
                        
                        // Update product quantity
                        product.quantity -= item.quantity;
                        if (product.quantity < 0) product.quantity = 0;
                        
                        // Initialize product history if it doesn't exist
                        if (!product.productHistory) {
                            product.productHistory = [];
                        }
                        
                        // Add transaction to product history
                        product.productHistory.unshift({
                            type: 'sale',
                            invoiceId: id,
                            customerId: customerId,
                            customerName: customerName,
                            date: date,
                            quantity: -item.quantity, // Negative for sales
                            price: item.balance,
                            total: itemTotal
                        });
                        
                        // Add balance edit history
                        if (!product.balanceEditHistory) {
                            product.balanceEditHistory = [];
                        }
                        
                        product.balanceEditHistory.unshift({
                            date: date,
                            balance: product.quantity,
                            note: `بيع ${item.quantity} وحدة للعميل ${customerName}`
                        });
                    });
                    
                    // Calculate final total
                    const total = subtotal;
                    const paid = status === 'paid' ? total : 0;
                    
                    const invoiceData = {
                        id,
                        customerId,
                        customerName: customerName,
                        date,
                        items: processedItems,
                        subtotal: parseFloat(subtotal.toFixed(2)),
                        total: parseFloat(total.toFixed(2)),
                        paid: parseFloat(paid.toFixed(2)),
                        remaining: parseFloat((total - paid).toFixed(2)),
                        status: status,
                        createdAt: new Date().toISOString()
                    };
                    
                    // Check if this is an update or new invoice
                    const existingInvoiceIndex = this.invoices.findIndex(i => i.id === id);
                    
                    if (existingInvoiceIndex !== -1) {
                        // Update existing invoice
                        this.invoices[existingInvoiceIndex] = invoiceData;
                    } else {
                        // Add new invoice
                        this.invoices.unshift(invoiceData);
                    }
                    
                    // Update customer's purchase history and balance
                    if (customer) {
                        // Create a clean purchase record
                        const purchaseRecord = {
                            id: invoiceData.id,
                            date: invoiceData.date,
                            total: invoiceData.total,
                            status: invoiceData.status,
                            itemsCount: invoiceData.items.length
                        };
                        
                        // Check if invoice already exists in customer's purchases
                        const existingPurchaseIndex = customer.purchases.findIndex(
                            inv => inv.id === invoiceData.id
                        );
                        
                        if (existingPurchaseIndex !== -1) {
                            // Update existing purchase record
                            customer.purchases[existingPurchaseIndex] = purchaseRecord;
                        } else {
                            // Add new purchase record
                            customer.purchases.unshift(purchaseRecord);
                            
                            // Only update balance for new invoices
                            if (status === 'unpaid') {
                                // Initialize balance if it doesn't exist
                                if (customer.balance === undefined) {
                                    customer.balance = 0;
                                }
                                // Add the invoice total to the customer's balance
                                customer.balance = (parseFloat(customer.balance) || 0) + parseFloat(total);
                            }
                        }
                    }
                    
                    // Save all changes
                    this.saveData();
                    this.closeModal('invoice');
                    this.renderInvoicesTable();
                    this.renderProductsTable();
                    this.updateDashboard();
                    
                    this.showAlert('تم حفظ الفاتورة بنجاح', 'success');
                    
                } catch (error) {
                    console.error('Error saving invoice:', error);
                    this.showAlert('حدث خطأ أثناء حفظ الفاتورة', 'danger');
                }
            }
            
            confirmDelete() {
                if (this.currentDeleteId && this.currentDeleteType) {
                    if (this.currentDeleteType === 'product') {
                        this.deleteProduct(this.currentDeleteId);
                    } else if (this.currentDeleteType === 'invoice') {
                        this.deleteInvoice(this.currentDeleteId);
                    } else if (this.currentDeleteType === 'customer') {
                        this.deleteCustomer(this.currentDeleteId);
                    } else if (this.currentDeleteType === 'supplier') {
                        this.deleteSupplier(this.currentDeleteId);
                    }
                    this.closeModal('delete');
                    this.currentDeleteId = null;
                    this.currentDeleteType = null;
                }
            }
            
            deleteProduct(id) {
                this.products = this.products.filter(p => p.id !== id);
                this.saveData();
                this.showAlert('تم حذف المنتج بنجاح', 'success');
                this.renderProductsTable();
                this.updateDashboard();
            }
            
            deleteInvoice(id) {
                this.invoices = this.invoices.filter(i => i.id !== id);
                this.saveData();
                this.showAlert('تم حذف الفاتورة بنجاح', 'success');
                this.renderInvoicesTable();
                this.updateDashboard();
            }
            
            deleteCustomer(id) {
                this.customers = this.customers.filter(c => c.id !== id);
                this.saveData();
                this.showAlert('تم حذف العميل بنجاح', 'success');
                this.renderCustomersTable();
            }
            
            deleteSupplier(id) {
                this.suppliers = this.suppliers.filter(s => s.id !== id);
                this.saveData();
                this.showAlert('تم حذف المورد بنجاح', 'success');
                this.renderSuppliersTable();
            }
            
            showDeleteConfirmation(id, type, message) {
                this.currentDeleteId = id;
                this.currentDeleteType = type;
                document.getElementById('delete-message').textContent = message || 'هل أنت متأكد أنك تريد حذف هذا العنصر؟ لا يمكن التراجع عن هذا الإجراء.';
                this.openModal('delete');
            }
            
            getProduct(id) {
                return this.products.find(p => p.id === id);
            }
            
            getInvoice(id) {
                return this.invoices.find(i => i.id === id);
            }
            
            getCustomer(id) {
                return this.customers.find(customer => customer.id === id);
            }
            
            getSupplier(id) {
                // Find the supplier
                const supplier = this.suppliers.find(supplier => supplier.id === id);
                if (!supplier) return null;
                
                // Get all products that have this supplier in their history
                const supplierProducts = this.products.filter(p => 
                    p.supplierId === id || 
                    (Array.isArray(p.supplierHistory) && p.supplierHistory.some(sh => sh.supplierId === id))
                );
                
                // Create items history array
                const itemsHistory = [];
                
                supplierProducts.forEach(product => {
                    // Add current product if it's from this supplier
                    if (product.supplierId === id) {
                        itemsHistory.push({
                            productId: product.id,
                            name: product.name,
                            quantity: product.quantity || 0,
                            price: product.balance || 0,
                            date: product.dateAdded || new Date().toISOString(),
                            supplierId: id,
                            isCurrent: true
                        });
                    }
                    
                    // Add historical purchases
                    if (Array.isArray(product.supplierHistory)) {
                        product.supplierHistory.forEach(history => {
                            if (history.supplierId === id) {
                                itemsHistory.push({
                                    productId: product.id,
                                    name: product.name,
                                    quantity: history.quantity || 0,
                                    price: history.price || 0,
                                    date: history.date || new Date().toISOString(),
                                    supplierId: id,
                                    isHistory: true
                                });
                            }
                        });
                    }
                });
                
                // Sort by date (newest first)
                itemsHistory.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // Return supplier with items history
                return {
                    ...supplier,
                    itemsHistory
                };
            }
            
            filterProducts() {
                const searchTerm = this.searchInputs.products?.value?.toLowerCase() || '';
                const status = this.filterSelects.products?.value || 'all';
                const quantityMin = document.getElementById('quantity-min')?.value ? 
                    parseInt(document.getElementById('quantity-min').value) : null;
                const quantityMax = document.getElementById('quantity-max')?.value ? 
                    parseInt(document.getElementById('quantity-max').value) : null;
                
                // Store filter state
                this.filterStates.products = { 
                    searchTerm, 
                    statusFilter: status,
                    quantityMin,
                    quantityMax
                };
                
                // If no filters are applied, show all products
                if (!searchTerm && status === 'all' && quantityMin === null && quantityMax === null) {
                    this.renderProductsTable();
                    return;
                }
                
                // Filter products based on search, status, and quantity range
                const filteredProducts = this.products.filter(product => {
                    // Filter by search term
                    const matchesSearch = !searchTerm || 
                        product.name.toLowerCase().includes(searchTerm) ||
                        (product.description && product.description.toLowerCase().includes(searchTerm));
                    
                    // Filter by status
                    let matchesStatus = true;
                    if (status === 'available') {
                        matchesStatus = product.quantity > 10;
                    } else if (status === 'low') {
                        matchesStatus = product.quantity > 0 && product.quantity <= 10;
                    } else if (status === 'out') {
                        matchesStatus = product.quantity === 0;
                    }
                    
                    // Filter by quantity range
                    let matchesQuantity = true;
                    if (quantityMin !== null && product.quantity < quantityMin) {
                        matchesQuantity = false;
                    }
                    if (quantityMax !== null && product.quantity > quantityMax) {
                        matchesQuantity = false;
                    }
                    
                    return matchesSearch && matchesStatus && matchesQuantity;
                });
                
                // Reset to first page when filtering
                this.currentPage.products = 1;
                
                // Store filtered products and render the table
                this.filteredProducts = filteredProducts;
                this.renderProductsTable(filteredProducts);
            }
            
            filterInvoices() {
                try {
                    console.log('=== Starting filterInvoices ===');
                    const searchInput = document.getElementById('invoice-search');
                    const statusFilter = document.getElementById('status-invoice-filter');
                    
                    if (!searchInput || !statusFilter) {
                        console.error('Search input or status filter not found');
                        this.renderInvoicesTable();
                        return;
                    }
                    
                    const searchTerm = searchInput.value.trim().toLowerCase();
                    const statusValue = statusFilter.value;
                    
                    // Store filter state once
                    this.filterStates.invoices = { searchTerm, statusFilter: statusValue };
                    
                    console.log('Filter parameters:', { searchTerm, statusValue });
                    console.log('Total invoices to filter:', this.invoices.length);
                    
                    const filteredInvoices = this.invoices.filter(invoice => {
                        // Check if the invoice matches the search term
                        const matchesSearch = 
                            !searchTerm || // If search is empty, match all
                            (invoice.id && invoice.id.toLowerCase().includes(searchTerm)) ||
                            (invoice.customer && typeof invoice.customer === 'string' && invoice.customer.toLowerCase().includes(searchTerm)) ||
                            (invoice.customer && typeof invoice.customer === 'object' && 
                             invoice.customer.name && invoice.customer.name.toLowerCase().includes(searchTerm)) ||
                            (invoice.date && invoice.date.toString().includes(searchTerm));
                            
                        // Check if the invoice matches the status filter
                        let matchesStatus = true;
                        if (statusValue === 'paid') {
                            matchesStatus = (invoice.status === 'paid' || invoice.paid === true);
                        } else if (statusValue === 'unpaid') {
                            matchesStatus = (invoice.status === 'unpaid' || invoice.paid === false);
                            // Only consider undefined as unpaid if status is also not 'paid'
                            if (invoice.paid === undefined && invoice.status !== 'paid') {
                                matchesStatus = true;
                            } else if (invoice.paid === undefined) {
                                matchesStatus = false;
                            }
                        }
                        // If status is 'all', matchesStatus remains true
                        
                        return matchesSearch && matchesStatus;
                    });
                    
                    console.log('=== Filter Results ===');
                    console.log('Total matching invoices:', filteredInvoices.length);
                    
                    // Reset to first page when filtering
                    this.currentPage.invoices = 1;
                    
                    // Render the filtered invoices using the main render method
                    this.renderInvoicesTable(filteredInvoices);
                    
                } catch (error) {
                    console.error('Error in filterInvoices:', error);
                    this.showAlert('حدث خطأ أثناء تصفية الفواتير', 'error');
                }
            }
            
            filterSuppliers() {
                const searchTerm = this.searchInputs.suppliers?.value?.toLowerCase() || '';
                
                if (!searchTerm) {
                    this.renderSuppliersTable();
                    return;
                }
                
                const filteredSuppliers = this.suppliers.filter(supplier => 
                    (supplier.name?.toLowerCase().includes(searchTerm) || false) ||
                    (supplier.phone?.includes(searchTerm) || false)
                );
                
                // Store filter state
                this.filterStates.suppliers = { searchTerm };
                
                // Reset to first page when filtering
                this.currentPage.suppliers = 1;
                
                // Store filtered suppliers and render the table
                this.filteredSuppliers = filteredSuppliers;
                this.renderSuppliersTable(filteredSuppliers);
                
                // Store filter state
                this.filterStates.products = { searchTerm, statusFilter };
                
                // If no search term and no filter, show all products
                if (!searchTerm && statusFilter === 'all') {
                    this.renderProductsTable(this.products);
                    return;
                }
                
                let filteredProducts = this.products.filter(product => {
                    // Filter by search term
                    const matchesSearch = !searchTerm || 
                        product.name.toLowerCase().includes(searchTerm) ||
                        (product.description && product.description.toLowerCase().includes(searchTerm));
                    
                    // Filter by status
                    let matchesStatus = true;
                    if (statusFilter === 'available') {
                        matchesStatus = product.quantity > 10;
                    } else if (statusFilter === 'low') {
                        matchesStatus = product.quantity > 0 && product.quantity <= 10;
                    } else if (statusFilter === 'out') {
                        matchesStatus = product.quantity === 0;
                    }
                    
                    return matchesSearch && matchesStatus;
                });
                
                // Reset to first page when filtering
                this.currentPage.products = 1;
                
                // Store filtered products and render the table
                this.filteredProducts = filteredProducts;
                this.renderProductsTable(filteredProducts);
            }
            
            renderProductsTable(productsList = null) {
                // Apply stored filters if no specific list is provided
                if (productsList === null) {
                    const { searchTerm, statusFilter } = this.filterStates.products || { searchTerm: '', statusFilter: 'all' };
                    productsList = this.products.filter(product => {
                        // Filter by search term
                        const matchesSearch = !searchTerm || 
                            product.name.toLowerCase().includes(searchTerm) ||
                            (product.description && product.description.toLowerCase().includes(searchTerm));
                        
                        // Filter by status
                        let matchesStatus = true;
                        if (statusFilter === 'available') {
                            matchesStatus = product.quantity > 10;
                        } else if (statusFilter === 'low') {
                            matchesStatus = product.quantity > 0 && product.quantity <= 10;
                        } else if (statusFilter === 'out') {
                            matchesStatus = product.quantity === 0;
                        }
                        
                        return matchesSearch && matchesStatus;
                    });
                }
                try {
                    console.log('Rendering products table with', productsList.length, 'products');
                    
                    // Store the filtered products for pagination
                    this.filteredProducts = productsList;
                    
                    // Calculate pagination
                    const startIndex = (this.currentPage.products - 1) * this.itemsPerPage;
                    const endIndex = startIndex + this.itemsPerPage;
                    const paginatedProducts = productsList.slice(startIndex, endIndex);
                    
                    // Clear the table
                    this.tables.products.innerHTML = '';
                    
                    // Handle empty state
                    if (paginatedProducts.length === 0) {
                        this.tables.products.innerHTML = `
                            <tr>
                                <td colspan="6" class="empty-state">
                                    <i class="fas fa-box-open"></i>
                                    <h3>لا توجد منتجات متاحة</h3>
                                    <p>استخدم زر "إضافة منتج جديد" لإضافة منتجات إلى المخزون</p>
                                </td>
                            </tr>`;
                        this.pagination.products.style.display = 'none';
                        return;
                    }
                    
                    // Render product rows
                    paginatedProducts.forEach((product, index) => {
                        const row = document.createElement('tr');
                        const rowNumber = startIndex + index + 1;
                        
                        // Determine status class and text
                        let statusClass, statusText;
                        if (product.quantity === 0) {
                            statusClass = 'status-danger';
                            statusText = 'منتهي';
                        } else if (product.quantity <= 10) {
                            statusClass = 'status-warning';
                            statusText = 'كمية منخفضة';
                        } else {
                            statusClass = 'status-success';
                            statusText = 'متوفر';
                        }
                        
                        row.innerHTML = `
                            <td>${rowNumber}</td>
                            <td>${product.name || 'غير معروف'}</td>
                            <td>${(product.balance || 0).toFixed(2)} ج.م</td>
                            <td>${product.quantity}</td>
                            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                            <td class="actions">
                                <button class="action-btn edit" data-id="${product.id}" title="تعديل">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="action-btn history" data-id="${product.id}" title="سجل المنتج">
                                    <i class="fas fa-history"></i>
                                </button>
                            </td>
                        `;
                        
                        // Add event listeners
                        const editBtn = row.querySelector('.edit');
                        const historyBtn = row.querySelector('.history');
                        
                        if (editBtn) {
                            editBtn.addEventListener('click', (e) => {
                                e.stopPropagation();
                                this.openProductModal(product.id);
                            });
                        }
                        
                        if (historyBtn) {
                            historyBtn.addEventListener('click', (e) => {
                                e.stopPropagation();
                                console.log('History button clicked for product ID:', product.id);
                                this.showProductHistory(product.id);
                            });
                        }
                        
                        this.tables.products.appendChild(row);
                    });
                
                    // Update pagination
                    this.renderPagination('products', productsList.length);
                } catch (error) {
                    console.error('Error rendering products table:', error);
                    this.showAlert('حدث خطأ أثناء عرض المنتجات', 'error');
                }
            }
            
            renderInvoicesTable(invoices = null) {
                // If no invoices provided, use filtered invoices
                if (!invoices) {
                    const { searchTerm, statusFilter } = this.filterStates.invoices || { searchTerm: '', statusFilter: 'all' };
                    invoices = this.invoices.filter(invoice => {
                        // Check if the invoice matches the search term
                        const matchesSearch = 
                            !searchTerm || // If search is empty, match all
                            (invoice.id && invoice.id.toLowerCase().includes(searchTerm)) ||
                            (invoice.customer && typeof invoice.customer === 'string' && invoice.customer.toLowerCase().includes(searchTerm)) ||
                            (invoice.customer && typeof invoice.customer === 'object' && 
                             invoice.customer.name && invoice.customer.name.toLowerCase().includes(searchTerm)) ||
                            (invoice.date && invoice.date.toString().includes(searchTerm));
                            
                        // Check if the invoice matches the status filter
                        let matchesStatus = true;
                        if (statusFilter === 'paid') {
                            matchesStatus = (invoice.status === 'paid' || invoice.paid === true);
                        } else if (statusFilter === 'unpaid') {
                            matchesStatus = (invoice.status === 'unpaid' || invoice.paid === false);
                            // Only consider undefined as unpaid if status is also not 'paid'
                            if (invoice.paid === undefined && invoice.status !== 'paid') {
                                matchesStatus = true;
                            } else if (invoice.paid === undefined) {
                                matchesStatus = false;
                            }
                        }
                        
                        return matchesSearch && matchesStatus;
                    });
                }
                console.log('renderInvoicesTable called with:', { hasInvoices: !!invoices });
                const tbody = document.getElementById('invoices-table-body');
                if (!tbody) {
                    console.error('Invoices table body not found');
                    return;
                }
                
                // Clear existing rows
                tbody.innerHTML = '';
                
                // Use provided invoices or all invoices
                const invoicesToRender = invoices || this.invoices;
                
                // Sort invoices by date (newest first)
                const sortedInvoices = [...invoicesToRender].sort((a, b) => 
                    new Date(b.date || 0) - new Date(a.date || 0)
                );
                
                // Calculate pagination
                const startIndex = (this.currentPage.invoices - 1) * this.itemsPerPage;
                const endIndex = startIndex + this.itemsPerPage;
                const paginatedInvoices = sortedInvoices.slice(startIndex, endIndex);
                
                if (paginatedInvoices.length === 0) {
                    const noResultsHtml = `
                        <tr>
                            <td colspan="6" class="text-center py-4">
                                <div class="empty-state">
                                    <i class="fas fa-file-invoice"></i>
                                    <h3>${invoices ? 'لا توجد فواتير متطابقة مع معايير البحث' : 'لا توجد فواتير'}</h3>
                                    <p>${invoices ? 'حاول تغيير كلمات البحث أو فلتر الحالة' : 'قم بإضافة فواتير جديدة لعرضها هنا'}</p>
                                </div>
                            </td>
                        </tr>`;
                    tbody.innerHTML = noResultsHtml;
                    return;
                }
                
                // Add invoice rows
                paginatedInvoices.forEach((invoice, index) => {
                    const row = document.createElement('tr');
                    const rowNumber = startIndex + index + 1;
                    
                    // Get customer name with proper fallback logic
                    let customerName = invoice.customerName || invoice.customersName || 'عميل';
                    if (invoice.customerId && customerName === 'undefined') {
                        const customer = this.getCustomer(invoice.customerId);
                        if (customer) {
                            customerName = customer.name || customerName;
                        }
                    }
                    
                    // Determine status
                    const isPaid = invoice.status === 'paid';
                    const statusText = isPaid ? 'مدفوعة' : 'غير مدفوعة';
                    const statusClass = isPaid ? 'status-success' : 'status-danger';
                    
                    // Format date
                    const formattedDate = invoice.date ? new Date(invoice.date).toLocaleDateString('ar-EG', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    }) : 'غير محدد';
                    
                    // Create row HTML with print button using the new class
                    row.innerHTML = `
                        <td>${rowNumber}</td>
                        <td>${customerName}</td>
                        <td>${formattedDate}</td>
                        <td>${(invoice.total || 0).toFixed(2)} ج.م</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td class="actions">
                            <button class="action-btn print-invoice-btn" 
                                    data-invoice-id="${invoice.id ?? invoice.invoiceNumber ?? ''}" 
                                    title="طباعة الفاتورة">
                                <i class="fas fa-print"></i>
                            </button>
                        </td>
                    `;
                    
                    row.addEventListener('mouseleave', () => {
                        row.style.backgroundColor = '';
                    });
                    
                    tbody.appendChild(row);
                    
                    // Print button click handler is now handled by event delegation in setupEventListeners
                });
                
                // Render pagination
                this.renderPagination('invoices', sortedInvoices.length);
            }
            
            showInvoiceDetails(invoice) {
                if (!invoice) return;
                
                // Format date
                const formattedDate = invoice.date ? new Date(invoice.date).toLocaleDateString('ar-EG', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                }) : 'غير محدد';
                
                // Get customer name with proper fallback logic
                let customerName = invoice.customerName || invoice.customersName || 'عميل';
                if (invoice.customerId && customerName === 'undefined') {
                    const customer = this.getCustomer(invoice.customerId);
                    if (customer) {
                        customerName = customer.name || customerName;
                    }
                }
                
                // Format status
                const isPaid = invoice.status === 'paid';
                const statusText = isPaid ? 'مدفوعة' : 'غير مدفوعة';
                const statusClass = isPaid ? 'status-success' : 'status-danger';
                
                // Create modal HTML
                const modalHtml = `
                    <div class="modal-overlay active" id="invoice-details-modal" style="z-index: 1050;">
                        <div class="modal" style="width: 95%; max-width: 1000px; max-height: 90vh; display: flex; flex-direction: column;">
                            <div class="modal-header" style="flex-shrink: 0; padding: 20px; border-bottom: 1px solid #eee;">
                                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                                    <h3 style="margin: 0; font-size: 1.5em; color: var(--primary);">
                                        <i class="fas fa-file-invoice ml-2"></i>
                                        تفاصيل الفاتورة #${invoice.id || ''}
                                    </h3>
                                    <button class="close-btn" id="close-invoice-details" style="background: none; border: none; font-size: 1.25em; cursor: pointer; color: #6c757d; padding: 5px;">
                                        <i class="fas fa-times"></i>
                                                    <div style="font-size: 0.9em; color: #6c757d; margin-bottom: 3px;">رقم الفاتورة</div>
                                                    <div style="font-weight: 500; font-size: 1.1em;">#${invoice.id || 'N/A'}</div>
                                                </div>
                                            </div>
                                            <div style="flex: 0 0 50%; max-width: 50%; padding: 0 10px;">
                                                <div style="margin-bottom: 8px; text-align: left;">
                                                    <div style="font-size: 0.9em; color: #6c757d; margin-bottom: 3px;">حالة الفاتورة</div>
                                                    <div style="font-weight: 500; font-size: 1.1em;">
                                                        <span class="${statusClass}" style="display: inline-flex; align-items: center; gap: 5px;">
                                                            <i class="fas ${isPaid ? 'fa-check-circle' : 'fa-clock'}"></i>
                                                            ${statusText}
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Invoice Items -->
                                <div class="card" style="margin-bottom: 25px; border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden;">
                                    <div class="card-header" style="background-color: #f8f9fa; padding: 15px 20px; border-bottom: 1px solid #e0e0e0;">
                                        <h4 style="margin: 0; font-size: 1.2em; color: var(--primary);">
                                            بنود الفاتورة
                                        </h4>
                                    </div>
                                    <div class="card-body" style="padding: 0;">
                                        <div class="table-responsive">
                                            <table style="width: 100%; border-collapse: collapse;">
                                                <thead>
                                                    <tr style="background-color: #f5f7fa;">
                                                        <th style="padding: 15px; text-align: right; border-bottom: 1px solid #e0e0e0; color: #5c6b7a; font-weight: 600; font-size: 0.9em;">المنتج</th>
                                                        <th style="padding: 15px; text-align: center; border-bottom: 1px solid #e0e0e0; color: #5c6b7a; font-weight: 600; font-size: 0.9em;">الكمية</th>
                                                        <th style="padding: 15px; text-align: left; border-bottom: 1px solid #e0e0e0; color: #5c6b7a; font-weight: 600; font-size: 0.9em;">السعر</th>
                                                        <th style="padding: 15px; text-align: left; border-bottom: 1px solid #e0e0e0; color: #5c6b7a; font-weight: 600; font-size: 0.9em;">الإجمالي</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${(invoice.items || []).map((item, index) => `
                                                        <tr style="background-color: ${index % 2 === 0 ? '#fff' : '#fafbfc'};">
                                                            <td style="padding: 15px; text-align: right; border-bottom: 1px solid #edf2f7;">
                                                                <div style="font-weight: 500; color: #2d3748;">${item.name || 'منتج غير معروف'}</div>
                                                                ${item.productId ? `<div style="font-size: 0.85em; color: #718096; margin-top: 3px;">${item.productId}</div>` : ''}
                                                            </td>
                                                            <td style="padding: 15px; text-align: center; border-bottom: 1px solid #edf2f7; color: #4a5568;">${item.quantity || 0}</td>
                                                            <td style="padding: 15px; text-align: left; border-bottom: 1px solid #edf2f7; color: #4a5568;">${(item.price || 0).toFixed(2)} ج.م</td>
                                                            <td style="padding: 15px; text-align: left; border-bottom: 1px solid #edf2f7; color: #2d3748; font-weight: 600;">${(item.total || 0).toFixed(2)} ج.م</td>
                                                        </tr>
                                                    `).join('')}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    </div>
                                    
                                    <!-- Invoice Summary -->
                                    <div class="card" style="border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden; margin-top: 20px;">
                                        <div class="card-body" style="padding: 20px;">
                                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px 0;">
                                                <span style="font-weight: 600; color: var(--primary); font-size: 1.2em;">الإجمالي النهائي:</span>
                                                <span style="font-weight: 700; color: var(--primary); font-size: 1.4em;">${(invoice.total || 0).toFixed(2)} ج.م</span>
                                            </div>
                                        </div>
                                    </div>
                                    </div>
                                </div>
                            </div>
                            </div>
                            </div>
                            <div class="modal-footer" style="padding: 15px; border-top: 1px solid #eee;">
                                <button class="btn btn-outline-secondary" id="close-invoice-details-btn">
                                    <i class="fas fa-times ml-1"></i> إغلاق
                                </button>
                                <button class="btn btn-primary print-invoice-btn" id="print-invoice-details" data-invoice-id="${invoice.id || ''}" style="display: inline-flex; align-items: center; gap: 5px;">
                                    <i class="fas fa-print"></i> طباعة الفاتورة
                                </button>
                            </div>
                    `;
                
                // Add modal to the DOM
                const modalContainer = document.createElement('div');
                modalContainer.innerHTML = modalHtml;
                document.body.appendChild(modalContainer);
                
                // Add event listeners
                const closeModal = () => {
                    document.body.removeChild(modalContainer);
                    document.removeEventListener('keydown', handleEscape);
                };
                
                const handleEscape = (e) => {
                    if (e.key === 'Escape') {
                        closeModal();
                    }
                };
                
                // Close buttons
                const closeButtons = [
                    modalContainer.querySelector('#close-invoice-details'),
                    modalContainer.querySelector('#close-invoice-details-btn')
                ];
                
                closeButtons.forEach(btn => {
                    if (btn) btn.addEventListener('click', closeModal);
                });
                
                // Print button click is now handled by event delegation in setupEventListeners
                
                // Add escape key listener
                document.addEventListener('keydown', handleEscape);
            }
            
            /**
             * Shows the supplier history modal with purchase history
             * @param {string} supplierId - The ID of the supplier
             */
            showSupplierHistory(supplierId) {
                if (!supplierId) {
                    console.error('No supplier ID provided to showSupplierHistory');
                    this.showAlert('معرف المورد غير صالح', 'error');
                    return;
                }
                
                console.log('showSupplierHistory called with ID:', supplierId);
                
                // Define closeModal function
                const closeModal = () => {
                    const modal = document.getElementById('supplier-history-modal');
                    if (modal && modal.parentNode) {
                        document.body.removeChild(modal);
                    }
                    document.removeEventListener('keydown', handleEscape);
                };

                // Handle escape key
                const handleEscape = (e) => {
                    if (e.key === 'Escape') {
                        closeModal();
                    }
                };

                try {
                    console.log('Creating loading modal...');
                    // Show loading state
                    const loadingHtml = `
                        <div class="modal-overlay active" id="supplier-history-modal">
                            <div class="modal" style="max-width: 800px;">
                                <div class="modal-header">
                                    <h3>جاري التحميل...</h3>
                                    <button class="close-btn" id="close-supplier-history">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <div class="modal-body" style="text-align: center; padding: 40px;">
                                    <div class="spinner" style="font-size: 2em; margin-bottom: 20px;">
                                        <i class="fas fa-spinner fa-spin"></i>
                                    </div>
                                    <p>جاري تحميل سجل المورد...</p>
                                </div>
                            </div>
                        </div>
                    `;

                    // Remove any existing supplier history modal
                    const existingModal = document.getElementById('supplier-history-modal');
                    if (existingModal && existingModal.parentNode) {
                        document.body.removeChild(existingModal);
                    }

                    // Add loading modal to the page
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = loadingHtml.trim();
                    const modalElement = tempDiv.firstChild;
                    document.body.appendChild(modalElement);

                    // Add event listener for close button
                    const closeButton = document.getElementById('close-supplier-history');
                    if (closeButton) {
                        closeButton.addEventListener('click', closeModal);
                    }

                    // Add escape key listener
                    document.addEventListener('keydown', handleEscape);

                    // Get supplier data
                    console.log('Fetching supplier with ID:', supplierId);
                    const supplier = this.getSupplier(supplierId);
                    console.log('Retrieved supplier:', supplier);
                    if (!supplier) {
                        console.error('Supplier not found with ID:', supplierId);
                        this.showAlert('المورد غير موجود', 'error');
                        closeModal();
                        return;
                    }

                    // Calculate totals
                    console.log('Processing supplier items history...');
                    const items = Array.isArray(supplier.transactions) ? supplier.transactions : [];
                    console.log('Supplier transactions:', items);
                    console.log(`Found ${items.length} items in history`);
                    
                    const totalPurchases = items.reduce((sum, item) => {
                        const quantity = parseFloat(item.quantity) || 0;
                        const price = parseFloat(item.price) || 0;
                        const itemTotal = quantity * price;
                        console.log(`Item: ${item.name || 'Unnamed'}, Qty: ${quantity}, Price: ${price}, Total: ${itemTotal}`);
                        return sum + itemTotal;
                    }, 0);
                    console.log('Total purchases:', totalPurchases);

                    const totalItems = items.reduce((sum, item) => {
                        const qty = parseFloat(item.quantity) || 0;
                        return sum + qty;
                    }, 0);
                    console.log('Total items:', totalItems);

                    // Log supplier transaction history in a clear format
                    console.log('%c=== سجل معاملات المورد ===', 'font-size: 16px; font-weight: bold; color: #2c3e50;');
                    console.log(`اسم المورد: ${supplier.name || 'غير معروف'}`);
                    console.log(`رقم الهاتف: ${supplier.phone || 'غير محدد'}`);
                    console.log(`عدد المعاملات: ${items.length}`);
                    console.log('----------------------------------------');

                    // Format items for display
                    const formattedItems = items.map(item => {
                        const itemDate = item.date ? new Date(item.date) : new Date();
                        const formattedDate = itemDate.toLocaleDateString('ar-EG', { 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric' 
                        });
                        const quantity = parseFloat(item.quantity) || 0;
                        const price = parseFloat(item.price) || 0;
                        const total = quantity * price;
                        
                        return {
                            ...item,
                            formattedDate,
                            quantity: quantity.toFixed(2),
                            price: price.toFixed(2),
                            total: total.toFixed(2)
                        };
                    }).sort((a, b) => new Date(b.date) - new Date(a.date));

                    // Create the modal HTML
                    const modalHtml = `
                        <div class="modal-overlay active" id="supplier-history-modal" style="padding: 20px; display: flex; align-items: flex-start; justify-content: center;">
                            <div class="modal" style="width: 100%; max-width: 1200px; margin: 0; height: auto; max-height: 90vh; display: flex; flex-direction: column;">
                                <div class="modal-header">
                                    <h3>سجل مشتريات من المورد: ${supplier.name || 'غير معروف'}</h3>
                                    <button class="close-btn" id="close-supplier-history">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <div class="modal-body" style="flex: 1; overflow: auto; padding: 0 20px;">
                                    <div class="supplier-info" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                        <div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 15px;">
                                            <div><strong>اسم المورد:</strong> ${supplier.name || 'غير معروف'}</div>
                                            <div><strong>رقم الهاتف:</strong> ${supplier.phone || 'غير محدد'}</div>
                                            <div><strong>إجمالي المعاملات:</strong> ${items.length}</div>
                                        </div>
                                    </div>
                                    
                                    <div class="transactions-list">
                                        <h4 style="margin: 15px 0; color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 8px;">
                                            سجل المعاملات
                                        </h4>
                                        ${formattedItems.length > 0 ? `
                                            <div class="table-responsive" style="width: 100%; overflow-x: auto;">
                                                <table class="table" style="min-width: 100%; table-layout: fixed; border-collapse: collapse;">
                                                    <thead>
                                                        <tr style="background-color: #f5f5f5;">
                                                            <th style="width: 15%; padding: 10px; text-align: right; border-bottom: 1px solid #ddd; white-space: nowrap;">التاريخ</th>
                                                            <th style="width: 30%; padding: 10px; text-align: right; border-bottom: 1px solid #ddd; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">اسم المنتج</th>
                                                            <th style="width: 15%; padding: 10px; text-align: right; border-bottom: 1px solid #ddd; white-space: nowrap;">الكمية</th>
                                                            <th style="width: 20%; padding: 10px; text-align: right; border-bottom: 1px solid #ddd; white-space: nowrap;">السعر</th>
                                                            <th style="width: 20%; padding: 10px; text-align: right; border-bottom: 1px solid #ddd; white-space: nowrap;">الإجمالي</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        ${formattedItems.map(item => `
                                                            <tr style="border-bottom: 1px solid #eee;">
                                                                <td style="width: 15%; padding: 10px; text-align: right; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${item.formattedDate || 'غير محدد'}</td>
                                                                <td style="width: 30%; padding: 10px; text-align: right; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${item.name || 'غير معروف'}">${item.name || 'غير معروف'}</td>
                                                                <td style="width: 15%; padding: 10px; text-align: right; white-space: nowrap;">${item.quantity}</td>
                                                                <td style="width: 20%; padding: 10px; text-align: right; white-space: nowrap;">${item.price} ج.م</td>
                                                                <td style="width: 20%; padding: 10px; text-align: right; font-weight: 500; white-space: nowrap;">${item.total} ج.م</td>
                                                            </tr>
                                                        `).join('')}
                                                    </tbody>
                                                </table>
                                            </div>
                                        ` : `
                                            <div class="alert alert-info" style="text-align: center; padding: 15px; background: #e7f5ff; color: #0c63e4; border-radius: 8px;">
                                                لا توجد معاملات مسجلة لهذا المورد
                                            </div>
                                        `}
                                    </div>
                                </div>
                                <div class="modal-footer" style="padding: 15px; border-top: 1px solid #eee; text-align: left; flex-shrink: 0;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                                        <div style="font-weight: 500; color: #555;">
                                            إجمالي المشتريات: <span style="color: var(--primary); font-weight: bold;">${totalPurchases.toFixed(2)} ج.م</span>
                                        </div>
                                        <div>
                                            <button class="btn btn-outline" id="close-supplier-history-btn" style="padding: 8px 20px; margin-left: 10px;">
                                                <i class="fas fa-times"></i> إغلاق
                                            </button>
                                            ${formattedItems.length > 0 ? `
                                                <button class="btn btn-primary" id="print-supplier-history" style="display: inline-flex; align-items: center; gap: 5px;">
                                                    <i class="fas fa-print"></i>
                                                    طباعة السجل
                                                </button>`
                                            : ''}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;

                    // Update the modal with actual content
                    console.log('Updating modal with formatted content...');
                    const modalContainer = document.getElementById('supplier-history-modal');
                    if (modalContainer) {
                        console.log('Found existing modal container, replacing content...');
                        modalContainer.outerHTML = modalHtml;
                        
                        // Add event listeners
                        console.log('Setting up event listeners...');
                        
                        // Close modal when clicking close button or overlay
                        const closeModalBtn = document.getElementById('close-supplier-history');
                        const closeModalBtn2 = document.getElementById('close-supplier-history-btn');
                        const printBtn = document.getElementById('print-supplier-history');
                        
                        if (closeModalBtn) {
                            closeModalBtn.addEventListener('click', closeModal);
                        }
                        
                        if (closeModalBtn2) {
                            closeModalBtn2.addEventListener('click', closeModal);
                        }
                        
                        if (printBtn) {
                            printBtn.addEventListener('click', () => {
                                window.print();
                            });
                        }
                        
                        // Close when clicking outside modal content
                        const modalOverlay = document.querySelector('#supplier-history-modal');
                        if (modalOverlay) {
                            modalOverlay.addEventListener('click', (e) => {
                                if (e.target === modalOverlay) {
                                    closeModal();
                                }
                            });
                        }
                        
                        console.log('Modal update complete');
                    } else {
                        console.error('Modal container not found!');
                    }

                } catch (error) {
                    console.error('Error showing supplier history:', error);
                    this.showAlert('حدث خطأ غير متوقع أثناء تحميل سجل المورد', 'error');
                    closeModal();
                }
            }

            setupSupplierHistoryEventListeners() {
                console.log('Setting up supplier history event listeners...');
                // Close modal function
                const closeModal = () => {
                    console.log('Closing supplier history modal...');
                    const modal = document.getElementById('supplier-history-modal');
                    if (modal) modal.remove();
                };

                // Close modal when clicking close button or overlay
                const closeBtn1 = document.getElementById('close-supplier-history');
                const closeBtn2 = document.getElementById('close-supplier-history-btn');
                
                console.log('Close button 1:', closeBtn1 ? 'Found' : 'Not found');
                console.log('Close button 2:', closeBtn2 ? 'Found' : 'Not found');
                
                closeBtn1?.addEventListener('click', () => {
                    console.log('Close button 1 clicked');
                    closeModal();
                });
                
                closeBtn2?.addEventListener('click', () => {
                    console.log('Close button 2 clicked');
                    closeModal();
                });
                
                // Close when clicking overlay (outside modal content)
                const overlay = document.querySelector('#supplier-history-modal .modal-overlay');
                console.log('Overlay element:', overlay ? 'Found' : 'Not found');
                if (overlay) {
                    overlay.addEventListener('click', (e) => {
                        console.log('Overlay clicked, checking if click is outside modal...');
                        if (e.target === e.currentTarget) {
                            console.log('Click is outside modal, closing...');
                            closeModal();
                        }
                    });
                }

                // Print functionality
                const printBtn = document.getElementById('print-supplier-history');
                console.log('Print button:', printBtn ? 'Found' : 'Not found');
                if (printBtn) {
                    printBtn.addEventListener('click', () => {
                        console.log('Print button clicked');
                        try {
                            window.print();
                            console.log('Print dialog opened successfully');
                        } catch (error) {
                            console.error('Error opening print dialog:', error);
                        }
                    });
                }

                // Close modal when pressing Escape key
                const handleEscKey = (e) => {
                    if (e.key === 'Escape') {
                        closeModal();
                        document.removeEventListener('keydown', handleEscKey);
                    }
                };
                document.addEventListener('keydown', handleEscKey);
            }
            
            showProductHistory(productId) {
    try {
        console.log('Showing product history for product ID:', productId);
        // Find the product in window.allProducts
        const product = window.allProducts.find(p => p.id === productId);
        if (!product) {
            console.error('Product not found with ID:', productId);
            this.showAlert('المنتج غير موجود', 'error');
            return null;
        }
        console.log('Product found:', product.name, product);

        // Get product history and sort by date (newest first)
        const productHistory = (product.productHistory || []).sort((a, b) => {
            const dateA = a.date ? new Date(a.date) : new Date(0);
            const dateB = b.date ? new Date(b.date) : new Date(0);
            return dateB - dateA; // Sort in descending order (newest first)
        });
        
        // Get balance history and sort by date (newest first)
        const balanceHistory = (product.balanceEditHistory || []).sort((a, b) => {
            const dateA = a.date ? new Date(a.date) : new Date(0);
            const dateB = b.date ? new Date(b.date) : new Date(0);
            return dateB - dateA; // Sort in descending order (newest first)
        });

        // Calculate total sales and quantities
        const totalSales = productHistory.reduce((sum, sale) => sum + (parseFloat(sale.total) || 0), 0);
        const totalQuantity = productHistory.reduce((sum, sale) => sum + (parseInt(sale.quantity) || 0), 0);
        
        // Format date for display
        const formatDate = (dateString) => {
            if (!dateString) return 'غير معروف';
            const date = new Date(dateString);
            return date.toLocaleDateString('ar-EG', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        };

        // Create modal HTML
        const modalHtml = `
            <div class="modal-overlay active" id="product-history-modal">
                <div class="modal" style="max-width: 900px; max-height: 90vh; display: flex; flex-direction: column;">
                    <div class="modal-header">
                        <h3>سجل المنتج: ${product.name}</h3>
                        <button class="close-btn" id="close-product-history">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body" style="flex: 1; overflow: auto;">
                        <div class="product-summary">
                            <div class="summary-item">
                                <span class="summary-label">الكمية الحالية:</span>
                                <span class="summary-value">${product.quantity || 0} وحدة</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">السعر الحالي:</span>
                                <span class="summary-value">${(product.balance || 0).toFixed(2)} ج.م</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">إجمالي المبيعات:</span>
                                <span class="summary-value">${totalQuantity} وحدة</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">إجمالي الإيرادات:</span>
                                <span class="summary-value">${totalSales.toFixed(2)} ج.م</span>
                            </div>
                        </div>

                        <div class="tabs">
                            <button class="tab-btn active" data-tab="transactions">المعاملات</button>
                            <button class="tab-btn" data-tab="prices">تعديلات الأسعار</button>
                        </div>

                        <div id="transactions-tab" class="tab-content" style="display: block;">
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>التاريخ</th>
                                            <th>العميل</th>
                                            <th>الكمية</th>
                                            <th>السعر</th>
                                            <th>الإجمالي</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${productHistory.length > 0 ? 
                                            productHistory.map(transaction => `
                                                <tr>
                                                    <td>${formatDate(transaction.date)}</td>
                                                    <td>${transaction.customerName || 'عميل'}</td>
                                                    <td>${transaction.quantity || 0}</td>
                                                    <td>${(transaction.price || 0).toFixed(2)} ج.م</td>
                                                    <td>${(transaction.total || 0).toFixed(2)} ج.م</td>
                                                </tr>
                                            `).join('') : 
                                            `<tr><td colspan="5" class="text-center py-3">لا توجد معاملات سابقة</td></tr>`
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
{{ ... }}

                        <div id="prices-tab" class="tab-content" style="display: none;">
                            ${balanceHistory.length > 0 ? `
                                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>التاريخ</th>
                                                <th>الكمية السابقة</th>
                                                <th>الكمية الجديدة</th>
                                                <th>السعر السابق</th>
                                                <th>السعر الجديد</th>
                                                <th>الفرق</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${balanceHistory.map(edit => {
                                                const priceDiff = (edit.newBalance || 0) - (edit.oldBalance || 0);
                                                const quantityDiff = (edit.newQuantity || 0) - (edit.oldQuantity || 0);
                                                return `
                                                    <tr>
                                                        <td>${formatDate(edit.date)}</td>
                                                        <td>${edit.oldQuantity || 0}</td>
                                                        <td>${edit.newQuantity || 0} 
                                                            ${quantityDiff > 0 ? `<span class="text-success">(+${quantityDiff})</span>` : 
                                                              quantityDiff < 0 ? `<span class="text-danger">(${quantityDiff})</span>` : ''}
                                                        </td>
                                                        <td>${(edit.oldBalance || 0).toFixed(2)} ج.م</td>
                                                        <td>${(edit.newBalance || 0).toFixed(2)} ج.م</td>
                                                        <td class="${priceDiff > 0 ? 'text-success' : priceDiff < 0 ? 'text-danger' : ''}">
                                                            ${priceDiff > 0 ? '+' : ''}${priceDiff !== 0 ? priceDiff.toFixed(2) : '0.00'} ج.م
                                                        </td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>` : 
                                `<div class="text-center py-3">لا توجد تعديلات سابقة على السعر</div>`
                            }
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-primary" id="print-product-history">
                            <i class="fas fa-print"></i> طباعة السجل
                        </button>
                        <button class="btn btn-secondary" id="close-product-history-btn">
                            <i class="fas fa-times"></i> إغلاق
                        </button>
                    </div>
                </div>
            </div>
        `;

        // Remove any existing modal
        const existingModal = document.getElementById('product-history-modal');
        if (existingModal) {
            existingModal.remove();
        }

        // Add modal to the body
        document.body.insertAdjacentHTML('beforeend', modalHtml);

        // Add event listeners
        const closeModal = () => {
            const modal = document.getElementById('product-history-modal');
            if (modal) {
                modal.remove();
            }
        };

        // Close modal when clicking outside content
        document.getElementById('product-history-modal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('product-history-modal')) {
                closeModal();
            }
        });

        // Close button
        document.getElementById('close-product-history')?.addEventListener('click', closeModal);
        document.getElementById('close-product-history-btn')?.addEventListener('click', closeModal);

        // Print button
        document.getElementById('print-product-history')?.addEventListener('click', () => {
            window.print();
        });

        // Tab switching
        const tabs = document.querySelectorAll('#product-history-modal .tab-btn');
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                // Remove active class from all tabs and contents
                tabs.forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
                
                // Add active class to clicked tab and show corresponding content
                tab.classList.add('active');
                const tabId = tab.getAttribute('data-tab');
                document.getElementById(`${tabId}-tab`).style.display = 'block';
            });
        });

        // Close modal when pressing Escape key
        const handleEscKey = (e) => {
            if (e.key === 'Escape') {
                closeModal();
                document.removeEventListener('keydown', handleEscKey);
            }
        };
        document.addEventListener('keydown', handleEscKey);
    } catch (error) {
        console.error('Error showing product history:', error);
        this.showAlert('حدث خطأ أثناء عرض سجل المنتج', 'error');
    }
}

            showCustomerBalanceHistory(customerId) {
                try {
                    const customer = this.getCustomer(customerId);
                    if (!customer) {
                        this.showAlert('العميل غير موجود', 'error');
                        return;
                    }

                    // Create modal HTML
                    const modalHtml = `
                        <div class="modal-overlay active" id="customer-balance-history-modal">
                            <div class="modal" style="width: auto; max-width: 90%;">
                                <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px;">
                                    <h3 style="margin: 0;">سجل معاملات الرصيد: ${customer.name}</h3>
                                    <div>
                                        <button class="close-btn" id="close-customer-balance-history" style="background: none; border: none; font-size: 1.5em; cursor: pointer; color: #666; padding: 5px 10px;">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="modal-body">
                                    <div class="customer-info" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <div><strong>الرصيد الحالي:</strong> ${(customer.balance || 0).toFixed(2)} ج.م</div>
                                            <button id="add-payment-btn" class="btn btn-primary" style="padding: 6px 12px; font-size: 14px;">
                                                <i class="fas fa-plus-circle"></i> تسديد دفعة
                                            </button>
                                        </div>
                                        <div id="payment-form" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
                                            <div style="display: flex; gap: 10px; align-items: center;">
                                                <input type="number" id="customer-payment-amount" class="form-control" placeholder="المبلغ" min="0.01" step="0.01" style="flex: 1;">
                                                <button id="save-payment-btn" class="btn btn-success" style="white-space: nowrap;">
                                                    <i class="fas fa-check"></i> حفظ
                                                </button>
                                                <button id="cancel-payment-btn" class="btn btn-outline-secondary">
                                                    <i class="fas fa-times"></i> إلغاء
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="balance-history" style="width: 100%;">
                                        <h4 style="margin: 20px 0 15px; color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 8px; text-align: right; white-space: nowrap; width: 100%;">
                                            سجل حركات الرصيد
                                        </h4>
                                        <div style="max-height: 400px; overflow-y: auto;">
                                            <table class="table" style="width: 100%; border-collapse: collapse;">
                                                <thead>
                                                    <tr style="background-color: #f8f9fa;">
                                                        <th style="padding: 12px; text-align: right; width: 30%;">التاريخ</th>
                                                        <th style="padding: 12px; text-align: left; width: 30%;">المبلغ</th>
                                                        <th style="padding: 12px; text-align: left; width: 40%;">الرصيد</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${(() => {
                                                        const history = customer.balanceHistory || [];
                                                        if (history.length === 0) {
                                                            return `
                                                                <tr>
                                                                    <td colspan="3" style="text-align: center; padding: 20px; color: #666;">
                                                                        <i class="fas fa-exchange-alt" style="font-size: 1.5em; margin-bottom: 10px; opacity: 0.5; display: block;"></i>
                                                                        لا توجد معاملات سابقة لهذا العميل
                                                                    </td>
                                                                </tr>`;
                                                        }

                                                        // Sort history by date (oldest first for running balance calculation)
                                                        const sortedHistory = [...history].sort((a, b) => {
                                                            const dateA = a.date ? new Date(a.date) : new Date(0);
                                                            const dateB = b.date ? new Date(b.date) : new Date(0);
                                                            return dateA - dateB; // Sort ascending (oldest first)
                                                        });
                                                        
                                                        // Calculate running balance
                                                        let runningBalance = 0;
                                                        const entriesWithBalance = sortedHistory.map(entry => {
                                                            const amount = parseFloat(entry.amount) || 0;
                                                            runningBalance += amount;
                                                            return {
                                                                ...entry,
                                                                runningBalance: runningBalance
                                                            };
                                                        }).reverse(); // Reverse to show newest first
                                                        
                                                        // Build rows
                                                        return entriesWithBalance.map(entry => {
                                                            const entryDate = entry.date ? new Date(entry.date) : new Date();
                                                            const day = entryDate.getDate();
                                                            const month = entryDate.getMonth() + 1;
                                                            const year = entryDate.getFullYear();
                                                            
                                                            const toArabicNumeral = num => {
                                                                const arabicNumerals = ['٠', '١', '٢', '٣', '٤', '٥', '٦', '٧', '٨', '٩'];
                                                                return num.toString().replace(/\d/g, d => arabicNumerals[d]);
                                                            };
                                                            
                                                            const formattedDate = `${toArabicNumeral(day)}/${toArabicNumeral(month)}/${toArabicNumeral(year)}`;
                                                            const amount = parseFloat(entry.amount) || 0;
                                                            const amountClass = amount >= 0 ? 'text-success' : 'text-danger';
                                                            const amountSign = amount >= 0 ? '+' : '';
                                                            const balanceClass = entry.runningBalance >= 0 ? 'text-success' : 'text-danger';
                                                            
                                                            return `
                                                                <tr style="border-bottom: 1px solid #eee;">
                                                                    <td style="padding: 12px; text-align: right; white-space: nowrap;">${formattedDate}</td>
                                                                    <td style="padding: 12px; text-align: left; white-space: nowrap;" class="${amountClass}">
                                                                        ${amountSign}${Math.abs(amount).toFixed(2)} ج.م
                                                                    </td>
                                                                    <td style="padding: 12px; text-align: left; white-space: nowrap;" class="${balanceClass}">
                                                                        ${entry.runningBalance.toFixed(2)} ج.م
                                                                    </td>
                                                                </tr>`;
                                                        }).join('');
                                                    })()}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer" style="padding: 15px; border-top: 1px solid #eee; margin-top: 0;">
                                    <button id="close-customer-balance-history-footer" class="btn btn-secondary" style="margin-right: auto;">
                                        <i class="fas fa-times"></i> إغلاق
                                    </button>
                                </div>
                            </div>
                        </div>`;

                    // Add modal to the DOM
                    document.body.insertAdjacentHTML('beforeend', modalHtml);

                    // Add close functionality
                    const closeModal = () => {
                        const modal = document.getElementById('customer-balance-history-modal');
                        if (modal) {
                            modal.remove();
                            document.removeEventListener('keydown', handleEsc);
                            modal.removeEventListener('click', handleOutsideClick);
                        }
                    };

                    // Handle Escape key
                    const handleEsc = (e) => {
                        if (e.key === 'Escape') {
                            closeModal();
                        }
                    };

                    // Handle click outside modal
                    const handleOutsideClick = (e) => {
                        const modal = document.getElementById('customer-balance-history-modal');
                        if (e.target === modal) {
                            closeModal();
                        }
                    };

                    // Add event listeners
                    document.addEventListener('keydown', handleEsc);
                    const modalOverlay = document.getElementById('customer-balance-history-modal');
                    if (modalOverlay) {
                        modalOverlay.addEventListener('click', handleOutsideClick);
                    }

                    // Close buttons
                    const closeButtons = [
                        'close-customer-balance-history',
                        'close-customer-balance-history-footer'
                    ];

                    closeButtons.forEach(btnId => {
                        const btn = document.getElementById(btnId);
                        if (btn) {
                            btn.addEventListener('click', closeModal);
                        }
                    });

                    // Prevent clicks inside modal from closing it
                    const modalContent = modalOverlay?.querySelector('.modal');
                    if (modalContent) {
                        modalContent.addEventListener('click', (e) => {
                            e.stopPropagation();
                        });
                    }

                    // Add payment button functionality
                    const addPaymentBtn = document.getElementById('add-payment-btn');
                    const paymentForm = document.getElementById('payment-form');
                    const paymentAmount = document.getElementById('customer-payment-amount');
                    const paymentDescription = document.getElementById('customer-payment-description');
                    const savePaymentBtn = document.getElementById('save-payment-btn');
                    const cancelPaymentBtn = document.getElementById('cancel-payment-btn');
                    
                    if (addPaymentBtn) {
                        addPaymentBtn.addEventListener('click', () => {
                            paymentForm.style.display = 'block';
                            addPaymentBtn.style.display = 'none';
                            paymentAmount.focus();
                        });
                    }
                    
                    if (cancelPaymentBtn) {
                        cancelPaymentBtn.addEventListener('click', () => {
                            paymentForm.style.display = 'none';
                            addPaymentBtn.style.display = 'block';
                            paymentAmount.value = '';
                            if (paymentDescription) paymentDescription.value = '';
                        });
                    }
                    
                    if (savePaymentBtn) {
                        savePaymentBtn.addEventListener('click', () => {
                            const amount = parseFloat(paymentAmount.value);
                            
                            if (isNaN(amount) || amount <= 0) {
                                this.showAlert('الرجاء إدخال مبلغ صحيح أكبر من الصفر', 'error');
                                return;
                            }
                            
                            try {
                                // Update customer balance (subtract payment)
                                customer.balance = (parseFloat(customer.balance) || 0) - amount;
                                
                                // Add to balance history
                                if (!customer.balanceHistory) customer.balanceHistory = [];
                                customer.balanceHistory.push({
                                    amount: -amount, // Negative because it's a payment from client
                                    date: new Date().toISOString(),
                                    type: 'payment'
                                });
                                
                                // Save changes
                                this.saveData();
                                
                                // Reset form and update UI
                                paymentAmount.value = '';
                                if (paymentDescription) paymentDescription.value = '';
                                paymentForm.style.display = 'none';
                                addPaymentBtn.style.display = 'block';
                                
                                // Show success message
                                this.showAlert('تم تسجيل الدفعة بنجاح', 'success');
                                
                                // Close the current modal
                                const modal = document.getElementById('customer-balance-history-modal');
                                if (modal) modal.remove();
                                
                                // Reopen the modal to show updated balance and history
                                setTimeout(() => {
                                    this.showCustomerBalanceHistory(customerId);
                                }, 100);
                                
                            } catch (error) {
                                console.error('Error saving payment:', error);
                                this.showAlert('حدث خطأ أثناء حفظ الدفعة', 'error');
                            }
                        });
                    }
                    
                    // Close on Escape key
                    const handleCustomerBalanceEsc = (e) => {
                        if (e.key === 'Escape') {
                            const modal = document.getElementById('customer-balance-history-modal');
                            if (modal) modal.remove();
                            document.removeEventListener('keydown', handleCustomerBalanceEsc);
                        }
                    };
                    document.addEventListener('keydown', handleCustomerBalanceEsc);

                } catch (error) {
                    console.error('Error showing customer balance history:', error);
                    this.showAlert('حدث خطأ أثناء عرض سجل المعاملات', 'error');
                }
            }

            showCustomerHistory(customerId) {
                try {
                    const customer = this.getCustomer(customerId);
                    if (!customer) {
                        this.showAlert('العميل غير موجود', 'error');
                        return;
                    }

                    // Calculate total purchases amount
                    const totalPurchases = customer.purchases?.reduce((sum, invoice) => {
                        return sum + (parseFloat(invoice.total) || 0);
                    }, 0) || 0;

                    // Create modal HTML
                    const modalHtml = `
                        <div class="modal-overlay active" id="customer-history-modal">
                            <div class="modal" style="max-width: 800px;">
                                <div class="modal-header">
                                    <h3>سجل معاملات العميل: ${customer.name}</h3>
                                    <button class="close-btn" id="close-customer-history">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <div class="modal-body">
                                    <div class="customer-info" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                        <div style="display: flex; justify-content: space-between;">
                                            <div><strong>إجمالي المشتريات:</strong> ${customer.purchases?.length || 0}</div>
                                            <div><strong>سعر الحالي:</strong> ${(customer.balance || 0).toFixed(2)} ج.م</div>
                                        </div>
                                    </div>
                                    
                                    <div class="invoices-list">
                                        <h4 style="margin: 20px 0 15px; color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 8px;">
                                            الفواتير السابقة
                                        </h4>
                                        ${(() => {
                                            const purchases = customer.purchases || [];
                                            if (purchases.length === 0) {
                                                return `
                                                    <div class="no-invoices" style="text-align: center; padding: 30px; color: #666; background: #f9f9f9; border-radius: 8px; margin-top: 20px;">
                                                        <i class="fas fa-receipt" style="font-size: 2em; margin-bottom: 15px; opacity: 0.5;"></i>
                                                        <p style="margin: 0;">لا توجد فواتير سابقة لهذا العميل</p>
                                                    </div>`;
                                            }

                                            // Sort purchases by date (newest first)
                                            const sortedPurchases = [...purchases].sort((a, b) => {
                                                const dateA = a.date ? new Date(a.date) : new Date(0);
                                                const dateB = b.date ? new Date(b.date) : new Date(0);
                                                return dateB - dateA; // Sort descending (newest first)
                                            });

                                            return sortedPurchases.map((purchase, index) => {
                                                // Try to find the full invoice data from the main invoices array
                                                const fullInvoice = this.invoices.find(inv => inv.id === purchase.invoiceId || inv.id === purchase.id) || purchase;
                                                
                                                // Use purchase data as fallback if invoice data is missing some fields
                                                const invoice = {
                                                    ...purchase, // Include all purchase fields first
                                                    ...fullInvoice, // Then override with full invoice data if available
                                                    id: fullInvoice.id || purchase.id || `inv-${Date.now()}-${index}`,
                                                    date: fullInvoice.date || purchase.date || new Date().toISOString(),
                                                    items: fullInvoice.items || purchase.items || [],
                                                    total: fullInvoice.total !== undefined ? fullInvoice.total : (purchase.total || 0),
                                                    status: fullInvoice.status || purchase.status || 'unpaid'
                                                };

                                                const invoiceDate = invoice.date ? new Date(invoice.date) : new Date();
                                                const formattedDate = invoiceDate.toLocaleDateString('ar-EG', {
                                                    year: 'numeric',
                                                    month: 'long',
                                                    day: 'numeric',
                                                });
                                                
                                                const total = parseFloat(invoice.total) || 0;
                                                const status = invoice.status === 'paid' ? 'مدفوعة' : 'غير مدفوعة';
                                                const statusClass = invoice.status === 'paid' ? 'status-success' : 'status-danger';
                                                const showInvoiceId = invoice.id && !invoice.id.startsWith('inv-');
                                                
                                                return `
                                                <div class="invoice-card" style="margin-bottom: 15px; border: 1px solid #eee; border-radius: 8px; overflow: hidden;">
                                                    <div class="invoice-header" style="background: #f8f9fa; padding: 12px 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                                                        <div>
                                                            <span class="invoice-date" style="color: #666;">${formattedDate}</span>
                                                        </div>
                                                        <div style="display: flex; align-items: center; gap: 15px;">
                                                            <span class="invoice-total" style="font-weight: bold; color: var(--secondary);">${total.toFixed(2)} ج.م</span>
                                                            <span class="status-badge ${statusClass}" style="padding: 4px 12px; border-radius: 15px; font-size: 0.85em;">
                                                                ${status}
                                                            </span>
                                                        </div>
                                                    </div>
                                                    <div class="invoice-items" style="padding: 15px;">
                                                        <div style="margin-bottom: 10px; font-weight: 500; color: #555;">المنتجات:</div>
                                                        ${(invoice.items || []).map(item => {
                                                            const product = this.getProduct(item.productId || item.id) || {};
                                                            const itemName = item.name || product.name || item.productName || 'منتج غير معروف';
                                                            const quantity = parseInt(item.quantity) || 0;
                                                            const price = parseFloat(item.price || item.balance || 0);
                                                            const subtotal = quantity * price;
                                                            
                                                            return `
                                                                <div class="invoice-item" style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
                                                                    <span>${itemName}</span>
                                                                    <div style="display: flex; gap: 20px;">
                                                                        <span>${quantity} × ${price.toFixed(2)} ج.م</span>
                                                                        <span style="font-weight: bold;">${subtotal.toFixed(2)} ج.م</span>
                                                                    </div>
                                                                </div>`;
                                                        }).join('')}
                                                    </div>
                                                    <div class="invoice-actions" style="padding: 10px 15px; background: #f9f9f9; text-align: left; border-top: 1px solid #eee;">
                                                        <button class="btn btn-sm btn-outline print-invoice-history-btn" 
                                                                data-invoice='${JSON.stringify(invoice).replace(/'/g, '&#39;')}'
                                                                style="padding: 5px 15px; font-size: 0.9em;">
                                                            <i class="fas fa-print"></i> طباعة الفاتورة
                                                        </button>
                                                    </div>
                                                </div>`;
                                            }).join('');
                                        })()}
                                    </div>
                                </div>
                                <div class="modal-footer" style="padding: 15px; border-top: 1px solid #eee; text-align: left;">
                                    <button class="btn btn-outline" id="close-customer-history-btn" style="padding: 8px 20px;">
                                        <i class="fas fa-times"></i> إغلاق
                                    </button>
                                </div>
                                </div>
                            </div>
                        </div>
                    `;

                    // Remove any existing customer history modal
                    const existingModal = document.getElementById('customer-history-modal');
                    if (existingModal) {
                        existingModal.remove();
                    }

                    // Add modal to the page
                    document.body.insertAdjacentHTML('beforeend', modalHtml);

                    // Add event listeners for closing the modal
                    const closeModal = () => {
                        const modal = document.getElementById('customer-history-modal');
                        if (modal) modal.remove();
                    };

                    // Close modal when clicking close button or overlay
                    document.getElementById('close-customer-history')?.addEventListener('click', closeModal);
                    document.getElementById('close-customer-history-btn')?.addEventListener('click', closeModal);
                    document.querySelector('#customer-history-modal .modal-overlay')?.addEventListener('click', (e) => {
                        if (e.target === e.currentTarget) closeModal();
                    });

                    // Handle print button clicks
                    document.querySelectorAll('#customer-history-modal .print-invoice-history-btn').forEach(btn => {
                        btn.addEventListener('click', async (e) => {
                            e.stopPropagation();
                            try {
                                const invoice = JSON.parse(btn.getAttribute('data-invoice').replace(/&#39;/g, "'"));
                                if (invoice) {
                                    console.log('Printing invoice from history:', invoice);
                                    
                                    // Get the full invoice data if we only have a reference
                                    let fullInvoice = invoice;
                                    if (invoice.invoiceId && !invoice.items) {
                                        fullInvoice = this.getInvoice(invoice.invoiceId) || invoice;
                                    }
                                    
                                    // Ensure we have the customer data
                                    const customer = this.getCustomer(fullInvoice.customerId) || { 
                                        id: 'cash-customer',
                                        name: 'عميل',
                                        phone: 'N/A'
                                    };
                                    
                                    // Create a complete invoice object with all required fields
                                    const invoiceWithCustomer = {
                                        ...fullInvoice,
                                        customer: customer,
                                        customerName: customer.name,
                                        customerPhone: customer.phone || 'N/A',
                                        customerId: customer.id,
                                        items: fullInvoice.items || [],
                                        total: fullInvoice.total || 0,
                                        status: fullInvoice.status || 'unpaid',
                                        date: fullInvoice.date || new Date().toISOString().split('T')[0],
                                        id: fullInvoice.id || `inv-${Date.now()}`,
                                        invoiceId: fullInvoice.invoiceId || fullInvoice.id || `inv-${Date.now()}`
                                    };
                                    
                                    console.log('Printing invoice with data:', invoiceWithCustomer);
                                    await this.printInvoice(invoiceWithCustomer);
                                } else {
                                    this.showAlert('تعذر العثور على بيانات الفاتورة', 'error');
                                }
                            } catch (error) {
                                console.error('Error parsing invoice data:', error);
                                this.showAlert('حدث خطأ أثناء معالجة بيانات الفاتورة: ' + error.message, 'error');
                            }
                        });
                    });

                    // Close modal when pressing Escape key
                    document.addEventListener('keydown', function handleEscKey(e) {
                        if (e.key === 'Escape') {
                            closeModal();
                            document.removeEventListener('keydown', handleEscKey);
                        }
                    });

                } catch (error) {
                    console.error('Error showing customer history:', error);
                    this.showAlert('حدث خطأ أثناء عرض سجل العميل', 'error');
                }
            }

            renderCustomersTable(customersList = null) {
                const tbody = document.getElementById('customers-table-body');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                const customersToDisplay = customersList || this.customers;
                
                const start = (this.currentPage.customers - 1) * this.itemsPerPage;
                const end = start + this.itemsPerPage;
                const paginatedCustomers = customersToDisplay.slice(start, end);
                
                if (paginatedCustomers.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" class="text-center py-4">
                                <div class="empty-state">
                                    <i class="fas fa-users"></i>
                                    <h3>${customersList ? 'لا توجد نتائج' : 'لا يوجد عملاء'}</h3>
                                    <p>${customersList ? 'لم يتم العثور على عملاء يطابقون بحثك' : 'قم بإضافة عملاء جدد لعرضهم هنا'}</p>
                                </div>
                            </td>
                        </tr>`;
                    this.pagination.customers.style.display = 'none';
                    return;
                }
                
                paginatedCustomers.forEach((customer, index) => {
                    const row = document.createElement('tr');
                    const rowNumber = start + index + 1;
                    
                    // Format balance with proper styling based on value
                    let balanceText = '0.00';
                    let balanceClass = 'text-muted';
                    
                    if (customer.balance !== undefined && customer.balance !== null) {
                        const balance = parseFloat(customer.balance);
                        if (!isNaN(balance)) {
                            balanceText = Math.abs(balance).toFixed(2);
                            if (balance > 0) {
                                balanceClass = 'text-danger';
                                balanceText = `-${balanceText}`;
                            } else if (balance < 0) {
                                balanceClass = 'text-success';
                                balanceText = `+${Math.abs(balance).toFixed(2)}`;
                            }
                        }
                    }
                    
                    row.innerHTML = `
                        <td>${rowNumber}</td>
                        <td>${customer.name || 'غير معروف'}</td>
                        <td>${customer.phone || 'غير متوفر'}</td>
                        <td class="${balanceClass}">${balanceText} ج.م</td>
                        <td class="actions">
                            <button class="action-btn edit" data-id="${customer.id}" title="تعديل">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete" data-id="${customer.id}" title="حذف">
                                <i class="fas fa-trash"></i>
                            </button>
                            <button class="action-btn history" data-id="${customer.id}" title="سجل المشتريات">
                                <i class="fas fa-history"></i>
                            </button>
                            <button class="action-btn payment disabled" data-id="${customer.id}" title="سجل معاملات العميل">
                                <i class="fas fa-receipt"></i>
                            </button>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
                
                // Add event listeners to action buttons
                tbody.querySelectorAll('.edit').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.getAttribute('data-id');
                        this.openCustomerModal(id);
                    });
                });
                
                tbody.querySelectorAll('.delete').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const id = e.currentTarget.getAttribute('data-id');
                        this.showDeleteConfirmation(id, 'customer', 'هل أنت متأكد أنك تريد حذف هذا العميل؟');
                    });
                });
                
                tbody.querySelectorAll('.history').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const id = e.currentTarget.getAttribute('data-id');
                        this.showCustomerHistory(id);
                    });
                });
                
                tbody.querySelectorAll('.payment').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const id = e.currentTarget.getAttribute('data-id');
                        this.showCustomerBalanceHistory(id);
                    });
                });
                
                // Add search functionality
                const searchInput = document.getElementById('customer-search');
                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        const searchTerm = e.target.value.toLowerCase();
                        const filtered = this.customers.filter(customer => 
                            (customer.name && customer.name.toLowerCase().includes(searchTerm)) ||
                            (customer.phone && customer.phone.includes(searchTerm))
                        );
                        this.renderCustomersTable(filtered);
                    });
                }
                
                // Render pagination if not filtered
                if (!customersList) {
                    this.renderPagination('customers', this.customers.length);
                } else {
                    this.renderPagination('customers', customersList.length);
                }
            }
            
            renderSuppliersTable(filteredSuppliers = null) {
                console.log('renderSuppliersTable called with filteredSuppliers:', filteredSuppliers);
                const tbody = document.getElementById('suppliers-table-body');
                if (!tbody) {
                    console.error('Suppliers table body not found!');
                    return;
                }
                
                tbody.innerHTML = '';
                
                const suppliersToDisplay = filteredSuppliers || this.suppliers;
                console.log('Suppliers to display:', suppliersToDisplay);
                
                if (!suppliersToDisplay || !Array.isArray(suppliersToDisplay)) {
                    console.error('Invalid suppliers data:', suppliersToDisplay);
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="4" class="text-center py-4">
                                <div class="empty-state">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <h3>خطأ في تحميل بيانات الموردين</h3>
                                    <p>الرجاء تحديث الصفحة وحاول مرة أخرى</p>
                                </div>
                            </td>
                        </tr>`;
                    return;
                }
                
                const start = (this.currentPage.suppliers - 1) * this.itemsPerPage;
                const end = start + this.itemsPerPage;
                const paginatedSuppliers = suppliersToDisplay.slice(start, end);
                
                console.log('Paginated suppliers:', paginatedSuppliers);
                
                if (paginatedSuppliers.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="4" class="text-center py-4">
                                <div class="empty-state">
                                    <i class="fas fa-truck"></i>
                                    <h3>${filteredSuppliers ? 'لا توجد نتائج' : 'لا يوجد موردين'}</h3>
                                    <p>${filteredSuppliers ? 'لم يتم العثور على موردين بهذه المواصفات' : 'قم بإضافة موردين جدد لعرضهم هنا'}</p>
                                </div>
                            </td>
                        </tr>`;
                    return;
                }
                
                paginatedSuppliers.forEach((supplier, index) => {
                    const row = document.createElement('tr');
                    row.style.cursor = 'pointer';
                    row.title = 'انقر لعرض سجل المعاملات';
                    row.innerHTML = `
                        <td>${start + index + 1}</td>
                        <td>${supplier.name}</td>
                        <td>${supplier.phone}</td>
                        <td class="actions">
                            <button class="action-btn edit" data-id="${supplier.id}" title="تعديل">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete" data-id="${supplier.id}" title="حذف">
                                <i class="fas fa-trash"></i>
                            </button>
                            <button class="action-btn history" data-id="${supplier.id}" title="سجل المعاملات">
                                <i class="fas fa-history"></i>
                            </button>
                        </td>`;
                    tbody.appendChild(row);
                });
                
                // Add event listeners to action buttons
                tbody.querySelectorAll('.edit').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.getAttribute('data-id');
                        this.openSupplierModal(id);
                    });
                });
                
                tbody.querySelectorAll('.delete').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const id = e.currentTarget.getAttribute('data-id');
                        this.showDeleteConfirmation(id, 'supplier', 'هل أنت متأكد أنك تريد حذف هذا المورد؟');
                    });
                });
                
                tbody.querySelectorAll('.history').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const id = e.currentTarget.getAttribute('data-id');
                        this.showSupplierHistory(id);
                    });
                });
                
                // Add search functionality
                const searchInput = document.getElementById('supplier-search');
                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        const searchTerm = e.target.value.toLowerCase();
                        const filtered = this.suppliers.filter(supplier => 
                            supplier.name.toLowerCase().includes(searchTerm) ||
                            supplier.phone.includes(searchTerm)
                        );
                        this.renderSuppliersTable(filtered);
                    });
                }
                
                // Render pagination if not filtered
                if (!filteredSuppliers) {
                    this.renderPagination('suppliers', this.suppliers.length);
                }
            }
            
            renderPagination(type, totalItems) {
                // Apply filters before calculating total pages
                if (type === 'products') {
                    const { searchTerm, statusFilter } = this.filterStates.products;
                    if (searchTerm || statusFilter !== 'all') {
                        const filtered = this.products.filter(product => {
                            const matchesSearch = !searchTerm || 
                                product.name.toLowerCase().includes(searchTerm) ||
                                (product.description && product.description.toLowerCase().includes(searchTerm));
                            
                            let matchesStatus = true;
                            if (statusFilter === 'available') {
                                matchesStatus = product.quantity > 10;
                            } else if (statusFilter === 'low') {
                                matchesStatus = product.quantity > 0 && product.quantity <= 10;
                            } else if (statusFilter === 'out') {
                                matchesStatus = product.quantity === 0;
                            }
                            
                            return matchesSearch && matchesStatus;
                        });
                        totalItems = filtered.length;
                    }
                } else if (type === 'invoices') {
                    const { searchTerm, statusFilter } = this.filterStates.invoices;
                    if (searchTerm || statusFilter !== 'all') {
                        const filtered = this.invoices.filter(invoice => {
                            const matchesSearch = !searchTerm || 
                                (invoice.id && invoice.id.toLowerCase().includes(searchTerm)) ||
                                (invoice.customer && typeof invoice.customer === 'string' && invoice.customer.toLowerCase().includes(searchTerm)) ||
                                (invoice.customer && typeof invoice.customer === 'object' && 
                                 invoice.customer.name && invoice.customer.name.toLowerCase().includes(searchTerm)) ||
                                (invoice.date && invoice.date.toString().includes(searchTerm));
                                
                            let matchesStatus = true;
                            if (statusFilter === 'paid') {
                                matchesStatus = (invoice.status === 'paid' || invoice.paid === true);
                            } else if (statusFilter === 'unpaid') {
                                matchesStatus = (invoice.status === 'unpaid' || invoice.paid === false);
                                if (invoice.paid === undefined && invoice.status !== 'paid') {
                                    matchesStatus = true;
                                } else if (invoice.paid === undefined) {
                                    matchesStatus = false;
                                }
                            }
                            
                            return matchesSearch && matchesStatus;
                        });
                        totalItems = filtered.length;
                    }
                }
                const pagination = this.pagination[type];
                if (!pagination) return;
                
                const totalPages = Math.ceil(totalItems / this.itemsPerPage);
                
                pagination.innerHTML = '';
                
                if (totalPages <= 1) {
                    pagination.style.display = 'none';
                    return;
                }
                
                pagination.style.display = 'flex';
                
                // Ensure current page is within valid range
                if (this.currentPage[type] > totalPages) {
                    this.currentPage[type] = totalPages;
                }
                
                // Previous button
                const prevBtn = document.createElement('button');
                prevBtn.className = 'pagination-btn';
                prevBtn.disabled = this.currentPage[type] === 1;
                prevBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
                prevBtn.addEventListener('click', () => {
                    if (this.currentPage[type] > 1) {
                        this.currentPage[type]--;
                        this[`render${type.charAt(0).toUpperCase() + type.slice(1)}Table`]();
                        window.scrollTo(0, 0);
                    }
                });
                
                // Next button
                const nextBtn = document.createElement('button');
                nextBtn.className = 'pagination-btn';
                nextBtn.disabled = this.currentPage[type] === totalPages;
                nextBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
                nextBtn.addEventListener('click', () => {
                    if (this.currentPage[type] < totalPages) {
                        this.currentPage[type]++;
                        this[`render${type.charAt(0).toUpperCase() + type.slice(1)}Table`]();
                        window.scrollTo(0, 0);
                    }
                });
                
                // Page buttons
                const pageButtons = [];
                const maxPagesToShow = 5;
                let startPage, endPage;
                
                if (totalPages <= maxPagesToShow) {
                    startPage = 1;
                    endPage = totalPages;
                } else {
                    if (this.currentPage[type] <= Math.ceil(maxPagesToShow / 2)) {
                        startPage = 1;
                        endPage = maxPagesToShow;
                    } else if (this.currentPage[type] + Math.floor(maxPagesToShow / 2) >= totalPages) {
                        startPage = totalPages - maxPagesToShow + 1;
                        endPage = totalPages;
                    } else {
                        startPage = this.currentPage[type] - Math.floor(maxPagesToShow / 2);
                        endPage = this.currentPage[type] + Math.floor(maxPagesToShow / 2);
                    }
                }
                
                // Add page buttons
                for (let i = startPage; i <= endPage; i++) {
                    const pageBtn = document.createElement('button');
                    pageBtn.className = `pagination-btn ${i === this.currentPage[type] ? 'active' : ''}`;
                    pageBtn.textContent = i;
                    pageBtn.addEventListener('click', () => {
                        if (i !== this.currentPage[type]) {
                            this.currentPage[type] = i;
                            this[`render${type.charAt(0).toUpperCase() + type.slice(1)}Table`]();
                            window.scrollTo(0, 0);
                        }
                    });
                    pageButtons.push(pageBtn);
                }
                
                // Build pagination
                pagination.appendChild(prevBtn);
                
                // First page and ellipsis
                if (startPage > 1) {
                    const firstPageBtn = document.createElement('button');
                    firstPageBtn.className = 'pagination-btn';
                    firstPageBtn.textContent = '1';
                    firstPageBtn.addEventListener('click', () => {
                        this.currentPage[type] = 1;
                        this[`render${type.charAt(0).toUpperCase() + type.slice(1)}Table`]();
                        window.scrollTo(0, 0);
                    });
                    pagination.appendChild(firstPageBtn);
                    
                    if (startPage > 2) {
                        const ellipsis = document.createElement('span');
                        ellipsis.className = 'pagination-ellipsis';
                        ellipsis.textContent = '...';
                        pagination.appendChild(ellipsis);
                    }
                }
                
                // Page buttons
                pageButtons.forEach(btn => pagination.appendChild(btn));
                
                // Last page and ellipsis
                if (endPage < totalPages) {
                    if (endPage < totalPages - 1) {
                        const ellipsis = document.createElement('span');
                        ellipsis.className = 'pagination-ellipsis';
                        ellipsis.textContent = '...';
                        pagination.appendChild(ellipsis);
                    }
                    
                    const lastPageBtn = document.createElement('button');
                    lastPageBtn.className = 'pagination-btn';
                    lastPageBtn.textContent = totalPages;
                    lastPageBtn.addEventListener('click', () => {
                        this.currentPage[type] = totalPages;
                        this[`render${type.charAt(0).toUpperCase() + type.slice(1)}Table`]();
                        window.scrollTo(0, 0);
                    });
                    pagination.appendChild(lastPageBtn);
                }
                
                pagination.appendChild(nextBtn);
            }
            
            updateDashboard() {
                // Total products
                this.dashboardElements.totalProducts.textContent = this.products.length;
                
                // Monthly invoices (last 30 days)
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                
                const monthlyInvoices = this.invoices.filter(invoice => {
                    const invoiceDate = new Date(invoice.date);
                    return invoiceDate >= thirtyDaysAgo;
                });
                
                this.dashboardElements.monthlyInvoices.textContent = monthlyInvoices.length;
                
                // Low stock products (quantity <= 10)
                const lowStockProducts = this.products.filter(p => p.quantity > 0 && p.quantity <= 10);
                this.dashboardElements.lowStockCount.textContent = lowStockProducts.length;
                
                // Inventory value
                const inventoryValue = this.products.reduce((sum, p) => sum + (p.balance * p.quantity), 0);
                this.dashboardElements.inventoryValue.textContent = inventoryValue.toLocaleString('ar-EG') + ' ج.م';
                
                // Latest products (5 most recently added)
                const latestProducts = [...this.products]
                    .sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0))
                    .slice(0, 5);
                
                this.tables.latestProducts.innerHTML = '';
                
                if (latestProducts.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td colspan="5" class="p-0">
                            <div style="width: 100%; text-align: center; padding: 30px 20px; background: #f8f9fa; color: #6c757d;">
                                <i class="fas fa-box-open" style="font-size: 24px; margin-bottom: 8px; display: block;"></i>
                                <span>لا توجد منتجات متاحة</span>
                            </div>
                        </td>
                    `;
                    this.tables.latestProducts.appendChild(row);
                } else {
                    latestProducts.forEach(product => {
                        const row = document.createElement('tr');
                        
                        // Determine product status
                        let statusClass, statusText;
                        if (product.quantity === 0) {
                            statusClass = 'status-danger';
                            statusText = 'منتهي';
                        } else if (product.quantity <= 10) {
                            statusClass = 'status-warning';
                            statusText = 'كمية منخفضة';
                        } else {
                            statusClass = 'status-success';
                            statusText = 'متوفر';
                        }
                        
                        row.innerHTML = `
                            <td>${product.name}</td>
                            <td>${product.balance.toFixed(2)}</td>
                            <td class="${product.quantity === 0 ? 'no-stock' : (product.quantity <= 10 ? 'low-stock' : '')}">
                                ${product.quantity}
                            </td>
                            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                            <td class="actions">
                                <button class="action-btn edit" data-id="${product.id}" title="تعديل المنتج">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </td>
                        `;
                        
                        this.tables.latestProducts.appendChild(row);
                        
                        // Add edit event listener
                        row.querySelector('.action-btn.edit').addEventListener('click', (e) => {
                            e.stopPropagation();
                            this.openProductModal(product.id);
                        });
                    });
                }
                
                // Recent invoices (5 most recent)
                const recentInvoices = [...this.invoices]
                    .sort((a, b) => new Date(b.date) - new Date(a.date))
                    .slice(0, 5);
                
                this.tables.recentInvoices.innerHTML = '';
                
                if (recentInvoices.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td colspan="6" class="p-0">
                            <div style="width: 100%; text-align: center; padding: 30px 20px; background: #f8f9fa; color: #6c757d;">
                                <i class="fas fa-receipt" style="font-size: 24px; margin-bottom: 8px; display: block;"></i>
                                <span>لا توجد فواتير متاحة</span>
                            </div>
                        </td>
                    `;
                    this.tables.recentInvoices.appendChild(row);
                } else {
                    recentInvoices.forEach((invoice, index) => {
                        const row = document.createElement('tr');
                        const rowNumber = index + 1; // 1-based index
                        
                        // Format status
                        let statusClass = '';
                        let statusText = '';
                        
                        switch(invoice.status) {
                            case 'sales':
                                statusClass = 'status-info';
                                statusText = 'فاتورة مبيعات';
                                break;
                            case 'paid':
                                statusClass = 'status-success';
                                statusText = 'مدفوعة';
                                break;
                            case 'unpaid':
                                statusClass = 'status-danger';
                                statusText = 'غير مدفوعة';
                                break;
                            case 'partial':
                                statusClass = 'status-warning';
                                statusText = 'مدفوعة جزئياً';
                                break;
                            case 'pending':
                                statusClass = 'status-warning';
                                statusText = 'قيد المراجعة';
                                break;
                            default:
                                statusClass = 'status-secondary';
                                statusText = 'غير معروفة';
                        }
                        
                        // Get customer name, fallback to invoice.customer or 'عميل'
                        const customer = this.getCustomer(invoice.customerId) || { name: invoice.customer || 'عميل' };
                        
                        row.innerHTML = `
                            <td>${rowNumber}</td>
                            <td>${customer.name}</td>
                            <td>${invoice.date}</td>
                            <td>${invoice.total.toFixed(2)} ج.م</td>
                            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                            <td>
                                <button class="action-btn print-invoice-btn" data-id="${invoice.id}" title="طباعة">
                                    <i class="fas fa-print"></i>
                                </button>
                            </td>
                        `;
                        
                        this.tables.recentInvoices.appendChild(row);
                        
                        // Add print event listener to the button
                        row.querySelector('.print-invoice-btn').addEventListener('click', (e) => {
                            e.stopPropagation();
                            this.printInvoice(invoice.id);
                        });
                    });
                }
            }
            
            showAlert(message, type) {
                // Remove any existing alerts
                const existingAlert = document.querySelector('.alert');
                if (existingAlert) existingAlert.remove();
                
                // Create alert element
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type}`;
                alertDiv.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i>
                        <span>${message}</span>
                    </div>
                    <button class="close-alert">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                // Add alert to content area
                const contentArea = document.querySelector('.content-area');
                if (contentArea) {
                    contentArea.insertBefore(alertDiv, contentArea.firstChild);
                }
                
                // Add close event
                alertDiv.querySelector('.close-alert').addEventListener('click', () => {
                    alertDiv.remove();
                });
                
                // Auto-remove after 5 seconds
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.remove();
                    }
                }, 5000);
            }
            
            formatDate(dateString) {
                if (!dateString) return 'غير محدد';
                try {
                    let date;
                    if (typeof dateString === 'string') {
                        if (dateString.includes('T')) {
                            date = new Date(dateString);
                        } else {
                            const parts = dateString.split(/[-/]/);
                            if (parts.length === 3) {
                                if (parts[0].length === 4) {
                                    date = new Date(parts[0], parts[1] - 1, parts[2]);
                                } else {
                                    date = new Date(parts[2], parts[1] - 1, parts[0]);
                                }
                            } else {
                                date = new Date(dateString);
                            }
                        }
                    } else if (dateString instanceof Date) {
                        date = dateString;
                    } else {
                        return 'تنسيق تاريخ غير صالح';
                    }
                    
                    if (isNaN(date.getTime())) return 'تاريخ غير صالح';
                    
                    return date.toLocaleDateString('ar-EG', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        calendar: 'gregory'
                    });
                } catch (e) {
                    console.error('Error formatting date:', e);
                    return 'تاريخ غير صالح';
                }
            }

            /**
             * Displays the product history modal with transaction and price history
             * @param {string} productId - The ID of the product to show history for
             */
            showProductHistory(productId) {
                try {
                    if (!productId) {
                        console.error('No product ID provided');
                        this.showAlert('معرف المنتج غير صالح', 'error');
                        return;
                    }
                    
                    console.log('Showing product history for product ID:', productId);
                    
                    // Find the product in products array
                    const product = this.products.find(p => p.id === productId);
                    if (!product) {
                        console.error('Product not found with ID:', productId);
                        this.showAlert('المنتج غير موجود', 'error');
                        return;
                    }
                    
                    console.log('Product found:', { id: product.id, name: product.name });
            
                    // Process and sort product history
                    const productHistory = Array.isArray(product.productHistory) 
                        ? [...product.productHistory]
                            .filter(record => record && (record.date || record.quantity))
                            .sort((a, b) => {
                                try {
                                    const dateA = a.date ? new Date(a.date) : new Date(0);
                                    const dateB = b.date ? new Date(b.date) : new Date(0);
                                    return dateB - dateA; // Newest first
                                } catch (error) {
                                    console.error('Error sorting product history:', error);
                                    return 0;
                                }
                            })
                        : [];
                    
                    // Process and sort price history
                    let balanceHistory = [];
                    
                    // Check if balanceEditHistory exists, if not initialize it
                    if (!product.balanceEditHistory) {
                        product.balanceEditHistory = [];
                    }
                    
                    console.log('Raw balanceEditHistory:', JSON.parse(JSON.stringify(product.balanceEditHistory)));
                    
                    // Process all history entries, including those with the same date
                    if (Array.isArray(product.balanceEditHistory)) {
                        balanceHistory = [...product.balanceEditHistory]
                            .map((record, index) => ({
                                ...record,
                                // Ensure we have a unique key for each record
                                _id: `${record.date}_${index}_${record.balance}`
                            }))
                            .filter(record => {
                                const isValid = record && 
                                    record.balance !== undefined && 
                                    record.date && 
                                    !isNaN(new Date(record.date).getTime());
                                if (!isValid) {
                                    console.warn('Skipping invalid balance history record:', record);
                                }
                                return isValid;
                            })
                            // Sort by date in descending order (newest first)
                            .sort((a, b) => new Date(b.date) - new Date(a.date));
                        
                        // Add current balance if it's not already in history
                        if (product.balance !== undefined && 
                            !balanceHistory.some(r => r.balance === product.balance)) {
                            balanceHistory.unshift({
                                date: new Date().toISOString(),
                                balance: product.balance,
                                _id: `current_${Date.now()}`,
                                isCurrent: true
                            });
                        }
                    }
            
                    // Calculate totals with proper error handling
                    const totalSales = productHistory.reduce((sum, sale) => {
                        try {
                            return sum + (parseFloat(sale.total) || 0);
                        } catch (error) {
                            console.error('Error calculating total sales:', error);
                            return sum;
                        }
                    }, 0);
                    
                    const totalQuantity = productHistory.reduce((sum, sale) => {
                        try {
                            return sum + (parseInt(sale.quantity, 10) || 0);
                        } catch (error) {
                            console.error('Error calculating total quantity:', error);
                            return sum;
                        }
                    }, 0);
                    
                    // Get current stock and price with fallbacks
                    const currentStock = typeof product.quantity === 'number' ? product.quantity : 0;
                    const currentPrice = typeof product.balance === 'number' ? product.balance : 0;
            
                    // Create modal HTML
                    const modalHtml = `
                        <div class="modal-overlay active" id="product-history-modal">
                            <div class="modal" style="max-width: 1000px;">
                                <div class="modal-header">
                                    <h3>سجل المنتج: ${product.name}</h3>
                                    <button class="close-btn" id="close-product-history">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <div class="modal-body">
                                    <div class="product-info" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                        <div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 15px;">
                                            <div><strong>الكمية المتوفرة:</strong> ${currentStock.toLocaleString('ar-EG')} وحدة</div>
                                            <div><strong>إجمالي المبيعات:</strong> ${totalQuantity.toLocaleString('ar-EG')} وحدة</div>
                                            <div><strong>السعر الحالي:</strong> ${currentPrice.toLocaleString('ar-EG', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ج.م</div>
                                        </div>
                                    </div>
                                    
                                    <div class="tabs" style="margin-bottom: 20px;">
                                        <button class="tab-btn active" data-tab="transactions">المعاملات</button>
                                        <button class="tab-btn" data-tab="balance-history">تعديلات السعر</button>
                                    </div>
                                    
                                    <div id="transactions-tab" class="tab-content" style="display: block;">
                                        <h4 style="margin: 0 0 15px; color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 8px;">
                                            سجل المعاملات
                                        </h4>
                                        ${productHistory.length > 0 ? `
                                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                                <table class="data-table" style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                                                    <thead>
                                                        <tr style="background-color: #f8f9fa; position: sticky; top: 0; z-index: 1;">
                                                            <th style="padding: 12px; text-align: right; border-bottom: 1px solid #dee2e6;">التاريخ والوقت</th>
                                                            <th style="padding: 12px; text-align: right; border-bottom: 1px solid #dee2e6;">العميل</th>
                                                            <th style="padding: 12px; text-align: right; border-bottom: 1px solid #dee2e6;">الكمية</th>
                                                            <th style="padding: 12px; text-align: right; border-bottom: 1px solid #dee2e6;">سعر الوحدة</th>
                                                            <th style="padding: 12px; text-align: right; border-bottom: 1px solid #dee2e6;">الإجمالي</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        ${productHistory.map((transaction, index) => {
                                                            const formattedDate = this.formatDate(transaction.date);
                                                            
                                                            return `
                                                                <tr style="border-bottom: 1px solid #eee;" class="${index % 2 === 0 ? 'bg-light' : ''}">
                                                                    <td style="padding: 10px; text-align: right;">${formattedDate}</td>
                                                                    <td style="padding: 10px; text-align: right;">
                                                                        ${transaction.supplierName || transaction.customerName || 'غير محدد'}
                                                                    </td>
                                                                    <td style="padding: 10px; text-align: right; font-weight: bold; color: ${transaction.supplierId ? '#28a745' : (transaction.type === 'مرتجع' ? '#28a745' : '#dc3545')};">
                                                                        ${transaction.supplierId ? '+' : (transaction.type === 'مرتجع' ? '+' : '-')} ${(transaction.quantity || 0).toLocaleString('ar-EG')}
                                                                    </td>
                                                                    <td style="padding: 10px; text-align: right;">${(transaction.price || 0).toLocaleString('ar-EG', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ج.م</td>
                                                                    <td style="padding: 10px; text-align: right; font-weight: bold;">${(transaction.total || 0).toLocaleString('ar-EG', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ج.م</td>
                                                                </tr>
                                                            `;
                                                        }).join('')}
                                                    </tbody>
                                                </table>
                                            </div>
                                        ` : `
                                            <div class="alert alert-info" style="text-align: center; padding: 15px; background: #e7f5ff; color: #0c63e4; border-radius: 8px;">
                                                لا توجد معاملات مسجلة لهذا المنتج
                                            </div>
                                        `}
                                    </div>
                                    
                                    <div id="balance-history-tab" class="tab-content" style="display: none;">
                                        <h4 style="margin: 0 0 15px; color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 8px;">
                                            سجل تعديلات سعر المنتج
                                        </h4>
                                        ${balanceHistory.length > 0 ? `
                                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                                <table class="data-table" style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                                                    <thead>
                                                        <tr style="background-color: #f8f9fa; position: sticky; top: 0; z-index: 1;">
                                                            <th style="padding: 12px; text-align: right; border-bottom: 1px solid #dee2e6;">التاريخ</th>
                                                            <th style="padding: 12px; text-align: right; border-bottom: 1px solid #dee2e6;">سعر الوحدة</th>
                                                            <th style="padding: 12px; text-align: right; border-bottom: 1px solid #dee2e6;">التغيير</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        ${balanceHistory.map((record, index) => {
                                                            const formattedDate = this.formatDate(record.date);
                                                            
                                                            let priceDiff = 0;
                                                            let diffClass = '';
                                                            let diffSign = '';
                                                            
                                                            if (index < balanceHistory.length - 1) {
                                                                try {
                                                                    const currentBalance = parseFloat(record.balance);
                                                                    const previousBalance = parseFloat(balanceHistory[index + 1].balance);
                                                                    
                                                                    if (!isNaN(currentBalance) && !isNaN(previousBalance)) {
                                                                        priceDiff = currentBalance - previousBalance;
                                                                        diffClass = priceDiff > 0 ? 'text-danger' : priceDiff < 0 ? 'text-success' : '';
                                                                        diffSign = priceDiff > 0 ? '▲' : priceDiff < 0 ? '▼' : '';
                                                                        priceDiff = Math.abs(priceDiff).toFixed(2);
                                                                    }
                                                                } catch (error) {
                                                                    console.error('Error calculating price change:', error);
                                                                    priceDiff = 0;
                                                                    diffClass = '';
                                                                    diffSign = '';
                                                                }
                                                            }
                                                            
                                                            return `
                                                                <tr style="border-bottom: 1px solid #eee;" class="${index % 2 === 0 ? 'bg-light' : ''}">
                                                                    <td style="padding: 10px; text-align: right;">${formattedDate}</td>
                                                                    <td style="padding: 10px; text-align: right; font-weight: bold;">
                                                                        ${(record.balance || 0).toLocaleString('ar-EG', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ج.م
                                                                    </td>
                                                                    <td class="${diffClass}" style="padding: 10px; text-align: right; font-weight: bold;">
                                                                        ${index < balanceHistory.length - 1 ? `${diffSign} ${parseFloat(priceDiff).toLocaleString('ar-EG', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ج.م` : 'التسعيرة الأولى'}
                                                                    </td>
                                                                </tr>
                                                            `;
                                                        }).join('')}
                                                    </tbody>
                                                </table>
                                            </div>
                                        ` : `
                                            <div class="alert alert-info" style="text-align: center; padding: 15px; background: #e7f5ff; color: #0c63e4; border-radius: 8px;">
                                                لا توجد تعديلات على سعر هذا المنتج
                                            </div>
                                        `}
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button class="btn btn-primary" id="print-product-history">
                                        <i class="fas fa-print ml-1"></i> طباعة
                                    </button>
                                    <button class="btn btn-secondary" id="close-product-history-btn">
                                        <i class="fas fa-times ml-1"></i> إغلاق
                                    </button>
                                </div>
                                <style>
                                    .tab-btn {
                                        padding: 8px 20px;
                                        background: #f1f1f1;
                                        border: none;
                                        border-radius: 4px 4px 0 0;
                                        cursor: pointer;
                                        margin-left: 5px;
                                        transition: all 0.3s ease;
                                        font-weight: 500;
                                    }
                                    
                                    .tab-btn.active {
                                        background: var(--primary);
                                        color: white;
                                    }
                                    
                                    .tab-content {
                                        display: none;
                                    }
                                    
                                    .text-success {
                                        color: #28a745;
                                    }
                                    
                                    .text-danger {
                                        color: #dc3545;
                                    }
                                    
                                    .bg-light {
                                        background-color: rgba(0, 0, 0, 0.02);
                                    }
                                    
                                    .table-responsive::-webkit-scrollbar {
                                        height: 8px;
                                        width: 8px;
                                    }
                                    
                                    .table-responsive::-webkit-scrollbar-track {
                                        background: #f1f1f1;
                                        border-radius: 4px;
                                    }
                                    
                                    .table-responsive::-webkit-scrollbar-thumb {
                                        background: #888;
                                        border-radius: 4px;
                                    }
                                    
                                    .table-responsive::-webkit-scrollbar-thumb:hover {
                                        background: #555;
                                    }
                                </style>
                            </div>
                        </div>
                    `;
            
                    // Add modal to the DOM
                    document.body.insertAdjacentHTML('beforeend', modalHtml);
            
                    // Tab switching functionality
                    const tabButtons = document.querySelectorAll('#product-history-modal .tab-btn');
                    const tabContents = document.querySelectorAll('#product-history-modal .tab-content');
                    
                    tabButtons.forEach(button => {
                        button.addEventListener('click', () => {
                            // Remove active class from all buttons and contents
                            tabButtons.forEach(btn => btn.classList.remove('active'));
                            tabContents.forEach(content => content.style.display = 'none');
                            
                            // Add active class to clicked button
                            button.classList.add('active');
                            
                            // Show corresponding content
                            const tabId = button.getAttribute('data-tab');
                            document.querySelectorAll('.tab-content').forEach(content => {
                                content.style.display = 'none';
                            });
                            document.getElementById(`${tabId}-tab`).style.display = 'block';
                        });
                    });
            
                    // Close modal functionality
                    const closeProductHistoryModal = () => {
                        try {
                            const modal = document.getElementById('product-history-modal');
                            if (modal) {
                                // Remove event listeners first
                                const closeBtns = modal.querySelectorAll('#close-product-history, #close-product-history-btn');
                                closeBtns.forEach(btn => {
                                    if (btn) btn.removeEventListener('click', closeProductHistoryModal);
                                });
                                
                                const printBtn = modal.querySelector('#print-product-history');
                                if (printBtn) printBtn.removeEventListener('click', handlePrint);
                                
                                // Remove the modal
                                modal.remove();
                                document.removeEventListener('keydown', handleEscKey);
                                
                                // Clean up any remaining references
                                window.currentProductHistoryModal = null;
                            }
                        } catch (error) {
                            console.error('Error closing product history modal:', error);
                        }
                    };
            
                    // Close on Escape key
                    const handleEscKey = (e) => {
                        if (e.key === 'Escape') {
                            closeModal();
                            document.removeEventListener('keydown', handleEscKey);
                        }
                    };
                    
                    // Print functionality with better print styles
                    const handlePrint = () => {
                        try {
                            // Create a print-specific stylesheet
                            const printStyles = `
                                @media print {
                                    body * {
                                        visibility: hidden;
                                    }
                                    #product-history-modal,
                                    #product-history-modal * {
                                        visibility: visible;
                                    }
                                    #product-history-modal {
                                        position: absolute;
                                        left: 0;
                                        top: 0;
                                        width: 100%;
                                        max-width: 100%;
                                        margin: 0;
                                        padding: 20px;
                                    }
                                    .modal-header,
                                    .modal-footer {
                                        display: none !important;
                                    }
                                    .tab-btn {
                                        display: none !important;
                                    }
                                    .tab-content {
                                        display: block !important;
                                    }
                                }
                            `;
                            
                            // Add print styles
                            const style = document.createElement('style');
                            style.innerHTML = printStyles;
                            document.head.appendChild(style);
                            
                            // Trigger print after a short delay
                            setTimeout(() => {
                                window.print();
                                // Remove the style after printing
                                setTimeout(() => style.remove(), 1000);
                            }, 200);
                        } catch (error) {
                            console.error('Error printing product history:', error);
                            this.showAlert('حدث خطأ أثناء الطباعة', 'error');
                        }
                    };
                    
                    // Add close button event listeners
                    // Add close button event listeners
                    const closeModal = () => {
                        const modal = document.getElementById('product-history-modal');
                        if (modal) modal.remove();
                    };
                    
                    document.getElementById('close-product-history')?.addEventListener('click', closeModal);
                    document.getElementById('close-product-history-btn')?.addEventListener('click', closeModal);
            
                    // Close when clicking outside modal
                    document.querySelector('#product-history-modal .modal-overlay')?.addEventListener('click', (e) => {
                        if (e.target === e.currentTarget) {
                            closeModal();
                        }
                    });
            
                    // Add print button event listener
                    const printBtn = document.getElementById('print-product-history');
                    if (printBtn) {
                        printBtn.addEventListener('click', handlePrint);
                    }
            
                    // Store reference to modal
                    window.currentProductHistoryModal = document.getElementById('product-history-modal');
                    
                    return modalHtml;
                } catch (error) {
                    console.error('Error showing product history:', error);
                    this.showAlert('حدث خطأ أثناء عرض سجل المنتج', 'error');
                    return null;
                }
            }
            
            populateCustomerDropdown() {
                const customerSelect = document.getElementById('invoice-customer');
                if (customerSelect) {
                    // Clear existing options except the first one
                    while (customerSelect.options.length > 1) {
                        customerSelect.remove(1);
                    }
                    
                    // Create a copy of customers array and sort by Arabic name
                    const sortedCustomers = [...this.customers].sort((a, b) => 
                        (a.name || '').localeCompare(b.name || '', 'ar', {sensitivity: 'base'})
                    );
                    
                    // Add sorted customers to the dropdown
                    sortedCustomers.forEach(customer => {
                        const option = document.createElement('option');
                        option.value = customer.id;
                        option.textContent = customer.name;
                        customerSelect.appendChild(option);
                    });
                }
            }
        }

        // Function to check if data is empty (only contains empty arrays and metadata)
        function isDataEmpty(data) {
            // List of main data keys that should be checked
            const mainDataKeys = ['products', 'invoices', 'customers', 'suppliers'];
            
            // Check if all main data arrays are empty
            const hasData = mainDataKeys.some(key => 
                Array.isArray(data[key]) && data[key].length > 0
            );
            
            // Return true only if there's no data in any of the main arrays
            return !hasData;
        }

        // Function to save localStorage data as JSON file
        function saveLocalStorageAsJson() {
            try {
                const dataToSave = {};
                // Get all keys from localStorage
                const keys = Object.keys(localStorage);
                
                // Check if localStorage is empty
                if (keys.length === 0) {
                    console.log('localStorage is empty, skipping backup');
                    return false;
                }
                
                // Get all data from localStorage
                keys.forEach(key => {
                    try {
                        // Try to parse the value as JSON, if it fails store as is
                        dataToSave[key] = JSON.parse(localStorage[key]);
                    } catch (e) {
                        dataToSave[key] = localStorage[key];
                    }
                });
                
                // Check if the data is empty (only contains empty arrays and metadata)
                if (isDataEmpty(dataToSave)) {
                    console.log('No actual data to back up (only empty arrays and metadata)');
                    return false;
                }
                
                // Create a blob and download link
                const dataStr = JSON.stringify(dataToSave, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                
                // Create a timestamp for the filename
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                const filename = `localstorage_backup_${timestamp}.txt`;
                
                // Create and trigger download
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                return true;
            } catch (error) {
                console.error('Error saving localStorage as JSON:', error);
                return false;
            }
        }

        // Initialize the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            // Save localStorage data as JSON when the app loads
            saveLocalStorageAsJson();
            
            window.inventorySystem = new InventorySystem();
            
            // Initialize print invoice functionality
            window.printInvoice = new PrintInvoice();
            
            // Initialize reports page if it's the active page on load
            const reportsPage = document.getElementById('reports-page');
            if (reportsPage && window.getComputedStyle(reportsPage).display !== 'none') {
                console.log('Reports page is active, initializing...');
                window.updateReportsPage();
            }
            
            // Populate customer dropdown
            window.inventorySystem.populateCustomerDropdown();
            
            // Add event listener for the invoice modal to populate customer dropdown when opened
            const invoiceModal = document.getElementById('invoice-modal');
            if (invoiceModal) {
                invoiceModal.addEventListener('show.bs.modal', function () {
                    window.inventorySystem.populateCustomerDropdown();
                });
            }
            
            // Handle print button in invoice details modal
            const printDetailsBtn = document.getElementById('print-invoice-details');
            if (printDetailsBtn) {
                printDetailsBtn.addEventListener('click', async (e) => {
                    console.log('Print button clicked in invoice details modal');
                    e.preventDefault();
                    
                    try {
                        const modal = document.querySelector('#invoice-details-modal');
                        const invoiceId = modal?.querySelector('.modal-title')?.textContent?.match(/#(\S+)/)?.[1];
                        console.log('Extracted invoice ID:', invoiceId);
                        
                        if (!invoiceId) {
                            console.error('Could not extract invoice ID from modal');
                            return;
                        }
                        
                        // Get a fresh copy of the invoice data
                        let invoice = window.inventorySystem?.getInvoice(invoiceId);
                        if (!invoice) {
                            console.error('No invoice found with ID:', invoiceId);
                            return;
                        }
                        
                        console.log('Initial invoice data:', {
                            id: invoice.id,
                            hasCustomerId: !!invoice.customerId,
                            hasCustomerObject: !!invoice.customer,
                            customerPhoneInInvoice: invoice.customerPhone,
                            customerPhoneInCustomer: invoice.customer?.phone
                        });
                        
                        // Always ensure we have the customer data
                        if (invoice.customerId) {
                            console.log('Fetching customer data for ID:', invoice.customerId);
                            const customer = window.inventorySystem?.getCustomer(invoice.customerId);
                            console.log('Retrieved customer data:', customer);
                            
                            if (customer) {
                                // Create a new object with customer data included
                                invoice = {
                                    ...invoice,
                                    customer,
                                    // Ensure customerPhone is set from customer data if not already set
                                    customerPhone: invoice.customerPhone || customer.phone
                                };
                                console.log('Updated invoice with customer data:', {
                                    customerPhone: invoice.customerPhone,
                                    customer: !!invoice.customer
                                });
                            }
                        }
                        
                        console.log('Final invoice data before opening print modal:', {
                            id: invoice.id,
                            hasCustomerId: !!invoice.customerId,
                            hasCustomerObject: !!invoice.customer,
                            customerPhoneInInvoice: invoice.customerPhone,
                            customerPhoneInCustomer: invoice.customer?.phone
                        });
                        
                        // Use the inventory system's print method which handles customer data properly
                        window.inventorySystem.printInvoice(invoice.id);
                        
                    } catch (error) {
                        console.error('Error in print button handler:', error);
                        alert('حدث خطأ أثناء محاولة طباعة الفاتورة');
                    }
                });
            }
        });
    </script>
    
    <!-- Main application script -->
    <script>
        // Set up event listeners when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM fully loaded, initializing application...');
            
            // Set up click handler for all menu items
            document.querySelectorAll('.menu-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    // Prevent default behavior to avoid unwanted scrolling
                    e.preventDefault();
                    
                    const pageId = e.currentTarget.getAttribute('data-page');
                    console.log('Menu item clicked:', pageId);
                    
                    // Hide all pages
                    document.querySelectorAll('[id$="-page"]').forEach(page => {
                        page.style.display = 'none';
                    });
                    
                    // Show selected page and scroll to top
                    const selectedPage = document.getElementById(pageId);
                    if (selectedPage) {
                        selectedPage.style.display = 'block';
                        // Smooth scroll to top of the page
                        window.scrollTo({
                            top: 0,
                            behavior: 'smooth'
                        });
                    }
                    
                    // Update active menu item
                    document.querySelectorAll('.menu-item').forEach(menuItem => {
                        menuItem.classList.remove('active');
                    });
                    e.currentTarget.classList.add('active');
                });
            });
            
            // Show the dashboard by default
            const defaultPage = document.getElementById('dashboard-page');
            if (defaultPage) {
                defaultPage.style.display = 'block';
                document.querySelector('.menu-item[data-page="dashboard-page"]')?.classList.add('active');
            }
        });
    </script>

    <!-- Print Invoice Modal will be created dynamically by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Print invoice functionality
        class PrintInvoice {
            constructor() {
                this.printModal = document.getElementById('print-invoice-modal');
                this.printContainer = this.printModal ? this.printModal.querySelector('.modal-body') : null;
                this.closeBtn = document.getElementById('close-print-invoice-modal');
                this.printBtn = document.getElementById('print-invoice-btn');
                
                if (!this.printModal || !this.printContainer || !this.closeBtn || !this.printBtn) {
                    console.log('Creating print modal elements...');
                    this.createPrintModal();
                    // Re-initialize elements after creation
                    this.printModal = document.getElementById('print-invoice-modal');
                    this.printContainer = this.printModal ? this.printModal.querySelector('.modal-body') : null;
                    this.closeBtn = document.getElementById('close-print-invoice-modal');
                    this.printBtn = document.getElementById('print-invoice-btn');
                }
                
                this.setupEventListeners();
                console.log('PrintInvoice initialized successfully');
            }
            
            createPrintModal() {
                // Create the modal HTML
                const modalHTML = `
                    <div class="modal-overlay" id="print-invoice-modal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 9999;">
                        <div class="modal" style="background: white; border-radius: 8px; width: 90%; max-width: 900px; max-height: 90vh; display: flex; flex-direction: column;">
                            <div class="modal-header" style="padding: 15px 20px; background: #f8f9fa; color: #2c3e50; display: flex; justify-content: space-between; align-items: center; border-radius: 8px 8px 0 0;">
                                <h3 style="margin: 0;">معاينة الفاتورة</h3>
                                <button class="close-btn no-print" id="close-print-invoice-modal" style="background: none; border: none; color: #2c3e50; font-size: 1.2rem; cursor: pointer; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="modal-body" id="print-invoice-content" style="padding: 20px; overflow-y: auto; flex: 1;">
                                <!-- Invoice content will be inserted here -->
                            </div>
                            <!-- Modal Footer -->
                            <div class="modal-footer no-print" style="margin-top: 30px; padding-top: 15px; border-top: 1px solid #eee; display: flex; justify-content: flex-start; gap: 10px;">
                                <button id="print-invoice-btn" class="btn btn-primary" style="padding: 8px 20px; display: inline-flex; align-items: center;">
                                    <i class="fas fa-print" style="margin-left: 8px;"></i>
                                    طباعة الفاتورة
                                </button>
                                <button id="close-print-preview" class="btn btn-outline-secondary" style="padding: 8px 20px; display: inline-flex; align-items: center;">
                                    <i class="fas fa-times" style="margin-left: 8px;"></i>
                                    إغلاق النافذة
                                </button>
                            </div>
                        </div>`;
                    
                // Add the modal to the body
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                
                // Update references
                this.printModal = document.getElementById('print-invoice-modal');
                this.printContainer = document.getElementById('print-invoice-content');
                this.closeBtn = document.getElementById('close-print-invoice-modal');
                this.printBtn = document.getElementById('print-invoice-btn');
                
                // Set up event listeners
                this.setupEventListeners();
            }
            
            setupEventListeners() {
                // Remove any existing click listeners to prevent duplicates
                if (this._clickHandler) {
                    document.removeEventListener('click', this._clickHandler);
                }
                
                // Close modal when clicking outside content
                if (this.printModal) {
                    this.printModal.addEventListener('click', (e) => {
                        if (e.target === this.printModal) {
                            this.closeModal();
                        }
                    });
                }

                // Create a bound handler function that we can remove later
                this._clickHandler = (e) => {
                    // Handle close buttons
                    if (e.target.closest('#close-print-modal, #close-print-invoice-modal, #close-print-preview')) {
                        this.closeModal();
                        return;
                    }
                    
                    // Handle print button - only if not already handling a print
                    const printBtn = e.target.closest('#print-invoice-btn');
                    if (printBtn && !printBtn._isPrinting) {
                        printBtn._isPrinting = true;
                        this.handlePrint().finally(() => {
                            printBtn._isPrinting = false;
                        });
                        return;
                    }
                };
                
                // Add the event listener
                document.addEventListener('click', this._clickHandler);
                
                // Close on Escape key
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && this.printModal && this.printModal.classList.contains('active')) {
                        this.closeModal();
                    }
                });
            }
            
            handlePrint() {
                return new Promise((resolve, reject) => {
                    try {
                        if (!this.printContainer) {
                            throw new Error('Print container not found');
                        }
                        
                        // Close the modal first
                        this.closeModal();
                        
                        // Small delay to allow modal to close before printing
                        setTimeout(() => {
                            try {
                                // Create a print window
                                const printWindow = window.open('', '_blank');
                                if (!printWindow) {
                                    throw new Error('Failed to open print window');
                                }
                    
                                // Get the invoice HTML
                                const invoiceHTML = `
                                    <!DOCTYPE html>
                                    <html dir="rtl">
                                    <head>
                                        <meta charset="UTF-8">
                                        <title>طباعة الفاتورة</title>
                                        <style>
                                            @page { size: auto; margin: 10mm; }
                                            body { 
                                                font-family: Arial, sans-serif; 
                                                line-height: 1.6; 
                                                padding: 20px;
                                            }
                                            .print-page { 
                                                max-width: 800px; 
                                                margin: 0 auto; 
                                                padding: 20px; 
                                                border: 1px solid #eee;
                                            }
                                            .print-header { 
                                                text-align: center; 
                                                margin-bottom: 20px; 
                                                border-bottom: 2px solid #eee;
                                                padding-bottom: 20px;
                                            }
                                            .print-header h1 { 
                                                margin: 0 0 10px; 
                                                font-size: 24px; 
                                                color: #2c3e50;
                                            }
                                            .invoice-number, .invoice-date { 
                                                margin: 5px 0; 
                                                color: #666;
                                            }
                                            .invoice-status { 
                                                display: inline-block; 
                                                padding: 5px 15px; 
                                                border-radius: 4px; 
                                                font-weight: bold; 
                                                margin: 10px 0; 
                                                font-size: 14px;
                                            }
                                            .status-paid { 
                                                background-color: #d4edda; 
                                                color: #155724; 
                                            }
                                            .status-unpaid { 
                                                background-color: #f8d7da; 
                                                color: #721c24; 
                                            }
                                            .print-details { 
                                                margin: 20px 0; 
                                                padding: 15px;
                                                background: #f9f9f9;
                                                border-radius: 4px;
                                            }
                                            .detail-section { 
                                                margin-bottom: 15px; 
                                            }
                                            .detail-row { 
                                                display: flex; 
                                                margin: 8px 0; 
                                            }
                                            .detail-label { 
                                                font-weight: bold; 
                                                min-width: 120px;
                                                color: #555;
                                            }
                                            .detail-value {
                                                flex: 1;
                                            }
                                            .print-items { 
                                                width: 100%; 
                                                border-collapse: collapse; 
                                                margin: 20px 0; 
                                                font-size: 14px;
                                            }
                                            .print-items th, 
                                            .print-items td { 
                                                border: 1px solid #ddd; 
                                                padding: 10px; 
                                                text-align: right; 
                                            }
                                            .print-items th { 
                                                background-color: #f5f5f5; 
                                                font-weight: bold; 
                                            }
                                            .print-totals { 
                                                margin: 20px 0; 
                                                text-align: left; 
                                            }
                                            .totals-table { 
                                                width: 300px; 
                                                margin-left: auto; 
                                                border-collapse: collapse; 
                                            }
                                            .totals-table td { 
                                                padding: 10px; 
                                                border: 1px solid #ddd; 
                                            }
                                            .summary-total { 
                                                font-weight: bold; 
                                                background-color: #f5f5f5; 
                                            }
                                            .print-notes { 
                                                margin: 20px 0; 
                                                padding: 15px; 
                                                background-color: #f9f9f9; 
                                                border-right: 4px solid #3498db; 
                                                border-radius: 4px;
                                            }
                                            .print-footer { 
                                                margin-top: 40px; 
                                                text-align: center; 
                                                color: #666; 
                                                font-size: 14px; 
                                                padding-top: 20px;
                                                border-top: 1px solid #eee;
                                            }
                                            .print-timestamp { 
                                                font-size: 12px; 
                                                color: #999; 
                                                margin-top: 10px; 
                                            }
                                            @media print {
                                                body { 
                                                    -webkit-print-color-adjust: exact; 
                                                    padding: 0;
                                                    margin: 0;
                                                }
                                                .print-page {
                                                    border: none;
                                                    padding: 0;
                                                    margin: 0;
                                                }
                                                .no-print { 
                                                    display: none !important; 
                                                }
                                            }
                                        </style>
                                    </head>
                                    <body>
                                        <div class="print-page">
                                            ${this.printContainer.innerHTML}
                                        </div>
                                        <script>
                                            // Auto-print when the print window loads
                                            window.onload = function() {
                                                try {
                                                    window.print();
                                                    // Close the window after printing
                                                    setTimeout(function() {
                                                        window.close();
                                                    }, 100);
                                                } catch (e) {
                                                    console.error('Error during print:', e);
                                                }
                                            };
                                        <\/script>
                                    </body>
                                    </html>
                                `;
                                
                                // Write the HTML to the print window
                                printWindow.document.open();
                                printWindow.document.write(invoiceHTML);
                                printWindow.document.close();
                                
                                // Resolve the promise when the print window is closed
                                printWindow.onbeforeunload = function() {
                                    resolve();
                                };
                                
                            } catch (error) {
                                console.error('Error in print handler:', error);
                                reject(error);
                            }
                        }, 100);
                    } catch (error) {
                        console.error('Error in print setup:', error);
                        reject(error);
                    }
                });
            }
            
            openModal(invoiceData) {
                console.log('PrintInvoice.openModal called with data:', invoiceData);
                console.log('Customer phone data in openModal:', {
                    customerPhone: invoiceData?.customerPhone,
                    customer: invoiceData?.customer,
                    customerPhoneInCustomer: invoiceData?.customer?.phone
                });
                
                // Ensure modal and its elements exist
                if (!this.printModal || !this.printContainer) {
                    console.log('Creating print modal...');
                    this.createPrintModal();
                    
                    // Double check after creation
                    if (!this.printModal || !this.printContainer) {
                        console.error('Failed to create print modal or container');
                        return;
                    }
                }
                
                // Close customer transactions log if open
                const customerHistoryModal = document.getElementById('customer-history-modal');
                if (customerHistoryModal && window.getComputedStyle(customerHistoryModal).display !== 'none') {
                    customerHistoryModal.style.display = 'none';
                    document.body.style.overflow = ''; // Re-enable scrolling
                    console.log('Customer transactions log closed');
                }
                
                try {
                    // Generate the invoice HTML
                    const html = this.generateInvoiceHTML(invoiceData);
                    
                    // Clear and insert the HTML into the container
                    this.printContainer.innerHTML = '';
                    this.printContainer.insertAdjacentHTML('beforeend', html);
                    
                    // Show the modal with animation
                    this.printModal.style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                    
                    // Trigger reflow to ensure the display style is applied
                    void this.printModal.offsetWidth;
                    
                    // Add active class to trigger the animation
                    this.printModal.classList.add('active');
                    
                    // Ensure the modal is scrolled to the top
                    this.printModal.scrollTop = 0;
                    
                    // Focus the print button for better keyboard navigation
                    const printBtn = this.printModal.querySelector('#print-invoice-btn');
                    if (printBtn) {
                        console.log('Print button found, focusing...');
                        setTimeout(() => printBtn.focus(), 100);
                    } else {
                        console.warn('Print button not found in the modal');
                    }
                    
                } catch (error) {
                    console.error('Error opening print modal:', error);
                    alert('حدث خطأ أثناء فتح معاينة الفاتورة: ' + (error.message || 'خطأ غير معروف'));
                }
            }
            
            closeModal() {
                if (!this.printModal) return;
                
                // Remove active class to trigger fade out
                this.printModal.classList.remove('active');
                
                // After animation completes, hide the modal
                setTimeout(() => {
                    if (this.printModal) {
                        this.printModal.style.display = 'none';
                    }
                    document.body.style.overflow = '';
                }, 300);
            }
            
            formatDate(dateString) {
                if (!dateString) return 'غير محدد';
                try {
                    // Handle different date string formats
                    let date;
                    if (typeof dateString === 'string') {
                        // Try parsing ISO format first
                        if (dateString.includes('T')) {
                            date = new Date(dateString);
                        } else {
                            // Handle other date string formats (e.g., YYYY-MM-DD)
                            const parts = dateString.split(/[-/]/);
                            if (parts.length === 3) {
                                // Assume YYYY-MM-DD or DD/MM/YYYY format
                                if (parts[0].length === 4) {
                                    date = new Date(parts[0], parts[1] - 1, parts[2]);
                                } else {
                                    date = new Date(parts[2], parts[1] - 1, parts[0]);
                                }
                            } else {
                                date = new Date(dateString);
                            }
                        }
                    } else if (dateString instanceof Date) {
                        date = dateString;
                    } else {
                        return 'تنسيق تاريخ غير صالح';
                    }
                    
                    if (isNaN(date.getTime())) return 'تاريخ غير صالح';
                    
                    return date.toLocaleDateString('ar-EG', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        calendar: 'gregory'
                    });
                } catch (e) {
                    console.error('Error formatting date:', e);
                    return 'تاريخ غير صالح';
                }
            }
            
            generateInvoiceHTML(invoice) {
                console.log('Generating invoice HTML with data:', invoice);
        
                if (!invoice) {
                    console.error('No invoice data provided to generateInvoiceHTML');
                    return '<div class="error">لا توجد بيانات فاتورة متاحة</div>';
                }
        
                console.log('Customer data in invoice:', {
                    customerId: invoice.customerId,
                    customerName: invoice.customerName,
                    customerPhone: invoice.customerPhone,
                    hasCustomerObject: !!invoice.customer,
                    customerPhoneInCustomer: invoice.customer?.phone
                });
                
                const formatCurrency = (amount) => {
                    if (amount === undefined || amount === null || isNaN(amount)) return '0.00';
                    return parseFloat(amount).toFixed(2);
                };
                
                // Calculate subtotal from items if available, otherwise use the provided subtotal
                let subtotal = 0;
                if (invoice.items && Array.isArray(invoice.items) && invoice.items.length > 0) {
                    subtotal = invoice.items.reduce((sum, item) => {
                        const price = parseFloat(item.price || item.unitPrice || 0);
                        const quantity = parseInt(item.quantity || 0);
                        return sum + (price * quantity);
                    }, 0);
                } else if (invoice.products && Array.isArray(invoice.products) && invoice.products.length > 0) {
                    subtotal = invoice.products.reduce((sum, item) => {
                        const price = parseFloat(item.price || item.unitPrice || 0);
                        const quantity = parseInt(item.quantity || 0);
                        return sum + (price * quantity);
                    }, 0);
                } else {
                    subtotal = parseFloat(invoice.subtotal || 0);
                }
                
                const taxRate = parseFloat(invoice.taxRate || 0);
                const taxAmount = subtotal * (taxRate / 100);
                const total = parseFloat(invoice.total) || (subtotal + taxAmount);
                
                const items = Array.isArray(invoice.items) ? invoice.items : 
                              (Array.isArray(invoice.products) ? invoice.products : []);
                
                // Determine if this is a customer or supplier invoice
                const isSupplierInvoice = invoice.type === 'purchase' || invoice.supplierId;
                const title = isSupplierInvoice ? 'سجل معاملات المورد' : 'فاتورة مبيعات';
                const infoTitle = isSupplierInvoice ? 'معلومات المورد' : 'معلومات العميل';
                
                // Get customer/supplier information with better fallbacks
                let customerName = 'غير محدد';
                let customerPhone = 'غير محدد';
                
                // Priority 1: Use direct properties from invoice
                customerName = invoice.customerName || invoice.customer?.name || 'عميل';
                customerPhone = invoice.customerPhone || invoice.customer?.phone || 'N/A';
                
                // Priority 2: If we have customerId but no customer object, try to look it up
                if ((!customerName || customerName === 'غير محدد') && invoice.customerId) {
                    const customer = window.inventorySystem?.getCustomer(invoice.customerId);
                    if (customer) {
                        customerName = customer.name || customerName;
                        customerPhone = customer.phone || customerPhone;
                    }
                }
                
                // Priority 3: If we have a customer object, use it
                if (invoice.customer) {
                    customerName = invoice.customer.name || customerName;
                    customerPhone = invoice.customer.phone || customerPhone;
                }
                
                return `
                <div class="print-page" style="font-family: Arial, sans-serif; padding: 20px; max-width: 1000px; margin: 0 auto; direction: rtl;">
                    <!-- Header Section -->
                    <div style="text-align: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #3498db;">
                        <h1 style="color: #2c3e50; margin: 0 0 10px 0; font-size: 28px;">${title}</h1>
                        <div style="display: flex; justify-content: center; gap: 30px; margin-top: 15px; font-size: 14px;">
                            <div><strong>التاريخ:</strong> ${window.inventorySystem.formatDate(invoice.date)}</div>
                            <div><strong>الحالة:</strong> 
                                <span style="color: ${invoice.status === 'paid' || invoice.paid ? '#27ae60' : '#e74c3c'}; font-weight: bold;">
                                    ${invoice.status === 'paid' || invoice.paid ? 'مدفوعة' : 'غير مدفوعة'}
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Customer/Supplier Information -->
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px; border-right: 4px solid #3498db;">
                        <h3 style="margin: 0 0 10px 0; color: #2c3e50; font-size: 18px;">
                            <i class="fas fa-user-tie" style="margin-left: 8px;"></i>
                            ${infoTitle}
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px;">
                            <div><strong>الاسم:</strong> ${customerName}</div>
                            <div><strong>الهاتف:</strong> ${customerPhone}</div>
                            ${invoice.customerAddress ? `<div><strong>العنوان:</strong> ${invoice.customerAddress}</div>` : ''}
                        </div>
                    </div>

                    <!-- Items Table -->
                    <div style="margin: 25px 0; overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                            <thead>
                                <tr style="background-color: #f1f5f9;">
                                    <th style="padding: 12px; text-align: right; border: 1px solid #dee2e6; font-weight: 600;">المنتج</th>
                                    <th style="padding: 12px; text-align: center; border: 1px solid #dee2e6; font-weight: 600;">الكمية</th>
                                    <th style="padding: 12px; text-align: left; border: 1px solid #dee2e6; font-weight: 600;">سعر الوحدة</th>
                                    <th style="padding: 12px; text-align: left; border: 1px solid #dee2e6; font-weight: 600;">المجموع</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${items.map((item, index) => {
                                    const price = parseFloat(item.price || item.unitPrice || 0);
                                    const quantity = parseInt(item.quantity || 0);
                                    return `
                                        <tr style="${index % 2 === 0 ? 'background-color: #f8fafc;' : ''}">
                                            <td style="padding: 12px; border: 1px solid #dee2e6; text-align: right;">
                                                <div style="font-weight: 500;">${item.name || item.productName || 'عنصر غير معروف'}</div>
                                                ${item.code ? `<div style="font-size: 12px; color: #64748b;">الكود: ${item.code}</div>` : ''}
                                            </td>
                                            <td style="padding: 12px; border: 1px solid #dee2e6; text-align: center;">${quantity} ${item.unit || ''}</td>
                                            <td style="padding: 12px; border: 1px solid #dee2e6; text-align: left;">${formatCurrency(price)}</td>
                                            <td style="padding: 12px; border: 1px solid #dee2e6; text-align: left; font-weight: 500;">${formatCurrency(price * quantity)}</td>
                                        </tr>`;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>

                    <!-- Totals Section -->
                    <div style="margin: 20px 0; display: flex; justify-content: flex-start;">
                        <div style="width: 300px; margin-right: auto;">
                            <div style="display: flex; justify-content: space-between; padding: 10px 15px; background-color: #f8f9fa; font-weight: bold; font-size: 1.1em;">
                                <span>الإجمالي النهائي:</span>
                                <span>${formatCurrency(total)}</span>
                            </div>
                            ${invoice.paidAmount && invoice.paidAmount > 0 ? `
                            <div style="display: flex; justify-content: space-between; padding: 10px 15px; border-top: 1px solid #e9ecef; color: #27ae60;">
                                <span>المبلغ المدفوع:</span>
                                <span>${formatCurrency(invoice.paidAmount)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 10px 15px; font-weight: bold; color: #f39c12;">
                                <span>المتبقي:</span>
                                <span>${formatCurrency(total - (invoice.paidAmount || 0))}</span>
                            </div>` : ''}
                        </div>
                    </div>

                    <!-- Payment & Notes -->
                    <div style="margin-top: 30px; display: flex; flex-wrap: wrap; gap: 30px;">
                        ${invoice.paymentMethod ? `
                        <div style="flex: 1; min-width: 200px;">
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; border-right: 3px solid #3498db;">
                                <h4 style="margin: 0 0 10px 0; color: #2c3e50; font-size: 16px; display: flex; align-items: center;">
                                    <i class="fas fa-credit-card" style="margin-left: 8px;"></i>
                                    طريقة الدفع
                                </h4>
                                <p style="margin: 0;">
                                    ${invoice.paymentMethod === 'cash' ? 'نقداً' : 
                                      invoice.paymentMethod === 'card' ? 'بطاقة ائتمان' : 
                                      invoice.paymentMethod === 'bank' ? 'تحويل بنكي' : 
                                      invoice.paymentMethod}
                                </p>
                            </div>
                        </div>` : ''}
                        
                        ${invoice.notes ? `
                        <div style="flex: 2; min-width: 200px;">
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; border-right: 3px solid #3498db; height: 100%;">
                                <h4 style="margin: 0 0 10px 0; color: #2c3e50; font-size: 16px; display: flex; align-items: center;">
                                    <i class="fas fa-sticky-note" style="margin-left: 8px;"></i>
                                    ملاحظات
                                </h4>
                                <p style="margin: 0; white-space: pre-line;">${invoice.notes}</p>
                            </div>
                        </div>` : ''}
                    </div>

                    <!-- Footer -->
                    <div style="margin-top: 40px; padding-top: 15px; border-top: 1px solid #eee; text-align: center; color: #6b7280; font-size: 13px;">
                        <p style="margin: 5px 0; font-weight: 500;">
                            <i class="fas fa-store" style="margin-left: 8px;"></i>
                            ${invoice.storeName || 'متجرك'}
                        </p>
                        <p style="margin: 5px 0; display: flex; justify-content: center; align-items: center; gap: 10px;">
                            <span><i class="fas fa-phone" style="margin-left: 5px;"></i> ${invoice.storePhone || '01 234 5678'}</span>
                            ${invoice.storeEmail ? `<span><i class="fas fa-envelope" style="margin-right: 5px; margin-left: 15px;"></i> ${invoice.storeEmail}</span>` : ''}
                        </p>
                        <p style="margin: 10px 0 0 0; font-size: 12px; color: #9ca3af;">
                            شكراً لتعاملكم معنا - ${new Date().getFullYear()} ©
                        </p>
                    </div>
                </div>
                    </div>
                    
                </div>
                `;
            }
        }
        
        // Initialize print invoice functionality
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize PrintInvoice instance
            window.printInvoice = new PrintInvoice();
            
            // Handle print button clicks
            document.addEventListener('click', (e) => {
                const printBtn = e.target.closest('.print-invoice-btn, #print-invoice-details, #print-invoice, .btn-print');
                if (!printBtn) return;
                
                e.preventDefault();
                e.stopPropagation();
                
                // Handle different print button scenarios
                if (printBtn.classList.contains('print-invoice-btn') || printBtn.classList.contains('btn-print')) {
                    // Handle print buttons in the invoices list
                    const invoiceId = printBtn.dataset.invoiceId || printBtn.dataset.id;
                    if (invoiceId) {
                        window.inventorySystem?.printInvoice(invoiceId);
                    }
                } else if (printBtn.id === 'print-invoice-details' || printBtn.closest('#print-invoice-details')) {
                    // Handle print button in invoice details modal
                    const invoiceModal = document.querySelector('#invoice-details-modal');
                    if (invoiceModal) {
                        const invoiceId = invoiceModal.querySelector('.modal-header h3')?.textContent?.match(/#(\S+)/)?.[1];
                        if (invoiceId) {
                            // Get the invoice and ensure we have the latest data
                            const invoice = window.inventorySystem?.getInvoice(invoiceId);
                            if (invoice) {
                                // Create a copy of the invoice to avoid modifying the original
                                const invoiceToPrint = { ...invoice };
                                
                                // Ensure customer data is included
                                if (invoice.customerId && !invoiceToPrint.customer) {
                                    const customer = window.inventorySystem?.getCustomer(invoice.customerId);
                                    if (customer) {
                                        invoiceToPrint.customer = customer;
                                        invoiceToPrint.customerPhone = customer.phone;
                                        console.log('Added customer data for printing:', {
                                            customerPhone: invoiceToPrint.customerPhone,
                                            customerName: customer.name
                                        });
                                    }
                                }
                                
                                // Use the inventory system's print method which handles the data properly
                                window.inventorySystem?.printInvoice(invoiceToPrint.id || invoiceToPrint);
                                return;
                            }
                        }
                    }
                    // If we couldn't get invoice from modal, try to print the current invoice
                    window.print();
                } else if (printBtn.id === 'print-invoice' || printBtn.closest('#print-invoice')) {
                    // Handle print button in print preview
                    window.print();
                }
            });
        });
    </script>

    <!-- Data Management Script -->
    <script>
    /**
     * Invoice System - Core Data Management
     * Handles all data operations including storage, retrieval, and manipulation
     */

    // Main namespace for the Invoice System
    window.InvoiceSystem = window.InvoiceSystem || {};

    // Sample data templates
    const SAMPLE_DATA = {
        products: [],
        invoices: [],
        customers: [],
        suppliers: []
    };

    /**
     * Data Service - Handles all data operations
     */
    window.InvoiceSystem.DataService = (function() {
        // Private variables
        let products = [];
        let invoices = [];
        let customers = [];
        let suppliers = [];
        
        // Initialize data from localStorage or use sample data
        function init() {
            try {
                // Load products
                products = JSON.parse(localStorage.getItem('products')) || [];
                // Load invoices
                invoices = JSON.parse(localStorage.getItem('invoices')) || [];
                // Load customers
                customers = JSON.parse(localStorage.getItem('customers')) || [];
                // Load suppliers
                suppliers = JSON.parse(localStorage.getItem('suppliers')) || [];
                
                // If no data exists, initialize with empty arrays
                if (!localStorage.getItem('products')) {
                    saveAllData();
                }
                
                console.log('DataService initialized successfully');
                return true;
            } catch (error) {
                console.error('Error initializing DataService:', error);
                resetToSampleData();
                return false;
            }
        }
        
        // Save all data to localStorage
        function saveAllData() {
            try {
                localStorage.setItem('products', JSON.stringify(products));
                localStorage.setItem('invoices', JSON.stringify(invoices));
                localStorage.setItem('customers', JSON.stringify(customers));
                localStorage.setItem('suppliers', JSON.stringify(suppliers));
                return true;
            } catch (error) {
                console.error('Error saving data:', error);
                return false;
            }
        }
        
        // Reset all data to sample data
        function resetToSampleData() {
            products = [...SAMPLE_DATA.products];
            invoices = [...SAMPLE_DATA.invoices];
            customers = [...SAMPLE_DATA.customers];
            suppliers = [...SAMPLE_DATA.suppliers];
            saveAllData();
        }
        
        // Product operations
        function getProducts() {
            return [...products];
        }
        
        function addProduct(product) {
            if (!product || !product.id) return false;
            products.push(product);
            return saveAllData();
        }
        
        function getProductById(id) {
            return products.find(p => p.id === id) || { name: 'منتج غير معروف', balance: 0 };
        }
        
        // Invoice operations
        function getInvoices(limit = 10) {
            return [...invoices]
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, limit);
        }
        
        function addInvoice(invoice) {
            if (!invoice) return false;
            invoices.push(invoice);
            return saveAllData();
        }
        
        // Customer operations
        function getCustomers() {
            return [...customers];
        }
        
        function getCustomerById(id) {
            return customers.find(c => c.id === id);
        }
        
        function formatPurchaseHistory(customerId) {
            const customer = getCustomerById(customerId);
            if (!customer || !customer.purchases) return [];
            
            return customer.purchases.map(purchase => {
                const invoice = invoices.find(inv => inv.id === purchase.invoiceId);
                const items = invoice ? 
                    invoice.items.map(item => item.name).join('، ') :
                    (purchase.items ? purchase.items.map(item => item.name).join('، ') : '');
                    
                const total = invoice ? invoice.total : (purchase.total || 0);
                const status = invoice ? invoice.status : (purchase.status || 'unpaid');
                const remaining = invoice ? 
                    (invoice.remaining || (status === 'paid' ? 0 : total)) : 
                    (status === 'paid' ? 0 : total);
                
                return {
                    date: purchase.date || new Date().toISOString(),
                    invoiceId: purchase.invoiceId || '',
                    items: items,
                    total: parseFloat(total).toFixed(2),
                    status: status === 'paid' ? 'مدفوع' : 'غير مدفوع',
                    remaining: parseFloat(remaining).toFixed(2)
                };
            });
        }
        
        // Public API .
        return {
            init,
            resetToSampleData,
            
            // Products
            getProducts,
            addProduct,
            getProductById,
            
            // Invoices
            getInvoices,
            addInvoice,
            
            // Customers
            getCustomers,
            getCustomerById,
            formatPurchaseHistory
        };
    })();

    // Initialize the data service when the script loads
    document.addEventListener('DOMContentLoaded', function() {
        window.InvoiceSystem.DataService.init();
        
        // For backward compatibility (consider removing in future versions)
        window.products = window.InvoiceSystem.DataService.getProducts();
        window.invoices = window.InvoiceSystem.DataService.getInvoices();
        window.customers = window.InvoiceSystem.DataService.getCustomers();
        
        // Initialize recent invoices
        window.recentInvoices = window.InvoiceSystem.DataService.getInvoices(10);
    });

    // For backward compatibility
    getProductDetails = window.InvoiceSystem.DataService.getProductById;
    </script>
</body>
</html>